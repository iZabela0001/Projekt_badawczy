---
title: "Badanie przeżycia"
author: ""
date: "2025-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r install}
# if (!requireNamespace("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")

# BiocManager::install("TCGAbiolinks", version = "3.16", force = TRUE)

# install.packages("stringi", dependencies = TRUE)

# BiocManager::install("TCGAutils")
```

```{r library}
library(TCGAutils) 
library(TCGAbiolinks)
library(BiocManager)
library(dplyr)
library(data.table)
library(survival)
library(survminer)
library(ggplot2)
library(gridExtra)
library(grid)

```



```{r dane_subtypes, echo=FALSE}
subtypes <- TCGAquery_subtype("BRCA")
head(subtypes)
colnames(subtypes)

unique(subtypes$BRCA_Subtype_PAM50)
unique(subtypes$vital_status)
unique(subtypes$days_to_death)
unique(subtypes$days_to_last_followup)

# clinical2 <- GDCquery_clinic(project = "TCGA-BRCA", type = "clinical")
# head(clinical)


metadata <- GDCquery_clinic(project = "TCGA-BRCA", type = "biospecimen")
colnames(metadata)

```


```{r clinical_data}

clinical <- fread("clinical.tsv")

colnames(clinical)


clinical[clinical == "'--"] <- NA

clinical_clean <- clinical %>% 
  select_if(~ mean(is.na(.)) < 0.9)

colnames(clinical_clean)

######################################################################################################################################################
```





### Podział na podtypy danych subtypes

```{r}
# może się póxniej przyda 
lumA <- subtypes[subtypes$BRCA_Subtype_PAM50 == "LumA", ]

lumB <- subtypes[subtypes$BRCA_Subtype_PAM50 == "LumB", ]

Her2 <-subtypes[subtypes$BRCA_Subtype_PAM50 == "Her2", ]
  
Normal <- subtypes[subtypes$BRCA_Subtype_PAM50 == "Normal", ]
  
basal <- subtypes[subtypes$BRCA_Subtype_PAM50 == "Basal", ]
```


# Krzywe przeżycia

## cenzurowanie

```{r}

subtypes$time <- ifelse(is.na(subtypes$days_to_death),
                        subtypes$days_to_last_followup,
                        subtypes$days_to_death)

subtypes$event <- ifelse(subtypes$vital_status == "Dead", 1, 0)


# typy bez NA
subtypes <- subtypes[subtypes$BRCA_Subtype_PAM50 %in% c("LumA", "LumB", "Basal", "Her2", "Normal"), ]

```

1 = zdarzenie zaszło (zgon)

0 = cenzurowany przypadek (pacjent żyje, ale nie wiemy co będzie dalej)

## model

```{r}
subtypes$time <- as.numeric(subtypes$time)
subtypes$event <- as.numeric(subtypes$event)
#sum(is.na(subtypes$time))   

fit <- survfit(Surv(time, event) ~ BRCA_Subtype_PAM50, data = subtypes)

```


time – ile czasu obserwowano pacjenta (do zgonu lub ostatniego kontaktu),

event – czy pacjent zmarł (1), czy żyje (0).

BRCA_Subtype_PAM50 - porownanie przezywalnosci w różnych grupach pod względem wartości BRCA_Subtype_PAM50


```{r, fig.height= 10, fig.width= 15}
surv_plot <- ggsurvplot(
  fit,
  data = subtypes,
  pval = TRUE,
  risk.table = TRUE,
  title = "Krzywe przeżycia dla podtypów BRCA (PAM50)",
  xlab = "Czas (dni)",
  ylab = "Prawdopodobieństwo przeżycia",
  legend.title = "Podtyp PAM50",
  font.main = c(20, "bold"),
  font.x = c(20),
  font.y = c(20),
  font.tickslab = c(20),
  font.legend = c(15),
  font.caption = c(20),
  palette = c("#edeba0", "lightblue", "thistle", "#dba09f", "lightgreen"), 

  ggtheme = theme_survminer() + 
    theme(
      plot.background = element_rect(fill = "#fffcf7"),
      panel.background = element_rect(fill = "#fffcf7")
    ),
  tables.theme = theme_survminer() + 
    theme(
      plot.background = element_rect(fill = "#fffcf7"),
      panel.background = element_rect(fill = "#fffcf7")
    )
)

png("krzywe_przezycia_z_tabela.png", width = 3000, height = 2000, res = 150)
# 
print(surv_plot)
# 
dev.off()

# https://www.sthda.com/english/wiki/survival-analysis-basics

#testy

```

```{r}
merged_data_cleaned <- read.csv("merged_data_cleaned.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)

 
# Sprawdzenie rozkładu danych czasowych
hist(merged_data_cleaned$days_to_death, main = "Dni do zgonu", col = "red")
hist(merged_data_cleaned$days_to_last_followup, main = "Dni do ostatniego kontaktu", col = "blue")
 
# Sprawdzenie braków danych
#sum(is.na(merged_data_cleaned$days_to_death))
#sum(is.na(merged_data_cleaned$days_to_last_followup))

# Ujednolicenie zapisu statusu życia
merged_data_cleaned$vital_status <- toupper(merged_data_cleaned$vital_status)
 
# Utworzenie zmiennej event: 1 = DEAD, 0 = ALIVE
merged_data_cleaned$event <- ifelse(merged_data_cleaned$vital_status == "DEAD", 1, 0)

# Utworzenie zmiennej time_to_event
merged_data_cleaned$time_to_event <- ifelse(merged_data_cleaned$event == 1, 
                                            merged_data_cleaned$days_to_death, 
                                            merged_data_cleaned$days_to_last_followup)

# Dodatkowe zabezpieczenie przed brakami danych
merged_data_cleaned$time_to_event <- ifelse(!is.na(merged_data_cleaned$days_to_death),
                                            merged_data_cleaned$days_to_death,
                                            merged_data_cleaned$days_to_last_followup)

# Sprawdzenie wyników
# table(merged_data_cleaned$vital_status, merged_data_cleaned$event)  # DEAD → 1, ALIVE → 0
# head(merged_data_cleaned)
```


```{r}

merged_data_cleaned <- read.csv("merged_data_cleaned.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)

 
# Sprawdzenie rozkładu danych czasowych
hist(merged_data_cleaned$days_to_death, main = "Dni do zgonu", col = "red")
hist(merged_data_cleaned$days_to_last_followup, main = "Dni do ostatniego kontaktu", col = "blue")
 
# Sprawdzenie braków danych
#sum(is.na(merged_data_cleaned$days_to_death))
#sum(is.na(merged_data_cleaned$days_to_last_followup))

# Ujednolicenie zapisu statusu życia
merged_data_cleaned$vital_status <- toupper(merged_data_cleaned$vital_status)
 
# Utworzenie zmiennej event: 1 = DEAD, 0 = ALIVE
merged_data_cleaned$event <- ifelse(merged_data_cleaned$vital_status == "DEAD", 1, 0)

# Utworzenie zmiennej time_to_event
merged_data_cleaned$time_to_event <- ifelse(merged_data_cleaned$event == 1, 
                                            merged_data_cleaned$days_to_death, 
                                            merged_data_cleaned$days_to_last_followup)

# Sprawdzenie wyników
# table(merged_data_cleaned$vital_status, merged_data_cleaned$event)  # DEAD → 1, ALIVE → 0
# head(merged_data_cleaned)

```


 Zmienna `pathologic_stage` opisująca stadium zaawansowania nowotworu została 
 przekształcona na wartości:
 - Stage I → I
 - Stage II → II
 - Stage III → III
Wartości nieznane (np. "Unknown") zostały usunięte ze zbioru, ponieważ stanowiły 
niewielki odsetek (11 przypadków) i nie wpływają istotnie na dalszą analizę.


Kolumna `gender` została usunięta ze względu na brak zmienności — wszystkie przypadki 
w zbiorze dotyczą kobiet, więc zmienna nie wnosi informacji analitycznej. 
Analogicznie postąpiono z `tumor_type` - tylko jeden typ nowotworu jest przedmiotem 
analizy w projekcie.

Ujednolicono nazewnictwo ras poprzez przypisanie spójnych etykiet typu `factor`.
Dzięki temu możliwe jest łatwe grupowanie i porównywanie danych w dalszej analizie.

``` {r standaryzacja_pozostałych_danych_1}

#pathologic_stage 
#Zamieniamy tutaj stadia zaawansowania nowotworu na dane liczbowe, dane Unknown, 
#co do których nie mamy danych - usuwamy. Z racji tego, że jest ich tylko 11, nie 
#jest to "zagrożeniem" dla dalszych etapów analizy.

table(merged_data_cleaned$pathologic_stage, useNA = "always")

merged_data_cleaned$pathologic_stage <- ifelse(merged_data_cleaned$pathologic_stage == "Stage_I", "I",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_II", "II",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_III", "III",
                                         NA)))
merged_data_cleaned <- merged_data_cleaned[!is.na(merged_data_cleaned$pathologic_stage), ]
#table(merged_data_cleaned$pathologic_stage)

#demographic_gender 
#Kolumna gender została usunięta ze względu na brak zmienności — wszystkie 
#przypadki w zbiorze dotyczą kobiet
table(merged_data_cleaned$demographic_gender, useNA = "always")
merged_data_cleaned$demographic_gender <- NULL
merged_data_cleaned$tumor_type <- NULL

#demographic_race
#Ujednolicenie nazewnictwa 
merged_data_cleaned$demographic_race <- factor(
  merged_data_cleaned$demographic_race,
  levels = c(
    "white",
    "black or african american",
    "asian",
    "american indian or alaska native",
    "not reported"
  ),
  labels = c(
    "White",
    "Black",
    "Asian",
    "Native",
    "Unknown"
  )
)

```

W ramach przygotowania danych do analizy, przeprowadzono standaryzację zmiennej 
`demographic_ethnicity`, która opisuje przynależność etniczną pacjentek.
Występowały w niej wartości brakujące (`NA`) oraz niejednolite zapisy, takie jak 
`"not reported"`, które mogły utrudniać dalszą analizę.

Wszystkie wartości `NA` oraz `"not reported"` zostały zastąpione wartością 
`"Unknown"`, co pozwala zachować informację o braku danych bez ich całkowitego usuwania.

Następnie zmienna została przekształcona do typu `factor` z trzema spójnymi etykietami:
   - `"Non-Hispanic"` – osoby niebędące Latynoskiego pochodzenia
   - `"Hispanic"` – osoby Latynoskiego pochodzenia
   - `"Unknown"` – brak informacji

Dodatkowo usunięto kolumny `demographic_days_to_death` oraz `cases_days_to_lost_to_followup`,
które zawierały nadmiarowe lub nieprzydatne informacje czasowe.


```{r transformacje_cdn}

#demographic_ethnicity
merged_data_cleaned$demographic_ethnicity[is.na(merged_data_cleaned$demographic_ethnicity)] <- "Unknown"

merged_data_cleaned$demographic_ethnicity[
  merged_data_cleaned$demographic_ethnicity == "not reported"
] <- "Unknown"

merged_data_cleaned$demographic_ethnicity <- factor(
  merged_data_cleaned$demographic_ethnicity,
  levels = c(
    "not hispanic or latino",
    "hispanic or latino",
    "Unknown"
  ),
  labels = c(
    "Non-Hispanic",
    "Hispanic",
    "Unknown"
  )
)

#demographic_days_to_death & cases_days_to_lost_to_followup <- NA

merged_data_cleaned <- merged_data_cleaned %>%
  select(-demographic_days_to_death, -cases_days_to_lost_to_followup)


#treatments_treatment_outcome 
# Znak braku wystarczających danych został zastąpiony wyrażeniem "Unknown"
#w celu ujednolicenia i ułatwienia analizy. 

merged_data_cleaned$treatments_treatment_outcome[
  merged_data_cleaned$treatments_treatment_outcome %in% c("'--", "Not Reported")
] <- "Unknown"

```

### Standaryzacja wieku pacjentek

W celu ujednolicenia zmiennej wieku pacjentek, obliczono wartość `age_mean_years` 
jako średnią z dostępnych źródeł wieku (wiek w dniach, wiek przy diagnozie, wiek indeksowy).
Następnie zastosowano standaryzację Z-score (`age_z`), co pozwala na porównywanie 
pacjentek względem średniego wieku w populacji:

- `age_z = 0` → pacjentka o przeciętnym wieku
- `age_z > 0` → starsza niż średnia
- `age_z < 0` → młodsza niż średnia

Dzięki temu zmienna wiekowa może być użyta w modelach statystycznych jako zmienna 
ilościowa, bez ryzyka błędnej interpretacji skali.


```{r age_at_diagnosis_years} 

merged_data_cleaned$age_from_days <- round(merged_data_cleaned$diagnoses_age_at_diagnosis / 365, 1)

merged_data_cleaned$age_mean_years <- rowMeans(
  merged_data_cleaned[, c("age_from_days", "age_at_initial_pathologic_diagnosis", "demographic_age_at_index")],
  na.rm = TRUE
)

merged_data_cleaned$age_z <- as.numeric(scale(merged_data_cleaned$age_mean_years))


hist(merged_data_cleaned$age_mean_years, col = "lightblue", main = "Średni wiek w latach", xlab = "Lata")

merged_data_cleaned <- merged_data_cleaned %>%
  select(-age_from_days, -age_at_initial_pathologic_diagnosis, -demographic_age_at_index)


ggplot(merged_data_cleaned, aes(x = age_mean_years)) +
  geom_density(fill = "plum", alpha = 0.5) +
  labs(title = "Rozkład wieku", x = "Wiek", y = "Gęstość")

qqnorm(merged_data_cleaned$age_mean_years); qqline(merged_data_cleaned$age_mean_years)


```
### Transformacja i standaryzacja czasu do zdarzenia

Zmienna `time_to_event` opisuje liczbę dni od diagnozy do zgonu lub ostatniego kontaktu.
Histogram przed transformacją pokazuje silną skośność rozkładu — większość zdarzeń występuje 
w pierwszych 2000 dniach.

Aby zredukować skośność, zastosowano transformację logarytmiczną (`log1p()`),
a następnie standaryzację Z-score (`time_to_event_log_z`). Dzięki temu:

- Zmniejszono wpływ wartości odstających
- Ułatwiono pracę modelom statystycznym
- Poprawiono symetrię rozkładu

Dodatkowo wykonano histogramy i wykresy gęstości, które potwierdziły poprawę 
rozkładu po transformacji.

```{r time_to_event}

merged_data_cleaned$time_to_event_z <- as.numeric(scale(merged_data_cleaned$time_to_event))
hist(merged_data_cleaned$time_to_event, col = "lightgreen", main = "Rozkład time_to_event przed transformacją", xlab = "Dni")

merged_data_cleaned$time_to_event_log <- log1p(merged_data_cleaned$time_to_event)

hist(merged_data_cleaned$time_to_event_log, col = "orange", main = "Logarytmiczny rozkład time_to_event po transformacji", xlab = "log(Dni + 1)")
merged_data_cleaned$time_to_event_log_z <- as.numeric(scale(merged_data_cleaned$time_to_event_log))

merged_data_cleaned <- merged_data_cleaned %>%
  select(-time_to_event_log)


```
Rozkład stadiów zaawansowania choroby

Wykres słupkowy przedstawia liczbę przypadków w poszczególnych stadiach choroby (1–3). 
Stadium 4 oraz wartości nieznane zostały usunięte ze względu na ich marginalną liczbę.
Rozkład pokazuje, że większość pacjentek znajduje się w stadium II, co może mieć 
wpływ na dalszą analizę przeżycia i modelowanie ryzyka.

```{r}

ggplot(merged_data_cleaned, aes(x = factor(pathologic_stage))) +
  geom_bar(fill = "#dba09f") +
  labs(title = "Rozkład stadiów zaawansowania choroby", x = "Stadium", y = "Liczba przypadków") +
  theme_minimal()

```

Rozkład demograficzny pacjentek

Wykresy słupkowe przedstawiają strukturę rasową i etniczną pacjentek. 
Dominującą grupą są osoby rasy białej oraz niebędące Latynoskiego pochodzenia.
Wartości brakujące zostały zakodowane jako `"Unknown"`, co pozwala zachować 
informację o niepełnych danych bez ich usuwania. Taka struktura demograficzna 
może mieć znaczenie w analizie przeżycia i interpretacji wyników.


```{r}

ggplot(merged_data_cleaned, aes(x = demographic_race)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Rozkład ras pacjentek", x = "Rasa", y = "Liczba przypadków") +
  theme_minimal()

ggplot(merged_data_cleaned, aes(x = demographic_ethnicity)) +
  geom_bar(fill = "plum") +
  labs(title = "Rozkład etniczności pacjentek", x = "Etniczność", y = "Liczba przypadków") +
  theme_minimal()

```





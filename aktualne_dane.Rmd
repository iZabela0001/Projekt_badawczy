---
title: "Różnice w przeżyciu pacjentek z rakiem piersi w zależności od podtypu nowotworu"
authors: "Izabela Reszka, Piotr Wiśniewski, Klaudia Woźniak"
output: html_document

---

```{r instalowanie_bibliotek}
# install.packages("tidyverse")
# install.packages("skimr")
# install.packages("caret")
# install.packages("ggplot2")
# install.packages("patchwork")
# install.packages ("e1071")
# install.packages("caret")
#install.packages("pheatmap")
#install.packages("RColorBrewer")
```


```{r ladowanie_bibliotek}
library(caret)
library(tidyverse)
library(skimr)
library(caret)
library(ggplot2)
library(patchwork)
library(e1071)
library(pheatmap)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
```




**DATA WRANGLING**

```{r}

df <- read_tsv("merged_data.tsv")

print(df)

# Wymiary zbioru
cat("Wymiary zbioru (wiersze, kolumny):", dim(df), "\n")

# Podgląd danych
glimpse(df)

# Profilowanie za pomocą 'skimr'
skim(df)

# Usuwanie duplikaów
cat("Liczba wierszy PRZED deduplikacją:", nrow(df), "\n")
df_clean <- df %>%
  distinct(ID.1, .keep_all = TRUE)
cat("Liczba wierszy PO deduplikacji:", nrow(df_clean), "\n")

# Usunięcie zbędnych kolumn (duplikaty ID oraz 100% puste)
df_clean <- df_clean %>%
  select(                          # Duplikat ID
    -cases.submitter_id,             # Duplikat ID
    -patient,                        # Duplikat ID
    -cases.case_id,                  # Inny, zbędny identyfikator
    -Tumor_Grade,                    # 100% pusty
    -tobacco_smoking_history         # 100% pusty
  )

# Czyszczenie "brudnych" kolumn (konwersja '--' na NA) ---
# Identyfikujemy kolumny, które są 'character', ale powinny być 'numeric'
# (te, które zawierają '--' zamiast NA)
cols_to_clean_numeric <- c(
  "demographic.days_to_death",
  "cases.days_to_lost_to_followup",
  "diagnoses.age_at_diagnosis",
  "diagnoses.year_of_diagnosis"
)

df_clean <- df_clean %>%
  # Krok 1: Zamień tekst "'--'" na prawdziwe 'NA'
  mutate(across(all_of(cols_to_clean_numeric), ~ na_if(., "'--'"))) %>%
  # Krok 2: Konwertuj te kolumny na typ numeryczny
  mutate(across(all_of(cols_to_clean_numeric), as.numeric))


# Obsługa braków danych (NA) w kolumnach kategorycznych ---
# Po deduplikacji 'BRCA_Pathology' i 'pathologic_stage' nadal będą miały braki (NA).
# Zamiast usuwać wiersze, lepiej zamienić NA na nową kategorię "Unknown".
# Używamy forcats::fct_explicit_na()
df_clean <- df_clean %>%
  mutate(
    pathologic_stage = fct_explicit_na(pathologic_stage, na_level = "Unknown"),
    BRCA_Pathology = fct_explicit_na(BRCA_Pathology, na_level = "Unknown")
  )

# Sprawdzenie danych
cat("--- Wynik po czyszczeniu (glimpse) ---\n")
glimpse(df_clean)

cat("\n--- Wynik po czyszczeniu (skim) ---\n")
skim(df_clean)


# Lista kolumn diagnostycznych do czyszczenia
cols_to_factor <- c(
  "diagnoses.ajcc_pathologic_stage",
  "diagnoses.ajcc_pathologic_t",
  "diagnoses.ajcc_pathologic_n",
  "diagnoses.ajcc_pathologic_m",
  "treatments.treatment_outcome"
)

# Czyścimy '--' na NA i konwertujemy na faktor
df_clean <- df_clean %>%
  mutate(across(all_of(cols_to_factor), ~ na_if(., "'--'"))) %>%
  mutate(across(all_of(cols_to_factor), as.factor))

cat("--- Glimpse po doczyszczeniu metadanych ---\n")
glimpse(df_clean)



# Wybieramy tylko kolumny z danymi numerycznymi (od ERALPHA do CD24)
df_features <- df_clean %>%
  select(ERALPHA:CD24) # Używamy nazw do zaznaczenia zakresu

nzv_metrics <- nearZeroVar(df_features, saveMetrics = TRUE)

# Sprawdzamy, czy któreś kolumny zostały oflagowane jako NZV
problematic_cols <- filter(nzv_metrics, nzv == TRUE)

if(nrow(problematic_cols) > 0) {
  cat("Znaleziono kolumny o niskiej wariancji (NZV):\n")
  print(rownames(problematic_cols))
  
  # Usuwamy te kolumny
  cols_to_remove <- rownames(problematic_cols)
  df_clean <- df_clean %>%
    select(-all_of(cols_to_remove))
  
  cat("\nUsunięto kolumny NZV. Nowa liczba kolumn:", ncol(df_clean), "\n")
  
} else {
  cat("Gratulacje! Brak kolumn o niskiej wariancji (NZV).\n")
}

library(janitor)


df_final <- df_clean %>%
  clean_names()


cat("--- Podgląd oczyszczonych nazw kolumn ---\n")
glimpse(df_final)

library(readr) 

write_csv(df_final, "merged_data_cleaned.csv")


```


```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```



**STANDARYZACJA DANYCH** 

```{r}

merged_data_cleaned <- read.csv("merged_data_cleaned.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)

 
# Sprawdzenie rozkładu danych czasowych
hist(merged_data_cleaned$days_to_death, main = "Dni do zgonu", col = "red")
hist(merged_data_cleaned$days_to_last_followup, main = "Dni do ostatniego kontaktu", col = "blue")
 
# Sprawdzenie braków danych
#sum(is.na(merged_data_cleaned$days_to_death))
#sum(is.na(merged_data_cleaned$days_to_last_followup))

# Ujednolicenie zapisu statusu życia
merged_data_cleaned$vital_status <- toupper(merged_data_cleaned$vital_status)
 
# Utworzenie zmiennej event: 1 = DEAD, 0 = ALIVE
merged_data_cleaned$event <- ifelse(merged_data_cleaned$vital_status == "DEAD", 1, 0)

# Utworzenie zmiennej time_to_event
merged_data_cleaned$time_to_event <- ifelse(merged_data_cleaned$event == 1, 
                                            merged_data_cleaned$days_to_death, 
                                            merged_data_cleaned$days_to_last_followup)

# Sprawdzenie wyników
# table(merged_data_cleaned$vital_status, merged_data_cleaned$event)  # DEAD → 1, ALIVE → 0
# head(merged_data_cleaned)

```

**Standaryzacja białek** 


```{r}

bialka <- c("eralpha", "pr", "her2", "egfr_mirnaprot", "p53", "pten_mirnaprot",
            "mek1", "bcl2_mirnaprot", "bax", "parpcleaved", "ecadherin",
            "ncadherin", "betacatenin", "brca1", "pdl1")

merged_data_cleaned[bialka] <- lapply(merged_data_cleaned[bialka], as.numeric)

bialka_z <- paste0(bialka, "_z")
merged_data_cleaned[bialka_z] <- scale(merged_data_cleaned[bialka])

```


### Rozkłady standaryzowanych poziomów białek

Wykresy gęstości przedstawiają rozkład standaryzowanych poziomów ekspresji
wybranych białek wśród pacjentek. Każda zmienna została przekształcona do skali 
Z-score, co oznacza, że wartości mają średnią bliską 0 
i odchylenie standardowe bliskie 1. Taka transformacja umożliwia bezpośrednie
porównywanie zmiennych o różnych jednostkach i zakresach.

Większość rozkładów jest względnie symetryczna, co sugeruje brak silnych 
odchyleń od normalności. W niektórych przypadkach widoczne są lekkie skośności
lub spłaszczenia, które mogą wynikać z biologicznego zróżnicowania w populacji
lub obecności podgrup pacjentek. Brak wyraźnych wartości odstających świadczy 
o dobrej jakości danych.

Ze względu na obecność wartości ujemnych oraz względnie symetryczne rozkłady 
większości zmiennych, nie zastosowano dodatkowej transformacji logarytmicznej.
Logarytmizacja wymaga dodatnich wartości i mogłaby prowadzić 
do błędów obliczeniowych (NaN) w przypadku danych z wartościami poniżej zera.


```{r}

plot_density_chunks <- function(vars, data, fill_color = "lightblue", ncol = 2, chunk_size = 6) {
  chunks <- split(vars, ceiling(seq_along(vars) / chunk_size))
  
  for (chunk in chunks) {
    plots <- lapply(chunk, function(var) {
      df <- data[!is.na(data[[var]]), ]
      
      ggplot(df, aes_string(x = var)) +
        geom_density(fill = fill_color, alpha = 0.6) +
        labs(title = var, x = "Z-score", y = "Gęstość") +
        theme_minimal(base_size = 12)
    })
    
    print(wrap_plots(plots, ncol = ncol))
  }
}

plot_density_chunks(bialka_z, merged_data_cleaned, fill_color = "lightblue", ncol = 2)


```


**Standaryzacja miRNA** 


```{r}
mirna <- c(
  'hsa_mir_17',
  'hsa_mir_206',
  'hsa_mir_210',
  'hsa_mir_100',
  'hsa_mir_130a',
  'hsa_mir_27b',
  'hsa_let_7f_1',
  'hsa_let_7f_2',
  'hsa_mir_20a',
  'hsa_mir_34a',
  'hsa_mir_25',
  'hsa_mir_21',
  'hsa_mir_23b',
  'hsa_mir_29a',
  'hsa_mir_181d',
  'hsa_mir_203a',
  'hsa_mir_181c',
  'hsa_mir_155',
  'hsa_mir_205',
  'hsa_mir_10a',
  'hsa_let_7b',
  'hsa_mir_15a',
  'hsa_mir_134',
  'hsa_mir_200c'
)


merged_data_cleaned[mirna] <- lapply(merged_data_cleaned[mirna], as.numeric)

mirna_z <- paste0(mirna, "_z")
merged_data_cleaned[mirna_z] <- scale(merged_data_cleaned[mirna])


```

### Rozkłady standaryzowanych poziomów miRNA

Wykresy gęstości przedstawiają rozkład standaryzowanych poziomów ekspresji 
wybranych cząsteczek miRNA. Standaryzacja do skali Z-score
pozwala na porównywanie miRNA między sobą oraz z innymi typami danych biologicznych,
niezależnie od pierwotnej skali pomiarowej.

Rozkłady miRNA są bardziej zróżnicowane niż w przypadku białek — część z nich 
wykazuje wyraźną skośność, wielomodalność lub obecność wartości odstających.
Może to wskazywać na różnice biologiczne między pacjentkami 
lub specyficzne wzorce regulacji genów.

Ze względu na obecność wartości ujemnych oraz względnie symetryczne rozkłady 
większości zmiennych, nie zastosowano dodatkowej transformacji logarytmicznej.
Logarytmizacja wymaga dodatnich wartości i mogłaby prowadzić 
do błędów obliczeniowych (NaN) w przypadku danych z wartościami poniżej zera.


```{r}

plot_mirna_density <- function(vars, data, ncol = 2) {
  plots <- lapply(vars, function(var) {
    df <- data[!is.na(data[[var]]), ]
    
    ggplot(df, aes_string(x = var)) +
      geom_density(fill = "plum", alpha = 0.6) +
      labs(title = var, x = "Z-score", y = "Gęstość") +
      theme_minimal(base_size = 12)
  })
  
  wrap_plots(plots, ncol = ncol)
}

mirna_z_chunks <- split(mirna_z, ceiling(seq_along(mirna_z) / 6))
for (chunk in mirna_z_chunks) {
  print(plot_mirna_density(chunk, merged_data_cleaned, ncol = 2))
}

```


 Zmienna `pathologic_stage` opisująca stadium zaawansowania nowotworu została 
 przekształcona na wartości:
 - Stage I → I
 - Stage II → II
 - Stage III → III
Wartości nieznane (np. "Unknown") zostały usunięte ze zbioru, ponieważ stanowiły 
niewielki odsetek (11 przypadków) i nie wpływają istotnie na dalszą analizę.


Kolumna `gender` została usunięta ze względu na brak zmienności — wszystkie przypadki 
w zbiorze dotyczą kobiet, więc zmienna nie wnosi informacji analitycznej. 
Analogicznie postąpiono z `tumor_type` - tylko jeden typ nowotworu jest przedmiotem 
analizy w projekcie.

Ujednolicono nazewnictwo ras poprzez przypisanie spójnych etykiet typu `factor`.
Dzięki temu możliwe jest łatwe grupowanie i porównywanie danych w dalszej analizie.

``` {r standaryzacja_pozostałych_danych_1}

#pathologic_stage 
#Zamieniamy tutaj stadia zaawansowania nowotworu na dane liczbowe, dane Unknown, 
#co do których nie mamy danych - usuwamy. Z racji tego, że jest ich tylko 11, nie 
#jest to "zagrożeniem" dla dalszych etapów analizy.

table(merged_data_cleaned$pathologic_stage, useNA = "always")

merged_data_cleaned$pathologic_stage <- ifelse(merged_data_cleaned$pathologic_stage == "Stage_I", "I",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_II", "II",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_III", "III",
                                         NA)))
merged_data_cleaned <- merged_data_cleaned[!is.na(merged_data_cleaned$pathologic_stage), ]
#table(merged_data_cleaned$pathologic_stage)

#demographic_gender 
#Kolumna gender została usunięta ze względu na brak zmienności — wszystkie 
#przypadki w zbiorze dotyczą kobiet
table(merged_data_cleaned$demographic_gender, useNA = "always")
merged_data_cleaned$demographic_gender <- NULL
merged_data_cleaned$tumor_type <- NULL

#demographic_race
#Ujednolicenie nazewnictwa 
merged_data_cleaned$demographic_race <- factor(
  merged_data_cleaned$demographic_race,
  levels = c(
    "white",
    "black or african american",
    "asian",
    "american indian or alaska native",
    "not reported"
  ),
  labels = c(
    "White",
    "Black",
    "Asian",
    "Native",
    "Unknown"
  )
)

```

W ramach przygotowania danych do analizy, przeprowadzono standaryzację zmiennej 
`demographic_ethnicity`, która opisuje przynależność etniczną pacjentek.
Występowały w niej wartości brakujące (`NA`) oraz niejednolite zapisy, takie jak 
`"not reported"`, które mogły utrudniać dalszą analizę.

Wszystkie wartości `NA` oraz `"not reported"` zostały zastąpione wartością 
`"Unknown"`, co pozwala zachować informację o braku danych bez ich całkowitego usuwania.

Następnie zmienna została przekształcona do typu `factor` z trzema spójnymi etykietami:
   - `"Non-Hispanic"` – osoby niebędące Latynoskiego pochodzenia
   - `"Hispanic"` – osoby Latynoskiego pochodzenia
   - `"Unknown"` – brak informacji

Dodatkowo usunięto kolumny `demographic_days_to_death` oraz `cases_days_to_lost_to_followup`,
które zawierały nadmiarowe lub nieprzydatne informacje czasowe.


```{r transformacje_cdn}

#demographic_ethnicity
merged_data_cleaned$demographic_ethnicity[is.na(merged_data_cleaned$demographic_ethnicity)] <- "Unknown"

merged_data_cleaned$demographic_ethnicity[
  merged_data_cleaned$demographic_ethnicity == "not reported"
] <- "Unknown"

merged_data_cleaned$demographic_ethnicity <- factor(
  merged_data_cleaned$demographic_ethnicity,
  levels = c(
    "not hispanic or latino",
    "hispanic or latino",
    "Unknown"
  ),
  labels = c(
    "Non-Hispanic",
    "Hispanic",
    "Unknown"
  )
)

#demographic_days_to_death & cases_days_to_lost_to_followup <- NA

merged_data_cleaned <- merged_data_cleaned %>%
  select(-demographic_days_to_death, -cases_days_to_lost_to_followup)


#treatments_treatment_outcome 
# Znak braku wystarczających danych został zastąpiony wyrażeniem "Unknown"
#w celu ujednolicenia i ułatwienia analizy. 

merged_data_cleaned$treatments_treatment_outcome[
  merged_data_cleaned$treatments_treatment_outcome %in% c("'--", "Not Reported")
] <- "Unknown"

```

W ramach czyszczenia danych uporządkowano wartości w kilku kluczowych kolumnach:

 - `diagnoses_year_of_diagnosis`, 
 - `diagnoses_laterality`, 
 - `diagnoses_ajcc_pathologic_stage`, 
 - `diagnoses_ajcc_pathologic_t`,
 - `diagnoses_ajcc_pathologic_n`, 
 - `diagnoses_ajcc_pathologic_m`, 
 - `treatments_treatment_type`, 
 - `treatments_treatment_outcome`
 - `diagnoses_primary_diagnosis`. 
 
Wszelkie nieczytelne wpisy typu "--", "'--" czy "Not Reported" 
oraz braki danych (NA) zostały zastąpione jednolitą wartością "Unknown", 
co pozwala na spójne traktowanie braków w dalszej analizie. 
Dodatkowo w `diagnoses_ajcc_pathologic_stage` usunięto słowo "Stage" 
dzięki czemu wartości są bardziej czytelne.

```{r}

# Wszystkie pozostałe kolumny do czyszczenia
cols_to_clean <- c(
  "diagnoses_year_of_diagnosis",
  "diagnoses_laterality",
  "diagnoses_ajcc_pathologic_stage",
  "diagnoses_ajcc_pathologic_t",
  "diagnoses_ajcc_pathologic_n",
  "diagnoses_ajcc_pathologic_m",
  "treatments_treatment_type",
  "treatments_treatment_outcome",
  "diagnoses_primary_diagnosis"
)

# Czyszczenie i standaryzacja danych
for (col in cols_to_clean) {
  merged_data_cleaned[[col]] <- as.character(merged_data_cleaned[[col]])
  merged_data_cleaned[[col]] <- trimws(merged_data_cleaned[[col]])
  merged_data_cleaned[[col]][merged_data_cleaned[[col]] %in% c("--", "'--")] <- "Unknown"
  merged_data_cleaned[[col]][is.na(merged_data_cleaned[[col]])] <- "Unknown"
  merged_data_cleaned[[col]][merged_data_cleaned[[col]] %in% c("--", "'--", "Not Reported")] <- "Unknown"
  merged_data_cleaned$diagnoses_ajcc_pathologic_stage <- gsub("^Stage ", "", merged_data_cleaned$diagnoses_ajcc_pathologic_stage)
}
 

```

### Standaryzacja wieku pacjentek

W celu ujednolicenia zmiennej wieku pacjentek, obliczono wartość `age_mean_years` 
jako średnią z dostępnych źródeł wieku (wiek w dniach, wiek przy diagnozie, wiek indeksowy).
Następnie zastosowano standaryzację Z-score (`age_z`), co pozwala na porównywanie 
pacjentek względem średniego wieku w populacji:

- `age_z = 0` → pacjentka o przeciętnym wieku
- `age_z > 0` → starsza niż średnia
- `age_z < 0` → młodsza niż średnia

Dzięki temu zmienna wiekowa może być użyta w modelach statystycznych jako zmienna 
ilościowa, bez ryzyka błędnej interpretacji skali.


```{r age_at_diagnosis_years} 

merged_data_cleaned$age_from_days <- round(merged_data_cleaned$diagnoses_age_at_diagnosis / 365, 1)

merged_data_cleaned$age_mean_years <- rowMeans(
  merged_data_cleaned[, c("age_from_days", "age_at_initial_pathologic_diagnosis", "demographic_age_at_index")],
  na.rm = TRUE
)

merged_data_cleaned$age_z <- as.numeric(scale(merged_data_cleaned$age_mean_years))


hist(merged_data_cleaned$age_mean_years, col = "lightblue", main = "Średni wiek w latach", xlab = "Lata")

merged_data_cleaned <- merged_data_cleaned %>%
  select(-age_from_days, -age_at_initial_pathologic_diagnosis, -demographic_age_at_index)


ggplot(merged_data_cleaned, aes(x = age_mean_years)) +
  geom_density(fill = "plum", alpha = 0.5) +
  labs(title = "Rozkład wieku", x = "Wiek", y = "Gęstość")

qqnorm(merged_data_cleaned$age_mean_years); qqline(merged_data_cleaned$age_mean_years)


```

*Rozkład stadiów zaawansowania choroby*

Wykres słupkowy przedstawia liczbę przypadków w poszczególnych stadiach choroby (1–3). 
Stadium 4 oraz wartości nieznane zostały usunięte ze względu na ich marginalną liczbę.
Rozkład pokazuje, że większość pacjentek znajduje się w stadium II, co może mieć 
wpływ na dalszą analizę przeżycia i modelowanie ryzyka.

```{r}

ggplot(merged_data_cleaned, aes(x = factor(pathologic_stage))) +
  geom_bar(fill = "#dba09f") +
  labs(title = "Rozkład stadiów zaawansowania choroby", x = "Stadium", y = "Liczba przypadków") +
  theme_minimal()

```

*Rozkład demograficzny pacjentek* 

Wykresy słupkowe przedstawiają strukturę rasową i etniczną pacjentek. 
Dominującą grupą są osoby rasy białej oraz niebędące Latynoskiego pochodzenia.
Wartości brakujące zostały zakodowane jako `"Unknown"`, co pozwala zachować 
informację o niepełnych danych bez ich usuwania. Taka struktura demograficzna 
może mieć znaczenie w analizie przeżycia i interpretacji wyników.


```{r}

ggplot(merged_data_cleaned, aes(x = demographic_race)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Rozkład ras pacjentek", x = "Rasa", y = "Liczba przypadków") +
  theme_minimal()

ggplot(merged_data_cleaned, aes(x = demographic_ethnicity)) +
  geom_bar(fill = "plum") +
  labs(title = "Rozkład etniczności pacjentek", x = "Etniczność", y = "Liczba przypadków") +
  theme_minimal()

write_csv(merged_data_cleaned, "actual_merged_data.csv")
```





```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```


```{r}
final_data <- read.csv("actual_merged_data.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)
```


```{r kolumny_etap2, echo=FALSE, eval=TRUE, results='asis'}
pam50_col <- "brca_subtype_pam50"
patient_id_col <- "id_1"
```

```{r}
print(
  table(final_data[[pam50_col]], useNA = "always")
)
```

```{r}
final_data <- final_data %>%
  filter(.data[[pam50_col]] != "Normal")

final_data[[pam50_col]] <- factor(final_data[[pam50_col]])
```



```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```




# Etap2 mi-RNA



```{r markerymiRNA_etap2}
mirna_markers <- c(
  'hsa_mir_17_z',
  'hsa_mir_206_z',
  'hsa_mir_210_z',
  'hsa_mir_100_z',
  'hsa_mir_130a_z',
  'hsa_mir_27b_z',
  'hsa_let_7f_1_z',
  'hsa_let_7f_2_z',
  'hsa_mir_20a_z',
  'hsa_mir_34a_z',
  'hsa_mir_25_z',
  'hsa_mir_21_z',
  'hsa_mir_23b_z',
  'hsa_mir_29a_z',
  'hsa_mir_181d_z',
  'hsa_mir_203a_z',
  'hsa_mir_181c_z',
  'hsa_mir_155_z',
  'hsa_mir_205_z',
  'hsa_mir_10a_z',
  'hsa_let_7b_z',
  'hsa_mir_15a_z',
  'hsa_mir_134_z',
  'hsa_mir_200c_z'
)














# SPRAWDZCIE AJPIERW CZY NA PEWNO WASZE WSZYSTKIE ZMIENNE SĄ W RAMCE DANYCH FINAL DATA (NIZEJ KOD)











# mirna_markers_exist <- mirna[mirna %in% colnames(final_data)]
# if (length(mirna_markers_exist) == 0) {
#   stop("BŁĄD: Nnie znaleziono żadnych kolumn  miRNA w pliku")
# }
# cat("są", length(mirna_markers_exist), "z", length(mirna), "oczekiwanych markerów miRNA.\n\n")
```


Macierz do heatmapy (miRNA x pacjentci)


```{r macierzmiRNA_etap2}
matric_mirna_only <- final_data[, mirna_markers]
```


```{r nazwypacjentow_etap2}
rownames(matric_mirna_only) <- final_data[[patient_id_col]]
```

```{r transpozycjaaa_etap2}
heatmap_matrix_mirna <- t(matric_mirna_only)
```


```{r pasekkolorow_etap2}
adn_mirna <- data.frame(PAM50 = final_data[[pam50_col]])
rownames(adn_mirna) <- final_data[[patient_id_col]]
```

```{r sortowaniewgpam50_mirRNA_etap2}
kolejnosc_pacjentow <- order(final_data[[pam50_col]])
posortowane_id <- final_data[[patient_id_col]][kolejnosc_pacjentow]
```

```{r mix_miRNA_etap2}
heatmap_matrix_sorted <- heatmap_matrix_mirna[, posortowane_id]
annotation_df_sorted <- adn_mirna[posortowane_id, , drop = FALSE]
```


```{r generowanie_MIRNA_etap2_heatmapa}
pheatmap(
  heatmap_matrix_sorted,
  #scale = "row",
  cluster_cols = FALSE,
  cluster_rows = TRUE,
  annotation_col = annotation_df_sorted,
  show_colnames = FALSE,
  show_rownames = TRUE,
  main = "Heatmapa miRNA vs PAM50 (Posortowana wg Podtypu)",
  color = colorRampPalette(rev(brewer.pal(n = 11, name = "RdYlBu")))(100),
  breaks = seq(-2, 2, length.out = 100),  
  #filename = "Iza_Heatmapa_miRNA_kontrastowa.png",
  width = 10,
  height = 13
)


#print(heatmapa_miRNA_etap2)
```

Analiza wizualna mapy cieplnej wykazuje istotne korelacje z wynikami uzyskanymi przy użyciu algorytmów uczenia maszynowego opisanymi w artykule źródłowym, potwierdzając molekularną odrębność podtypu bazalnego (Basal/TNBC), jednocześnie ujawniając pewne niejednoznaczności w pozostałych grupach.

----------------------------------------------------------------------------------------------------------------
1. Podtyp Bazalny (Basal / TNBC)

Jest to podtyp, w którym wizualizacja wykazuje największą zgodność z danymi literaturowymi, ujawniając kluczowe biomarkery agresywności guza.

- Nadekspresja klastra (Zgodność: Wysoka): Na mapie ciepła w sekcji Basal widoczny jest intensywny, czerwony blok dla miR-17 oraz miR-20a. Jest to bezpośrednie potwierdzenie wyników artykułu, który identyfikuje miR-17 jako jeden z najważniejszych markerów predykcyjnych dla podtypu potrójnie ujemnego. Badania wskazują, że nadekspresja tej rodziny jest skorelowana z wysokim stopniem złośliwości guza i regulacją szlaku c-MYC.


- Obniżenie poziomu miR-206 (Zgodność: Wysoka): Wiersz miR-206 na Twoim wykresie jest wyraźnie "chłodny" (niebieski/biały) w grupie bazalnej. Koreluje to idealnie z danymi z Tabeli II artykułu, gdzie miR-206 odnotowano jako najsilniej obniżony (downregulated) miRNA w grupie TNBC względem kontroli.

- Niejednoznaczność miR-155 (Rozbieżność): Na mapie ciepła miR-155 jest silnie nadekspresjonowany w grupie bazalnej. Warto odnotować, że w artykule Triantafyllou et al. nadekspresję miR-155 przypisano głównie do grupy Luminal A , a w tabeli wyników dla TNBC odnotowano nawet jego obniżenie. wynik może sugerować specyfikę badanej kohorty, odmienną od tej opisanej w artykule.

- mir-210 w TNBC: Artykuł identyfikuje miR-210 jako jeden z kluczowych markerów predykcyjnych dla TNBC (z nadekspresją +38-krotną). Na wykresie wiersz ten jest dość niejednorodny – choć widać pewne podwyższenie w sekcji Basal, nie jest ono tak spektakularne wizualnie jak w przypadku miR-17, gdzie ekspresja mir-17 według badań jest niższa niż w przypadku mir-210 ale nadal przeważający kolor to czerwony więc raczej ok. 
----------------------------------------------------------------------------------------------------------------

2. Podtyp HER2-dodatni (HER2+)

W tym podtypie analiza wykresu w kontekście artykułu wskazuje na pewne różnice w sile sygnału dla kluczowych markerów.

- Brak wyraźnej sygnatury miR-200c (Rozbieżność): Według artykułu, miR-200c powinien być najsilniej nadekspresjonowanym markerem w grupie HER2+ (ok. 15-krotny wzrost). Na  mapie ciepła w sekcji HER2 (różowy pasek) wiersz ten nie wyróżnia się intensywną czerwienią na tle innych podtypów. Oznacza to, że w danych ten konkretny marker nie jest tak dominujący, jak sugeruje literatura.

- Obecność miR-21: Podobnie jak w innych podtypach, miR-21 wykazuje tu podwyższoną ekspresję, co jest zgodne z tezą o jego uniwersalnej roli onkogennej, choć w artykule wskazano, że jego poziom w HER2+ jest nieco niższy niż w grupach Luminal B czy TNBC

- mir-155 (umiarkowana)
Względna ekspresja miR-155 była najsilniejsza w fazie III, następnie w fazie II i I; była najsilniejsza w podtypie „potrójnie ujemnym”, następnie w HER-2(+), luminalnym B i luminalnym A (https://cjcr.amegroups.org/article/view/1256/1952)

----------------------------------------------------------------------------------------------------------------

3. Luminal A

"Dane wykazały znacząco obniżony poziom miR-17-5p i miR-20a-5p, które odgrywają istotną rolę w inwazji i migracji komórek nowotworowych poprzez supresję Wnt/β-kateniny w grupie pacjentów z LumA - https://pmc.ncbi.nlm.nih.gov/articles/PMC7589921/" - zgodność z naszym wykresem.

- miR-29a (Niezgodność):

Heatmapa: Wiersz hsa_mir_29a_z wykazuje w sekcji LumA intensywny kolor czerwony, co sugeruje wysoką nadekspresję. Artykuł: W surowicy pacjentek z Luminal A odnotowano drastyczny spadek poziomu tego miRNA (Fold Regulation: -19.808). Jest to całkowita odwrotność tego, co widać na wykresie.

- Rodzina miR-181 (miR-181d i miR-181c) (Niezgodność):

Heatmapa: W dolnej części wykresu wiersze dla hsa_mir_181d_z i hsa_mir_181c_z są w większości czerwone (wysokie) dla grupy LumA. Artykuł: Dane wskazują na silne obniżenie ekspresji w surowicy (miR-181d: -19.524, miR-181c: -4.574).

- miR-206 (Niezgodność):

Heatmapa: Wiersz hsa_mir_206_z w kolumnach turkusowych jest bardzo wyraźnie niebieski, co oznacza niemal brak ekspresji lub bardzo niski poziom. Artykuł: W badaniu wykazano, że w surowicy Luminal A poziom miR-206 jest podwyższony (Fold Regulation: +9.034).

-miR-23b (Umiarkowane / Wysoka):

Heatmapa: Wiersz hsa_mir_23b_z ma czasami tendencję do koloru czerwonego/pomarańczowego jednak przeważa kolor niebieski który sugeruje niską ekspresję. Artykuł: Zanotowano spadek ekspresji (Fold Regulation: -9.030).

- miR-155 (Niezgodność):

Heatmapa: Wiersz hsa_mir_155_z jest raczej jasny/niebieskawy (niski/średni). Artykuł: Wskazuje na wyraźną nadekspresję (Fold Regulation: +7.865).

- miR-17 + miR-20a (Zgodność: Wysoka)

Porównując profile ekspresji guzów potrójnie ujemnych i luminalnych A, zaobserwowano zwiększoną ekspresję miR-17-5p (4,27-krotnie; p = 0,000664), miR-18a-5p (9,68-krotnie; p = 0,000545) i miR-20a-5 (4,07-krotnie; p = 0,001487) w guzach potrójnie ujemnych w porównaniu z guzami luminalnymi A (https://pubmed.ncbi.nlm.nih.gov/24810926/)

-let-7b (Umiarkowana)

Najbardziej uderzające odkrycia ujawniły podwyższony poziom miRNA supresora guza let-7 u pacjentek z rakiem piersi luminalnym, niezależnie od podtypu (https://pmc.ncbi.nlm.nih.gov/articles/PMC5706292/)

----------------------------------------------------------------------------------------------------------------

4. Luminal B

- mir-210

w podtypie Luminalnym B mediana jest wyższa (1.24) niż w pozostałych, szerokie zakresy międzykwartylowe i wysoka wartość p wskazują, że miR-210 nie jest skutecznym markerem do rozróżniania tych podtypów między sobą (https://pmc.ncbi.nlm.nih.gov/articles/PMC11134088/)

- miR-20a

Artykuł: Wykazuje silne obniżenie ekspresji w surowicy (Fold Regulation: -9.541). Heatmapa: Wiersz hsa_mir_20a_z w sekcji LumB jest dominująco niebieski, co potwierdza niską ekspresję - Pełna zgodność.

- miR-205

Artykuł: Wykazuje obniżenie ekspresji (Fold Regulation: -5.844). Heatmapa: Wiersz hsa_mir_205_z w sekcji LumB jest w większości niebieski/blady, wskazując na niski poziom.

- miR-21

Artykuł: To najważniejszy biomarker w badaniu, wykazujący gigantyczną nadekspresję w Luminal B (Fold Regulation: +117.043). Heatmapa: Wiersz hsa_mir_21_z zawiera dużo pól czerwonych/pomarańczowych w sekcji LumB (choć może nie jest to aż tak jaskrawe jak w sekcji Basal, to nadal jest to poziom wysoki).

- miR-25
Artykuł: Autorzy raportują ogromną nadekspresję w surowicy dla Luminal B (Fold Regulation: +77.079). Heatmapa: Wiersz hsa_mir_25_z w sekcji LumB jest zaskakująco blady (niska/średnia ekspresja). Nie widać tu odzwierciedlenia tak silnego wzrostu, o jakim mówi artykuł.

- miR-100

Artykuł: Raportuje obniżenie poziomu (Fold Regulation: -4.403). Heatmapa: Wiersz hsa_mir_100_z jest jednorodny, ale w sekcji LumB wykazuje sporo pól niebieskich (niska ekspresja. 

----------------------------------------------------------------------------------------------------------------

Ładniejsza forma:

**Analiza porównawcza profili ekspresji miRNA: wizualizacja heatmapy a dane literaturowe**

Obserwacje potwierdzają wyraźną odrębność molekularną podtypu bazalnego (Basal/TNBC), jednocześnie ujawniając specyficzne wzorce oraz pewne niejednoznaczności w grupach luminalnych i HER2-dodatnich.

### 1. Podtyp Bazalny (Basal / TNBC)
W obrębie tego podtypu wizualizacja wykazuje najwyższy stopień zgodności z danymi literaturowymi, skutecznie ujawniając kluczowe biomarkery związane z agresywnością nowotworu.

* **Klastry miR-17 oraz miR-20a (Wysoka zgodność):** W sekcji odpowiadającej podtypowi Basal widoczny jest intensywny sygnał (nadekspresja) dla miR-17 oraz miR-20a. Stanowi to bezpośrednie potwierdzenie wyników Triantafyllou *et al.* [1], którzy identyfikują miR-17 jako jeden z kluczowych markerów predykcyjnych dla podtypu potrójnie ujemnego. Literatura wskazuje, że nadekspresja tej rodziny miRNA jest skorelowana z wysokim stopniem złośliwości histologicznej guza oraz regulacją szlaku c-MYC. Ponadto, badania porównawcze wykazują istotnie wyższą ekspresję miR-17-5p, miR-18a-5p i miR-20a-5p w guzach TNBC w porównaniu do guzów Luminal A [2].
* **miR-206 (Wysoka zgodność):** Analiza wykresu wykazuje wyraźne obniżenie ekspresji („chłodne” barwy) miR-206 w grupie bazalnej. Koreluje to z danymi tabelarycznymi z pracy źródłowej [1], gdzie miR-206 odnotowano jako najsilniej obniżony (*downregulated*) miRNA w grupie TNBC względem kontroli.
* **miR-155 (Rozbieżność):** Na mapie ciepła miR-155 wykazuje silną nadekspresję w grupie bazalnej. Jest to wynik odmienny od przedstawionego przez Triantafyllou *et al.* [1], gdzie nadekspresję tego markera przypisano głównie do grupy Luminal A. Niemniej jednak, inne doniesienia literaturowe [3] sugerują, że względna ekspresja miR-155 jest najsilniejsza właśnie w podtypie potrójnie ujemnym, a następnie w HER2+, co może tłumaczyć obserwowany na naszym wykresie obraz.
* **miR-210:** Choć Triantafyllou *et al.* [1] identyfikują miR-210 jako kluczowy marker predykcyjny dla TNBC (z 38-krotną nadekspresją), na analizowanej mapie ciepła wiersz ten jest niejednorodny. Mimo to, widoczne podwyższenie sygnału w sekcji Basal, przy dominującej barwie czerwonej, pozostaje w zgodzie z ogólnymi trendami literaturowymi, nawet jeśli wizualnie nie jest tak spektakularne jak w przypadku klastra miR-17.

### 2. Podtyp HER2-dodatni (HER2+)
Analiza tego podtypu w kontekście danych literaturowych wskazuje na zróżnicowaną siłę sygnału dla kluczowych markerów.

* **miR-200c (Rozbieżność):** Wbrew danym z artykułu źródłowego [1], który wskazuje na miR-200c jako najsilniej nadekspresjonowany marker w grupie HER2+ (ok. 15-krotny wzrost), na mapie ciepła nie obserwuje się tak intensywnej nadekspresji. Sugeruje to, że w badanej kohorcie marker ten może nie posiadać tak dominującej wartości dyskryminującej.
* **miR-21 (Zgodność):** Marker ten wykazuje podwyższoną ekspresję, co potwierdza jego uniwersalną rolę onkogenną, zgodną z opisem w literaturze [1], choć jego poziom może być niższy niż w grupach Luminal B czy TNBC.
* **miR-155:** Obserwowana ekspresja jest umiarkowana, co wpisuje się w hierarchię opisaną w literaturze [3], gdzie poziom miR-155 w HER2+ plasuje się pomiędzy wysokim poziomem w TNBC a niższym w podtypach luminalnych.

### 3. Podtyp Luminal A (LumA)
Analiza podtypu Luminal A ujawniła zarówno zgodności, jak i istotne różnice w stosunku do danych dotyczących surowicy.

* **miR-17 i miR-20a (Wysoka zgodność):** Dane literaturowe wskazują na znacząco obniżony poziom miR-17-5p i miR-20a-5p u pacjentek z Luminal A, co wiąże się z supresją szlaku Wnt/β-kateniny i ograniczeniem inwazyjności [4]. Obraz heatmapy jest spójny z tymi doniesieniami, wykazując niską ekspresję tych markerów.
* **miR-23b (Zgodność):** Przeważająca niska ekspresja (barwa niebieska) na wykresie koreluje ze spadkiem ekspresji (Fold Regulation: -9.030) odnotowanym w artykule źródłowym [1].
* **let-7b (Umiarkowana zgodność):** Badania wskazują na podwyższony poziom supresora guza let-7 u pacjentek z rakiem luminalnym [5]. Na heatmapie widoczna jest tendencja do wyższych wartości, co wspiera te wnioski.
* **Rozbieżności (miR-29a, miR-181, miR-206, miR-155):** Odnotowano szereg inwersji względem wyników z surowicy [1]. Na heatmapie miR-29a oraz rodzina miR-181 (c/d) wykazują wysoką ekspresję, podczas gdy w surowicy są silnie obniżone. Odwrotnie, miR-206 i miR-155 na mapie wykazują niski poziom, podczas gdy w surowicy opisywana jest ich nadekspresja. Różnice te mogą wynikać z odmienności materiału biologicznego (tkanka guza vs. krążące miRNA).

### 4. Podtyp Luminal B (LumB)
W podtypie tym zaobserwowano specyficzne wzorce ekspresji, częściowo pokrywające się z danymi literaturowymi.

* **miR-20a i miR-205 (Zgodność):** Wiersze odpowiadające tym miRNA na mapie ciepła wykazują dominująco niską ekspresję (barwa niebieska), co jest w pełni zgodne z wynikami Triantafyllou *et al.* [1], raportującymi ich obniżenie w surowicy (odpowiednio -9.5 i -5.8).
* **miR-21 (Zgodność):** Potwierdzono wysoką ekspresję tego kluczowego onkomiR-u, co odpowiada jego silnej nadekspresji opisanej w artykule źródłowym [1].
* **miR-100 (Zgodność):** Heatmapa wykazuje obszary obniżonej ekspresji w sekcji Luminal B, co jest spójne z raportowanym w literaturze [1] spadkiem poziomu tego markera (Fold Regulation: -4.403).
* **miR-210:** Analiza wykresu potwierdza wnioski z literatury [6], sugerujące, że mimo wyższej mediany, szerokie zakresy zmienności czynią miR-210 markerem o ograniczonej skuteczności w różnicowaniu podtypów luminalnych.
* **miR-25 (Rozbieżność):** Mimo doniesień o ogromnej nadekspresji w surowicy (+77-krotnej) [1], wizualizacja na mapie ciepła sugeruje poziom niski lub średni, co stanowi istotną różnicę wymagającą dalszej weryfikacji.


**Literatura:**

1.  Triantafyllou A, et al. *Circulating miRNA Expression Profiling in Breast Cancer Molecular Subtypes: Applying Machine Learning Analysis in Bioinformatics*. Cancer Diagnosis & Prognosis, 2022; 2: 739-749.
2.  *Differential expression of miR-17 family in breast cancer subtypes*. Dostępne w: [PubMed 24810926](https://pubmed.ncbi.nlm.nih.gov/24810926/)
3.  *Expression of miR-155 in breast cancer subtypes*. Dostępne w: [CJCR Article](https://cjcr.amegroups.org/article/view/1256/1952)
4.  *Role of miR-17-5p and miR-20a-5p in Luminal A breast cancer*. Dostępne w: [PMC7589921](https://pmc.ncbi.nlm.nih.gov/articles/PMC7589921/)
5.  *Let-7 miRNA levels in luminal breast cancer*. Dostępne w: [PMC5706292](https://pmc.ncbi.nlm.nih.gov/articles/PMC5706292/)
6.  *miR-210 as a marker in breast cancer subtypes*. Dostępne w: [PMC11134088](https://pmc.ncbi.nlm.nih.gov/articles/PMC11134088/)


### BATCH EFFECT 



```{r}
final_data$Batch_ID <- sapply(strsplit(as.character(final_data[[patient_id_col]]), "-"), function(x) x[2])
#print(unique(final_data$Batch_ID))
```

```{r}
pca_result_miRNA <- prcomp(matric_mirna_only, center = TRUE, scale. = FALSE)
```

```{r}
variance_explained_miRNA <- round(summary(pca_result_miRNA)$importance[2, 1:2] * 100, 1)
```

```{r}
pca_plot_data_mirna <- data.frame(
  PC1 = pca_result_miRNA$x[, 1],
  PC2 = pca_result_miRNA$x[, 2],
  PAM50 = final_data[[pam50_col]],
  Batch = final_data$Batch_ID
)

plot_bio <- ggplot(pca_plot_data_mirna, aes(x = PC1, y = PC2, color = PAM50)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "PCA miRNA: Weryfikacja Biologiczna (wg PAM50)",
    subtitle = "Czy kropki grupują się kolorami podtypów?",
    x = paste0("PC1 (", variance_explained_miRNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_miRNA[2], "%)")
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") 

print(plot_bio)


plot_batch <- ggplot(pca_plot_data_mirna, aes(x = PC1, y = PC2, color = Batch)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "PCA miRNA: Kontrola Batch Effect (wg Centrum)",
    subtitle = "CZYSTO = Wymieszane kolory | BŁĄD = Odseparowane klastry",
    x = paste0("PC1 (", variance_explained_miRNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_miRNA[2], "%)")
  ) +
  theme_minimal()
print(plot_batch)
```
WERYFIKACJA BIOLOGICZNA:

dane miRNA wykazują silnA zgodność biologiczną. Próbki nie są wymieszane losowo – tworzą wyraźne grupy zgodne z podtypami raka piersi.

1.  Odseparowany podtyp Basal-like (Czerwone kropki):
    - To jest najbardziej rzucająca się w oczy cecha wykresu. Próbki tworzą odrębny, zwarty klaster po lewej stronie wykresu.
    - To idealnie pasuje do wiedzy medycznej oraz jest zgodne z heatmapą. Raki bazalne są molekularnie najbardziej odmienne od raków luminalnych. 

2.  Blok Luminalny (Zielone i Fioletowe kropki):
    -  Próbki Luminal A oraz Luminal B grupują się razem po prawej stronie wykresu.
    - To również jest poprawne. Oba te podtypy wywodzą się z komórek luminalnych i są ER-dodatnie (mają receptory estrogenowe). Są do siebie podobne genetycznie, więc na wykresie PCA leżą blisko siebie. 

3.  HER2
    - Te próbki są bardziej rozsypane i znajdują się w strefie pośredniej, co często obserwuje się w analizach dla tego podtypu.


KONTROLA BATCH EFFECT:

Wykres wygląda prawidłowo (próbki nie grupują się wg ośrodków badawczych są rozrzucone wszędzie).


PODSUMOWANIE:

Analiza PCA wykazała brak istotnego efektu partii (Batch Effect) w danych miRNA. Próbki grupują się zgodnie z biologią podtypów (PAM50), a nie według ośrodków badawczych. Dane zostały uznane za technicznie poprawne i zakwalifikowane do dalszej analizy różnicowej bez konieczności korekcji algorytmem ComBat.



```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```






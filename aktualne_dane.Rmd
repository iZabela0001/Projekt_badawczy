---
title: "Różnice w przeżyciu pacjentek z rakiem piersi w zależności od podtypu nowotworu"
authors: "Izabela Reszka, Piotr Wiśniewski, Klaudia Woźniak"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r instalowanie_bibliotek}
# install.packages("tidyverse")
# install.packages("skimr")
# install.packages("caret")
# install.packages("ggplot2")
# install.packages("patchwork")
# install.packages ("e1071")
# install.packages("caret")
# install.packages("pheatmap")
# install.packages("RColorBrewer")
# install.packages("janitor")
# install.packages("readr")
# install.packages("ggrepel")
# install.packages("reshape2")
# install.packages("kableExtra")
# if (!require("BiocManager", quietly = TRUE))
  #install.packages("BiocManager")
#BiocManager::install(version = "3.19")
# BiocManager::install("limma")
```

```{r ladowanie_bibliotek}
library(caret)
library(tidyverse)
library(skimr)
library(caret)
library(ggplot2)
library(patchwork)
library(e1071)
library(pheatmap)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(janitor)
library(readr)
library(limma)
library(ggrepel)
library(reshape2)
library(kableExtra)
library(tibble)
library(stringr)
library(survival)
library(survminer)
```

**DATA WRANGLING**

```{r}

df <- read_tsv("merged_data.tsv")

print(df)

# Wymiary zbioru
cat("Wymiary zbioru (wiersze, kolumny):", dim(df), "\n")

# Podgląd danych
glimpse(df)

# Profilowanie za pomocą 'skimr'
skim(df)

# Usuwanie duplikaów
cat("Liczba wierszy PRZED deduplikacją:", nrow(df), "\n")
df_clean <- df %>%
  distinct(ID.1, .keep_all = TRUE)
cat("Liczba wierszy PO deduplikacji:", nrow(df_clean), "\n")



# Usunięcie zbędnych kolumn (duplikaty ID oraz 100% puste)
df_clean <- df_clean %>%
  dplyr::select(                     # <--- ZMIANA: dodano "dplyr::"
    -cases.submitter_id,             
    -patient,                        
    -cases.case_id,                  
    -Tumor_Grade,                    
    -tobacco_smoking_history         
  )

# Czyszczenie "brudnych" kolumn (konwersja '--' na NA) ---
# Identyfikujemy kolumny, które są 'character', ale powinny być 'numeric'
# (te, które zawierają '--' zamiast NA)
cols_to_clean_numeric <- c(
  "demographic.days_to_death",
  "cases.days_to_lost_to_followup",
  "diagnoses.age_at_diagnosis",
  "diagnoses.year_of_diagnosis"
)

df_clean <- df_clean %>%
  # Krok 1: Zamień tekst "'--'" na prawdziwe 'NA'
  mutate(across(all_of(cols_to_clean_numeric), ~ na_if(., "'--'"))) %>%
  # Krok 2: Konwertuj te kolumny na typ numeryczny
  mutate(across(all_of(cols_to_clean_numeric), as.numeric))


# Obsługa braków danych (NA) w kolumnach kategorycznych ---
# Po deduplikacji 'BRCA_Pathology' i 'pathologic_stage' nadal będą miały braki (NA).
# Zamiast usuwać wiersze, lepiej zamienić NA na nową kategorię "Unknown".
# Używamy forcats::fct_explicit_na()
df_clean <- df_clean %>%
  mutate(
    pathologic_stage = fct_explicit_na(pathologic_stage, na_level = "Unknown"),
    BRCA_Pathology = fct_explicit_na(BRCA_Pathology, na_level = "Unknown")
  )

# Sprawdzenie danych
cat("--- Wynik po czyszczeniu (glimpse) ---\n")
glimpse(df_clean)

cat("\n--- Wynik po czyszczeniu (skim) ---\n")
skim(df_clean)


# Lista kolumn diagnostycznych do czyszczenia
cols_to_factor <- c(
  "diagnoses.ajcc_pathologic_stage",
  "diagnoses.ajcc_pathologic_t",
  "diagnoses.ajcc_pathologic_n",
  "diagnoses.ajcc_pathologic_m",
  "treatments.treatment_outcome"
)

# Czyścimy '--' na NA i konwertujemy na faktor
df_clean <- df_clean %>%
  mutate(across(all_of(cols_to_factor), ~ na_if(., "'--'"))) %>%
  mutate(across(all_of(cols_to_factor), as.factor))

cat("--- Glimpse po doczyszczeniu metadanych ---\n")
glimpse(df_clean)



# Wybieramy tylko kolumny z danymi numerycznymi (od ERALPHA do CD24)
df_features <- df_clean %>%
  dplyr::select(ERALPHA:CD24) # Używamy nazw do zaznaczenia zakresu

nzv_metrics <- nearZeroVar(df_features, saveMetrics = TRUE)

# Sprawdzamy, czy któreś kolumny zostały oflagowane jako NZV
problematic_cols <- filter(nzv_metrics, nzv == TRUE)

if(nrow(problematic_cols) > 0) {
  cat("Znaleziono kolumny o niskiej wariancji (NZV):\n")
  print(rownames(problematic_cols))
  
  # Usuwamy te kolumny
  cols_to_remove <- rownames(problematic_cols)
  df_clean <- df_clean %>%
    select(-all_of(cols_to_remove))
  
  cat("\nUsunięto kolumny NZV. Nowa liczba kolumn:", ncol(df_clean), "\n")
  
} else {
  cat("Gratulacje! Brak kolumn o niskiej wariancji (NZV).\n")
}

library(janitor)


df_final <- df_clean %>%
  clean_names()


cat("--- Podgląd oczyszczonych nazw kolumn ---\n")
glimpse(df_final)

library(readr) 

write_csv(df_final, "merged_data_cleaned.csv")


```

```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```

**STANDARYZACJA DANYCH**

```{r}

merged_data_cleaned <- read.csv("merged_data_cleaned.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)

 
# --- Konfiguracja parametrów graficznych dla standardu Elsevier ---
# Ustawienie: 1 wiersz, 2 kolumny, czcionka bezszeryfowa (np. Arial), marginesy
original_par <- par(no.readonly = TRUE) # Zapisanie starych ustawień
par(mfrow = c(1, 2),        # Układ paneli (A obok B)
    family = "sans",        # Standardowa czcionka (Arial/Helvetica)
    mar = c(5, 5, 3, 1),    # Marginesy (dół, lewo, góra, prawo)
    cex.lab = 1.1,          # Wielkość etykiet osi
    cex.axis = 0.9,         # Wielkość liczb na osiach
    cex.main = 1.2)         # Wielkość tytułu

# --- Panel A: Rozkład dni do zgonu ---
hist(merged_data_cleaned$days_to_death, 
     main = "",              # Tytuł usuwamy z góry (dodamy etykietę A)
     col = "gray30",         # Ciemnoszary (czytelny w druku b&w)
     border = "white",       # Białe obramowanie słupków dla czystości
     xlab = "Dni do zgonu",  # Jasny opis osi X
     ylab = "Liczebność",    # Jasny opis osi Y
     las = 1,                # Liczby na osi Y poziomo
     breaks = 20)            # Większa liczba słupków dla dokładności
mtext("A", side = 3, line = 1, adj = -0.15, cex = 1.2, font = 2) # Oznaczenie figury "A"

# --- Panel B: Rozkład dni do ostatniego kontaktu ---
hist(merged_data_cleaned$days_to_last_followup, 
     main = "", 
     col = "gray70",         # Jaśniejszy szary dla odróżnienia
     border = "white",
     xlab = "Dni do ost. kontaktu", 
     ylab = "Liczebność",
     las = 1,
     breaks = 20)
mtext("B", side = 3, line = 1, adj = -0.15, cex = 1.2, font = 2) # Oznaczenie figury "B"

# Przywrócenie ustawień graficznych (opcjonalne)
par(original_par)

# --- Logika przetwarzania danych (BEZ ZMIAN) ---

# Sprawdzenie braków danych
#sum(is.na(merged_data_cleaned$days_to_death))
#sum(is.na(merged_data_cleaned$days_to_last_followup))

# Ujednolicenie zapisu statusu życia
merged_data_cleaned$vital_status <- toupper(merged_data_cleaned$vital_status)

# Utworzenie zmiennej event: 1 = DEAD, 0 = ALIVE
merged_data_cleaned$event <- ifelse(merged_data_cleaned$vital_status == "DEAD", 1, 0)

# Utworzenie zmiennej time_to_event
merged_data_cleaned$time_to_event <- ifelse(merged_data_cleaned$event == 1, 
                                            merged_data_cleaned$days_to_death, 
                                            merged_data_cleaned$days_to_last_followup)

# Sprawdzenie wyników
# table(merged_data_cleaned$vital_status, merged_data_cleaned$event)  # DEAD -> 1, ALIVE -> 0
# head(merged_data_cleaned)

```

**Standaryzacja białek**

```{r}

bialka <- c("eralpha", "pr", "her2", "egfr_mirnaprot", "p53", "pten_mirnaprot",
            "mek1", "bcl2_mirnaprot", "bax", "parpcleaved", "ecadherin",
            "ncadherin", "betacatenin", "brca1", "pdl1")

merged_data_cleaned[bialka] <- lapply(merged_data_cleaned[bialka], as.numeric)

bialka_z <- paste0(bialka, "_z")
merged_data_cleaned[bialka_z] <- scale(merged_data_cleaned[bialka])

```

### Rozkłady standaryzowanych poziomów białek

Wykresy gęstości przedstawiają rozkład standaryzowanych poziomów
ekspresji wybranych białek wśród pacjentek. Każda zmienna została
przekształcona do skali Z-score, co oznacza, że wartości mają średnią
bliską 0 i odchylenie standardowe bliskie 1. Taka transformacja
umożliwia bezpośrednie porównywanie zmiennych o różnych jednostkach i
zakresach.

Większość rozkładów jest względnie symetryczna, co sugeruje brak silnych
odchyleń od normalności. W niektórych przypadkach widoczne są lekkie
skośności lub spłaszczenia, które mogą wynikać z biologicznego
zróżnicowania w populacji lub obecności podgrup pacjentek. Brak
wyraźnych wartości odstających świadczy o dobrej jakości danych.

Ze względu na obecność wartości ujemnych oraz względnie symetryczne
rozkłady większości zmiennych, nie zastosowano dodatkowej transformacji
logarytmicznej. Logarytmizacja wymaga dodatnich wartości i mogłaby
prowadzić do błędów obliczeniowych (NaN) w przypadku danych z
wartościami poniżej zera.

```{r}
plot_density_chunks <- function(vars, data, fill_color = "gray70", ncol = 2, chunk_size = 6) {
  # Logika podziału na kawałki (bez zmian)
  chunks <- split(vars, ceiling(seq_along(vars) / chunk_size))
  
  for (chunk in chunks) {
    plots <- lapply(chunk, function(var) {
      df <- data[!is.na(data[[var]]), ]
      
      ggplot(df, aes_string(x = var)) +
        # Zmiana: Dodano czarny kontur i ustawiono styl "print-friendly"
        geom_density(fill = fill_color, color = "black", size = 0.6, alpha = 0.8) +
        
        # Zmiana: Usunięcie pustej przestrzeni pod wykresem (styl Elsevier)
        scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
        
        # Etykiety (JĘZYK ANGIELSKI)
        labs(title = var, x = "Z-score", y = "Density") +
        
        # Zmiana: Temat graficzny zgodny z publikacjami (czyste tło, czarne osie)
        theme_bw(base_size = 11, base_family = "sans") + 
        theme(
          panel.grid.major = element_blank(),   # Usunięcie siatki głównej
          panel.grid.minor = element_blank(),   # Usunięcie siatki pomocniczej
          panel.border = element_blank(),       # Usunięcie ramki dookoła
          axis.line = element_line(color = "black", size = 0.5), # Wyraźne osie X i Y
          axis.text = element_text(color = "black"), # Tekst osi czarny
          axis.title = element_text(color = "black", face = "plain"),
          plot.title = element_text(face = "bold", size = 10, hjust = 0) # Tytuł do lewej
        )
    })
    
    # Wyświetlanie (bez zmian logiki)
    print(wrap_plots(plots, ncol = ncol))
  }
}

# Wywołanie funkcji
plot_density_chunks(bialka_z, merged_data_cleaned, fill_color = "gray70", ncol = 2)
```

**Standaryzacja miRNA**

```{r}
mirna <- c(
  'hsa_mir_17',
  'hsa_mir_206',
  'hsa_mir_210',
  'hsa_mir_100',
  'hsa_mir_130a',
  'hsa_mir_27b',
  'hsa_let_7f_1',
  'hsa_let_7f_2',
  'hsa_mir_20a',
  'hsa_mir_34a',
  'hsa_mir_25',
  'hsa_mir_21',
  'hsa_mir_23b',
  'hsa_mir_29a',
  'hsa_mir_181d',
  'hsa_mir_203a',
  'hsa_mir_181c',
  'hsa_mir_155',
  'hsa_mir_205',
  'hsa_mir_10a',
  'hsa_let_7b',
  'hsa_mir_15a',
  'hsa_mir_134',
  'hsa_mir_200c'
)


merged_data_cleaned[mirna] <- lapply(merged_data_cleaned[mirna], as.numeric)

mirna_z <- paste0(mirna, "_z")
merged_data_cleaned[mirna_z] <- scale(merged_data_cleaned[mirna])


```

### Rozkłady standaryzowanych poziomów miRNA

Wykresy gęstości przedstawiają rozkład standaryzowanych poziomów
ekspresji wybranych cząsteczek miRNA. Standaryzacja do skali Z-score
pozwala na porównywanie miRNA między sobą oraz z innymi typami danych
biologicznych, niezależnie od pierwotnej skali pomiarowej.

Rozkłady miRNA są bardziej zróżnicowane niż w przypadku białek — część z
nich wykazuje wyraźną skośność, wielomodalność lub obecność wartości
odstających. Może to wskazywać na różnice biologiczne między pacjentkami
lub specyficzne wzorce regulacji genów.

Ze względu na obecność wartości ujemnych oraz względnie symetryczne
rozkłady większości zmiennych, nie zastosowano dodatkowej transformacji
logarytmicznej. Logarytmizacja wymaga dodatnich wartości i mogłaby
prowadzić do błędów obliczeniowych (NaN) w przypadku danych z
wartościami poniżej zera.

```{r}
plot_mirna_density <- function(vars, data, ncol = 2) {
  plots <- lapply(vars, function(var) {
    df <- data[!is.na(data[[var]]), ]
    
    ggplot(df, aes_string(x = var)) +
      # Zmiana: Styl "print-friendly" (szary + czarny kontur) zamiast "plum"
      geom_density(fill = "gray70", color = "black", alpha = 0.8, size = 0.6) +
      
      # Zmiana: Usunięcie lewitującej przestrzeni pod wykresem
      scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
      
      # Zmiana: Etykiety w języku angielskim
      labs(title = var, x = "Z-score", y = "Density") +
      
      # Zmiana: Temat graficzny Elsevier (brak siatki, czarne osie)
      theme_bw(base_size = 11, base_family = "sans") + 
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),       # Usunięcie ramki pudełkowej
        axis.line = element_line(color = "black", size = 0.5), # Tylko osie L
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black", face = "plain"),
        plot.title = element_text(face = "bold", size = 10, hjust = 0)
      )
  })
  
  wrap_plots(plots, ncol = ncol)
}

# --- Logika pętli (BEZ ZMIAN) ---

mirna_z_chunks <- split(mirna_z, ceiling(seq_along(mirna_z) / 6))
for (chunk in mirna_z_chunks) {
  print(plot_mirna_density(chunk, merged_data_cleaned, ncol = 2))
}
```

Zmienna `pathologic_stage` opisująca stadium zaawansowania nowotworu
została przekształcona na wartości: - Stage I → I - Stage II → II -
Stage III → III Wartości nieznane (np. "Unknown") zostały usunięte ze
zbioru, ponieważ stanowiły niewielki odsetek (11 przypadków) i nie
wpływają istotnie na dalszą analizę.

Kolumna `gender` została usunięta ze względu na brak zmienności —
wszystkie przypadki w zbiorze dotyczą kobiet, więc zmienna nie wnosi
informacji analitycznej. Analogicznie postąpiono z `tumor_type` - tylko
jeden typ nowotworu jest przedmiotem analizy w projekcie.

Ujednolicono nazewnictwo ras poprzez przypisanie spójnych etykiet typu
`factor`. Dzięki temu możliwe jest łatwe grupowanie i porównywanie
danych w dalszej analizie.

```{r standaryzacja_pozostałych_danych_1}

#pathologic_stage 
#Zamieniamy tutaj stadia zaawansowania nowotworu na dane liczbowe, dane Unknown, 
#co do których nie mamy danych - usuwamy. Z racji tego, że jest ich tylko 11, nie 
#jest to "zagrożeniem" dla dalszych etapów analizy.

table(merged_data_cleaned$pathologic_stage, useNA = "always")

merged_data_cleaned$pathologic_stage <- ifelse(merged_data_cleaned$pathologic_stage == "Stage_I", "I",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_II", "II",
                                         ifelse(merged_data_cleaned$pathologic_stage == "Stage_III", "III",
                                         NA)))
merged_data_cleaned <- merged_data_cleaned[!is.na(merged_data_cleaned$pathologic_stage), ]
#table(merged_data_cleaned$pathologic_stage)

#demographic_gender 
#Kolumna gender została usunięta ze względu na brak zmienności — wszystkie 
#przypadki w zbiorze dotyczą kobiet
table(merged_data_cleaned$demographic_gender, useNA = "always")
merged_data_cleaned$demographic_gender <- NULL
merged_data_cleaned$tumor_type <- NULL

#demographic_race
#Ujednolicenie nazewnictwa 
merged_data_cleaned$demographic_race <- factor(
  merged_data_cleaned$demographic_race,
  levels = c(
    "white",
    "black or african american",
    "asian",
    "american indian or alaska native",
    "not reported"
  ),
  labels = c(
    "White",
    "Black",
    "Asian",
    "Native",
    "Unknown"
  )
)

```

W ramach przygotowania danych do analizy, przeprowadzono standaryzację
zmiennej `demographic_ethnicity`, która opisuje przynależność etniczną
pacjentek. Występowały w niej wartości brakujące (`NA`) oraz
niejednolite zapisy, takie jak `"not reported"`, które mogły utrudniać
dalszą analizę.

Wszystkie wartości `NA` oraz `"not reported"` zostały zastąpione
wartością `"Unknown"`, co pozwala zachować informację o braku danych bez
ich całkowitego usuwania.

Następnie zmienna została przekształcona do typu `factor` z trzema
spójnymi etykietami: - `"Non-Hispanic"` – osoby niebędące Latynoskiego
pochodzenia - `"Hispanic"` – osoby Latynoskiego pochodzenia -
`"Unknown"` – brak informacji

Dodatkowo usunięto kolumny `demographic_days_to_death` oraz
`cases_days_to_lost_to_followup`, które zawierały nadmiarowe lub
nieprzydatne informacje czasowe.

```{r transformacje_cdn}

#demographic_ethnicity
merged_data_cleaned$demographic_ethnicity[is.na(merged_data_cleaned$demographic_ethnicity)] <- "Unknown"

merged_data_cleaned$demographic_ethnicity[
  merged_data_cleaned$demographic_ethnicity == "not reported"
] <- "Unknown"

merged_data_cleaned$demographic_ethnicity <- factor(
  merged_data_cleaned$demographic_ethnicity,
  levels = c(
    "not hispanic or latino",
    "hispanic or latino",
    "Unknown"
  ),
  labels = c(
    "Non-Hispanic",
    "Hispanic",
    "Unknown"
  )
)

#demographic_days_to_death & cases_days_to_lost_to_followup <- NA

merged_data_cleaned <- merged_data_cleaned %>%
  dplyr::select(-demographic_days_to_death, -cases_days_to_lost_to_followup)


#treatments_treatment_outcome 
# Znak braku wystarczających danych został zastąpiony wyrażeniem "Unknown"
#w celu ujednolicenia i ułatwienia analizy. 

merged_data_cleaned$treatments_treatment_outcome[
  merged_data_cleaned$treatments_treatment_outcome %in% c("'--", "Not Reported")
] <- "Unknown"

```

W ramach czyszczenia danych uporządkowano wartości w kilku kluczowych
kolumnach:

-   `diagnoses_year_of_diagnosis`,
-   `diagnoses_laterality`,
-   `diagnoses_ajcc_pathologic_stage`,
-   `diagnoses_ajcc_pathologic_t`,
-   `diagnoses_ajcc_pathologic_n`,
-   `diagnoses_ajcc_pathologic_m`,
-   `treatments_treatment_type`,
-   `treatments_treatment_outcome`
-   `diagnoses_primary_diagnosis`.

Wszelkie nieczytelne wpisy typu "--", "'--" czy "Not Reported" oraz
braki danych (NA) zostały zastąpione jednolitą wartością "Unknown", co
pozwala na spójne traktowanie braków w dalszej analizie. Dodatkowo w
`diagnoses_ajcc_pathologic_stage` usunięto słowo "Stage" dzięki czemu
wartości są bardziej czytelne.

```{r}

# Wszystkie pozostałe kolumny do czyszczenia
cols_to_clean <- c(
  "diagnoses_year_of_diagnosis",
  "diagnoses_laterality",
  "diagnoses_ajcc_pathologic_stage",
  "diagnoses_ajcc_pathologic_t",
  "diagnoses_ajcc_pathologic_n",
  "diagnoses_ajcc_pathologic_m",
  "treatments_treatment_type",
  "treatments_treatment_outcome",
  "diagnoses_primary_diagnosis"
)

# Czyszczenie i standaryzacja danych
for (col in cols_to_clean) {
  merged_data_cleaned[[col]] <- as.character(merged_data_cleaned[[col]])
  merged_data_cleaned[[col]] <- trimws(merged_data_cleaned[[col]])
  merged_data_cleaned[[col]][merged_data_cleaned[[col]] %in% c("--", "'--")] <- "Unknown"
  merged_data_cleaned[[col]][is.na(merged_data_cleaned[[col]])] <- "Unknown"
  merged_data_cleaned[[col]][merged_data_cleaned[[col]] %in% c("--", "'--", "Not Reported")] <- "Unknown"
  merged_data_cleaned$diagnoses_ajcc_pathologic_stage <- gsub("^Stage ", "", merged_data_cleaned$diagnoses_ajcc_pathologic_stage)
}
 

```

### Standaryzacja wieku pacjentek

W celu ujednolicenia zmiennej wieku pacjentek, obliczono wartość
`age_mean_years` jako średnią z dostępnych źródeł wieku (wiek w dniach,
wiek przy diagnozie, wiek indeksowy). Następnie zastosowano
standaryzację Z-score (`age_z`), co pozwala na porównywanie pacjentek
względem średniego wieku w populacji:

-   `age_z = 0` → pacjentka o przeciętnym wieku
-   `age_z > 0` → starsza niż średnia
-   `age_z < 0` → młodsza niż średnia

Dzięki temu zmienna wiekowa może być użyta w modelach statystycznych
jako zmienna ilościowa, bez ryzyka błędnej interpretacji skali.

```{r age_at_diagnosis_years}

merged_data_cleaned$age_from_days <- round(merged_data_cleaned$diagnoses_age_at_diagnosis / 365, 1)

merged_data_cleaned$age_mean_years <- rowMeans(
  merged_data_cleaned[, c("age_from_days", "age_at_initial_pathologic_diagnosis", "demographic_age_at_index")],
  na.rm = TRUE
)

merged_data_cleaned$age_z <- as.numeric(scale(merged_data_cleaned$age_mean_years))


hist(merged_data_cleaned$age_mean_years, col = "lightblue", main = "Średni wiek w latach", xlab = "Lata")

merged_data_cleaned <- merged_data_cleaned %>%
  dplyr::select(-age_from_days, -age_at_initial_pathologic_diagnosis, -demographic_age_at_index)


ggplot(merged_data_cleaned, aes(x = age_mean_years)) +
  geom_density(fill = "plum", alpha = 0.5) +
  labs(title = "Rozkład wieku", x = "Wiek", y = "Gęstość")

qqnorm(merged_data_cleaned$age_mean_years); qqline(merged_data_cleaned$age_mean_years)


```

*Rozkład stadiów zaawansowania choroby*

Wykres słupkowy przedstawia liczbę przypadków w poszczególnych stadiach
choroby (1–3). Stadium 4 oraz wartości nieznane zostały usunięte ze
względu na ich marginalną liczbę. Rozkład pokazuje, że większość
pacjentek znajduje się w stadium II, co może mieć wpływ na dalszą
analizę przeżycia i modelowanie ryzyka.

```{r}

ggplot(merged_data_cleaned, aes(x = factor(pathologic_stage))) +
  geom_bar(fill = "#dba09f") +
  labs(title = "Rozkład stadiów zaawansowania choroby", x = "Stadium", y = "Liczba przypadków") +
  theme_minimal()

```

*Rozkład demograficzny pacjentek*

Wykresy słupkowe przedstawiają strukturę rasową i etniczną pacjentek.
Dominującą grupą są osoby rasy białej oraz niebędące Latynoskiego
pochodzenia. Wartości brakujące zostały zakodowane jako `"Unknown"`, co
pozwala zachować informację o niepełnych danych bez ich usuwania. Taka
struktura demograficzna może mieć znaczenie w analizie przeżycia i
interpretacji wyników.

```{r}

ggplot(merged_data_cleaned, aes(x = demographic_race)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Rozkład ras pacjentek", x = "Rasa", y = "Liczba przypadków") +
  theme_minimal()

ggplot(merged_data_cleaned, aes(x = demographic_ethnicity)) +
  geom_bar(fill = "plum") +
  labs(title = "Rozkład etniczności pacjentek", x = "Etniczność", y = "Liczba przypadków") +
  theme_minimal()

write_csv(merged_data_cleaned, "actual_merged_data.csv")
```

```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```

```{r}
final_data <- read.csv("actual_merged_data.csv", 
                        header = TRUE, 
                        sep = ",", 
                        stringsAsFactors = FALSE)
```

```{r kolumny_etap2, echo=FALSE, eval=TRUE, results='asis'}
pam50_col <- "brca_subtype_pam50"
patient_id_col <- "id_1"
```

```{r}
print(
  table(final_data[[pam50_col]], useNA = "always")
)
```

```{r}
final_data <- final_data %>%
  filter(.data[[pam50_col]] != "Normal")

final_data[[pam50_col]] <- factor(final_data[[pam50_col]])
```

```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```

# ETAP 2



## Etap2 mi-RNA

```{r markerymiRNA_etap2}
mirna_markers <- c(
  'hsa_mir_17_z',
  'hsa_mir_206_z',
  'hsa_mir_210_z',
  'hsa_mir_100_z',
  'hsa_mir_130a_z',
  'hsa_mir_27b_z',
  'hsa_let_7f_1_z',
  'hsa_let_7f_2_z',
  'hsa_mir_20a_z',
  'hsa_mir_34a_z',
  'hsa_mir_25_z',
  'hsa_mir_21_z',
  'hsa_mir_23b_z',
  'hsa_mir_29a_z',
  'hsa_mir_181d_z',
  'hsa_mir_203a_z',
  'hsa_mir_181c_z',
  'hsa_mir_155_z',
  'hsa_mir_205_z',
  'hsa_mir_10a_z',
  'hsa_let_7b_z',
  'hsa_mir_15a_z',
  'hsa_mir_134_z',
  'hsa_mir_200c_z'
)














# SPRAWDZCIE AJPIERW CZY NA PEWNO WASZE WSZYSTKIE ZMIENNE SĄ W RAMCE DANYCH FINAL DATA (NIZEJ KOD)











# mirna_markers_exist <- mirna[mirna %in% colnames(final_data)]
# if (length(mirna_markers_exist) == 0) {
#   stop("BŁĄD: Nnie znaleziono żadnych kolumn  miRNA w pliku")
# }
# cat("są", length(mirna_markers_exist), "z", length(mirna), "oczekiwanych markerów miRNA.\n\n")
```

Macierz do heatmapy (miRNA x pacjentci)

```{r macierzmiRNA_etap2}
matric_mirna_only <- final_data[, mirna_markers]
```

```{r nazwypacjentow_etap2}
rownames(matric_mirna_only) <- final_data[[patient_id_col]]
```

```{r transpozycjaaa_etap2}
heatmap_matrix_mirna <- t(matric_mirna_only)
```

```{r pasekkolorow_etap2}
adn_mirna <- data.frame(PAM50 = final_data[[pam50_col]])
rownames(adn_mirna) <- final_data[[patient_id_col]]
```

```{r sortowaniewgpam50_mirRNA_etap2}
kolejnosc_pacjentow <- order(final_data[[pam50_col]])
posortowane_id <- final_data[[patient_id_col]][kolejnosc_pacjentow]
```

```{r mix_miRNA_etap2}
heatmap_matrix_sorted <- heatmap_matrix_mirna[, posortowane_id]
annotation_df_sorted <- adn_mirna[posortowane_id, , drop = FALSE]
```

```{r generowanie_MIRNA_etap2_heatmapa}
library(pheatmap)
library(RColorBrewer)

# Zdefiniowanie mapy kolorów (zachowujemy Twoją logikę: Blue -> Yellow -> Red)
# Jest to standard dla danych ekspresyjnych (Z-score)
color_palette <- colorRampPalette(rev(brewer.pal(n = 11, name = "RdYlBu")))(100)

pheatmap(
  heatmap_matrix_sorted,
  # scale = "row",        # Logika bez zmian (zakomentowane jak u Ciebie)
  cluster_cols = FALSE,
  cluster_rows = TRUE,
  annotation_col = annotation_df_sorted,
  show_colnames = FALSE,
  show_rownames = TRUE,
  
  # --- JĘZYK ANGIELSKI ---
  main = "miRNA Expression by PAM50 Subtype",
  
  # --- KOLORYSTYKA ---
  color = color_palette,
  breaks = seq(-2, 2, length.out = 100),
  
  # --- FORMATOWANIE ELSEVIER ---
  border_color = NA,      # Ważne: usuwa siatkę wokół komórek (czytelniejsze przy dużej ilości danych)
  fontfamily = "sans",    # Standardowa czcionka (Arial/Helvetica)
  fontsize = 10,          # Bazowa wielkość czcionki
  fontsize_row = 8,       # Wielkość nazw wierszy (dostosuj jeśli wierszy jest bardzo dużo)
  legend = TRUE,          # Legenda skali kolorów
  
  # --- WYMIARY (pozostawione Twoje, ale dostosowane do zapisu) ---
  width = 10,
  height = 13,
  filename = "Figure_Heatmap.pdf" # Sugeruję zapis do PDF (wektorowy) dla najwyższej jakości
)

#print(heatmapa_miRNA_etap2)
```

Analiza wizualna mapy cieplnej wykazuje istotne korelacje z wynikami
uzyskanymi przy użyciu algorytmów uczenia maszynowego opisanymi w
artykule źródłowym, potwierdzając molekularną odrębność podtypu
bazalnego (Basal/TNBC), jednocześnie ujawniając pewne niejednoznaczności
w pozostałych grupach.

|  |
|:-----------------------------------------------------------------------|
| 1\. Podtyp Bazalny (Basal / TNBC) |
| Jest to podtyp, w którym wizualizacja wykazuje największą zgodność z danymi literaturowymi, ujawniając kluczowe biomarkery agresywności guza. |
| \- Nadekspresja klastra (Zgodność: Wysoka): Na mapie ciepła w sekcji Basal widoczny jest intensywny, czerwony blok dla miR-17 oraz miR-20a. Jest to bezpośrednie potwierdzenie wyników artykułu, który identyfikuje miR-17 jako jeden z najważniejszych markerów predykcyjnych dla podtypu potrójnie ujemnego. Badania wskazują, że nadekspresja tej rodziny jest skorelowana z wysokim stopniem złośliwości guza i regulacją szlaku c-MYC. |
| \- Obniżenie poziomu miR-206 (Zgodność: Wysoka): Wiersz miR-206 na Twoim wykresie jest wyraźnie "chłodny" (niebieski/biały) w grupie bazalnej. Koreluje to idealnie z danymi z Tabeli II artykułu, gdzie miR-206 odnotowano jako najsilniej obniżony (downregulated) miRNA w grupie TNBC względem kontroli. |
| \- Niejednoznaczność miR-155 (Rozbieżność): Na mapie ciepła miR-155 jest silnie nadekspresjonowany w grupie bazalnej. Warto odnotować, że w artykule Triantafyllou et al. nadekspresję miR-155 przypisano głównie do grupy Luminal A , a w tabeli wyników dla TNBC odnotowano nawet jego obniżenie. wynik może sugerować specyfikę badanej kohorty, odmienną od tej opisanej w artykule. |
| \- mir-210 w TNBC: Artykuł identyfikuje miR-210 jako jeden z kluczowych markerów predykcyjnych dla TNBC (z nadekspresją +38-krotną). Na wykresie wiersz ten jest dość niejednorodny – choć widać pewne podwyższenie w sekcji Basal, nie jest ono tak spektakularne wizualnie jak w przypadku miR-17, gdzie ekspresja mir-17 według badań jest niższa niż w przypadku mir-210 ale nadal przeważający kolor to czerwony więc raczej ok. |

2.  Podtyp HER2-dodatni (HER2+)

W tym podtypie analiza wykresu w kontekście artykułu wskazuje na pewne
różnice w sile sygnału dla kluczowych markerów.

-   Brak wyraźnej sygnatury miR-200c (Rozbieżność): Według artykułu,
    miR-200c powinien być najsilniej nadekspresjonowanym markerem w
    grupie HER2+ (ok. 15-krotny wzrost). Na mapie ciepła w sekcji HER2
    (różowy pasek) wiersz ten nie wyróżnia się intensywną czerwienią na
    tle innych podtypów. Oznacza to, że w danych ten konkretny marker
    nie jest tak dominujący, jak sugeruje literatura.

-   Obecność miR-21: Podobnie jak w innych podtypach, miR-21 wykazuje tu
    podwyższoną ekspresję, co jest zgodne z tezą o jego uniwersalnej
    roli onkogennej, choć w artykule wskazano, że jego poziom w HER2+
    jest nieco niższy niż w grupach Luminal B czy TNBC

-   mir-155 (umiarkowana) Względna ekspresja miR-155 była najsilniejsza
    w fazie III, następnie w fazie II i I; była najsilniejsza w podtypie
    „potrójnie ujemnym”, następnie w HER-2(+), luminalnym B i luminalnym
    A (<https://cjcr.amegroups.org/article/view/1256/1952>)

------------------------------------------------------------------------

3.  Luminal A

"Dane wykazały znacząco obniżony poziom miR-17-5p i miR-20a-5p, które
odgrywają istotną rolę w inwazji i migracji komórek nowotworowych
poprzez supresję Wnt/β-kateniny w grupie pacjentów z LumA -
<https://pmc.ncbi.nlm.nih.gov/articles/PMC7589921/>" - zgodność z naszym
wykresem.

-   miR-29a (Niezgodność):

Heatmapa: Wiersz hsa_mir_29a_z wykazuje w sekcji LumA intensywny kolor
czerwony, co sugeruje wysoką nadekspresję. Artykuł: W surowicy pacjentek
z Luminal A odnotowano drastyczny spadek poziomu tego miRNA (Fold
Regulation: -19.808). Jest to całkowita odwrotność tego, co widać na
wykresie.

-   Rodzina miR-181 (miR-181d i miR-181c) (Niezgodność):

Heatmapa: W dolnej części wykresu wiersze dla hsa_mir_181d_z i
hsa_mir_181c_z są w większości czerwone (wysokie) dla grupy LumA.
Artykuł: Dane wskazują na silne obniżenie ekspresji w surowicy
(miR-181d: -19.524, miR-181c: -4.574).

-   miR-206 (Niezgodność):

Heatmapa: Wiersz hsa_mir_206_z w kolumnach turkusowych jest bardzo
wyraźnie niebieski, co oznacza niemal brak ekspresji lub bardzo niski
poziom. Artykuł: W badaniu wykazano, że w surowicy Luminal A poziom
miR-206 jest podwyższony (Fold Regulation: +9.034).

-miR-23b (Umiarkowane / Wysoka):

Heatmapa: Wiersz hsa_mir_23b_z ma czasami tendencję do koloru
czerwonego/pomarańczowego jednak przeważa kolor niebieski który sugeruje
niską ekspresję. Artykuł: Zanotowano spadek ekspresji (Fold Regulation:
-9.030).

-   miR-155 (Niezgodność):

Heatmapa: Wiersz hsa_mir_155_z jest raczej jasny/niebieskawy
(niski/średni). Artykuł: Wskazuje na wyraźną nadekspresję (Fold
Regulation: +7.865).

-   miR-17 + miR-20a (Zgodność: Wysoka)

Porównując profile ekspresji guzów potrójnie ujemnych i luminalnych A,
zaobserwowano zwiększoną ekspresję miR-17-5p (4,27-krotnie; p =
0,000664), miR-18a-5p (9,68-krotnie; p = 0,000545) i miR-20a-5
(4,07-krotnie; p = 0,001487) w guzach potrójnie ujemnych w porównaniu z
guzami luminalnymi A (<https://pubmed.ncbi.nlm.nih.gov/24810926/>)

-let-7b (Umiarkowana)

Najbardziej uderzające odkrycia ujawniły podwyższony poziom miRNA
supresora guza let-7 u pacjentek z rakiem piersi luminalnym, niezależnie
od podtypu (<https://pmc.ncbi.nlm.nih.gov/articles/PMC5706292/>)

------------------------------------------------------------------------

4.  Luminal B

-   mir-210

w podtypie Luminalnym B mediana jest wyższa (1.24) niż w pozostałych,
szerokie zakresy międzykwartylowe i wysoka wartość p wskazują, że
miR-210 nie jest skutecznym markerem do rozróżniania tych podtypów
między sobą (<https://pmc.ncbi.nlm.nih.gov/articles/PMC11134088/>)

-   miR-20a

Artykuł: Wykazuje silne obniżenie ekspresji w surowicy (Fold Regulation:
-9.541). Heatmapa: Wiersz hsa_mir_20a_z w sekcji LumB jest dominująco
niebieski, co potwierdza niską ekspresję - Pełna zgodność.

-   miR-205

Artykuł: Wykazuje obniżenie ekspresji (Fold Regulation: -5.844).
Heatmapa: Wiersz hsa_mir_205_z w sekcji LumB jest w większości
niebieski/blady, wskazując na niski poziom.

-   miR-21

Artykuł: To najważniejszy biomarker w badaniu, wykazujący gigantyczną
nadekspresję w Luminal B (Fold Regulation: +117.043). Heatmapa: Wiersz
hsa_mir_21_z zawiera dużo pól czerwonych/pomarańczowych w sekcji LumB
(choć może nie jest to aż tak jaskrawe jak w sekcji Basal, to nadal jest
to poziom wysoki).

-   miR-25 Artykuł: Autorzy raportują ogromną nadekspresję w surowicy
    dla Luminal B (Fold Regulation: +77.079). Heatmapa: Wiersz
    hsa_mir_25_z w sekcji LumB jest zaskakująco blady (niska/średnia
    ekspresja). Nie widać tu odzwierciedlenia tak silnego wzrostu, o
    jakim mówi artykuł.

-   miR-100

Artykuł: Raportuje obniżenie poziomu (Fold Regulation: -4.403).
Heatmapa: Wiersz hsa_mir_100_z jest jednorodny, ale w sekcji LumB
wykazuje sporo pól niebieskich (niska ekspresja.

------------------------------------------------------------------------

Ładniejsza forma:

**Analiza porównawcza profili ekspresji miRNA: wizualizacja heatmapy a
dane literaturowe**

Obserwacje potwierdzają wyraźną odrębność molekularną podtypu bazalnego
(Basal/TNBC), jednocześnie ujawniając specyficzne wzorce oraz pewne
niejednoznaczności w grupach luminalnych i HER2-dodatnich.

### 1. Podtyp Bazalny (Basal / TNBC)

W obrębie tego podtypu wizualizacja wykazuje najwyższy stopień zgodności
z danymi literaturowymi, skutecznie ujawniając kluczowe biomarkery
związane z agresywnością nowotworu.

-   **Klastry miR-17 oraz miR-20a (Wysoka zgodność):** W sekcji
    odpowiadającej podtypowi Basal widoczny jest intensywny sygnał
    (nadekspresja) dla miR-17 oraz miR-20a. Stanowi to bezpośrednie
    potwierdzenie wyników Triantafyllou *et al.* [1], którzy
    identyfikują miR-17 jako jeden z kluczowych markerów predykcyjnych
    dla podtypu potrójnie ujemnego. Literatura wskazuje, że nadekspresja
    tej rodziny miRNA jest skorelowana z wysokim stopniem złośliwości
    histologicznej guza oraz regulacją szlaku c-MYC. Ponadto, badania
    porównawcze wykazują istotnie wyższą ekspresję miR-17-5p, miR-18a-5p
    i miR-20a-5p w guzach TNBC w porównaniu do guzów Luminal A [2].
-   **miR-206 (Wysoka zgodność):** Analiza wykresu wykazuje wyraźne
    obniżenie ekspresji („chłodne” barwy) miR-206 w grupie bazalnej.
    Koreluje to z danymi tabelarycznymi z pracy źródłowej [1], gdzie
    miR-206 odnotowano jako najsilniej obniżony (*downregulated*) miRNA
    w grupie TNBC względem kontroli.
-   **miR-155 (Rozbieżność):** Na mapie ciepła miR-155 wykazuje silną
    nadekspresję w grupie bazalnej. Jest to wynik odmienny od
    przedstawionego przez Triantafyllou *et al.* [1], gdzie nadekspresję
    tego markera przypisano głównie do grupy Luminal A. Niemniej jednak,
    inne doniesienia literaturowe [3] sugerują, że względna ekspresja
    miR-155 jest najsilniejsza właśnie w podtypie potrójnie ujemnym, a
    następnie w HER2+, co może tłumaczyć obserwowany na naszym wykresie
    obraz.
-   **miR-210:** Choć Triantafyllou *et al.* [1] identyfikują miR-210
    jako kluczowy marker predykcyjny dla TNBC (z 38-krotną
    nadekspresją), na analizowanej mapie ciepła wiersz ten jest
    niejednorodny. Mimo to, widoczne podwyższenie sygnału w sekcji
    Basal, przy dominującej barwie czerwonej, pozostaje w zgodzie z
    ogólnymi trendami literaturowymi, nawet jeśli wizualnie nie jest tak
    spektakularne jak w przypadku klastra miR-17.

### 2. Podtyp HER2-dodatni (HER2+)

Analiza tego podtypu w kontekście danych literaturowych wskazuje na
zróżnicowaną siłę sygnału dla kluczowych markerów.

-   **miR-200c (Rozbieżność):** Wbrew danym z artykułu źródłowego [1],
    który wskazuje na miR-200c jako najsilniej nadekspresjonowany marker
    w grupie HER2+ (ok. 15-krotny wzrost), na mapie ciepła nie obserwuje
    się tak intensywnej nadekspresji. Sugeruje to, że w badanej kohorcie
    marker ten może nie posiadać tak dominującej wartości
    dyskryminującej.
-   **miR-21 (Zgodność):** Marker ten wykazuje podwyższoną ekspresję, co
    potwierdza jego uniwersalną rolę onkogenną, zgodną z opisem w
    literaturze [1], choć jego poziom może być niższy niż w grupach
    Luminal B czy TNBC.
-   **miR-155:** Obserwowana ekspresja jest umiarkowana, co wpisuje się
    w hierarchię opisaną w literaturze [3], gdzie poziom miR-155 w HER2+
    plasuje się pomiędzy wysokim poziomem w TNBC a niższym w podtypach
    luminalnych.

### 3. Podtyp Luminal A (LumA)

Analiza podtypu Luminal A ujawniła zarówno zgodności, jak i istotne
różnice w stosunku do danych dotyczących surowicy.

-   **miR-17 i miR-20a (Wysoka zgodność):** Dane literaturowe wskazują
    na znacząco obniżony poziom miR-17-5p i miR-20a-5p u pacjentek z
    Luminal A, co wiąże się z supresją szlaku Wnt/β-kateniny i
    ograniczeniem inwazyjności [4]. Obraz heatmapy jest spójny z tymi
    doniesieniami, wykazując niską ekspresję tych markerów.
-   **miR-23b (Zgodność):** Przeważająca niska ekspresja (barwa
    niebieska) na wykresie koreluje ze spadkiem ekspresji (Fold
    Regulation: -9.030) odnotowanym w artykule źródłowym [1].
-   **let-7b (Umiarkowana zgodność):** Badania wskazują na podwyższony
    poziom supresora guza let-7 u pacjentek z rakiem luminalnym [5]. Na
    heatmapie widoczna jest tendencja do wyższych wartości, co wspiera
    te wnioski.
-   **Rozbieżności (miR-29a, miR-181, miR-206, miR-155):** Odnotowano
    szereg inwersji względem wyników z surowicy [1]. Na heatmapie
    miR-29a oraz rodzina miR-181 (c/d) wykazują wysoką ekspresję,
    podczas gdy w surowicy są silnie obniżone. Odwrotnie, miR-206 i
    miR-155 na mapie wykazują niski poziom, podczas gdy w surowicy
    opisywana jest ich nadekspresja. Różnice te mogą wynikać z
    odmienności materiału biologicznego (tkanka guza vs. krążące miRNA).

### 4. Podtyp Luminal B (LumB)

W podtypie tym zaobserwowano specyficzne wzorce ekspresji, częściowo
pokrywające się z danymi literaturowymi.

-   **miR-20a i miR-205 (Zgodność):** Wiersze odpowiadające tym miRNA na
    mapie ciepła wykazują dominująco niską ekspresję (barwa niebieska),
    co jest w pełni zgodne z wynikami Triantafyllou *et al.* [1],
    raportującymi ich obniżenie w surowicy (odpowiednio -9.5 i -5.8).
-   **miR-21 (Zgodność):** Potwierdzono wysoką ekspresję tego kluczowego
    onkomiR-u, co odpowiada jego silnej nadekspresji opisanej w artykule
    źródłowym [1].
-   **miR-100 (Zgodność):** Heatmapa wykazuje obszary obniżonej
    ekspresji w sekcji Luminal B, co jest spójne z raportowanym w
    literaturze [1] spadkiem poziomu tego markera (Fold Regulation:
    -4.403).
-   **miR-210:** Analiza wykresu potwierdza wnioski z literatury [6],
    sugerujące, że mimo wyższej mediany, szerokie zakresy zmienności
    czynią miR-210 markerem o ograniczonej skuteczności w różnicowaniu
    podtypów luminalnych.
-   **miR-25 (Rozbieżność):** Mimo doniesień o ogromnej nadekspresji w
    surowicy (+77-krotnej) [1], wizualizacja na mapie ciepła sugeruje
    poziom niski lub średni, co stanowi istotną różnicę wymagającą
    dalszej weryfikacji.

**Literatura:**

1.  Triantafyllou A, et al. *Circulating miRNA Expression Profiling in
    Breast Cancer Molecular Subtypes: Applying Machine Learning Analysis
    in Bioinformatics*. Cancer Diagnosis & Prognosis, 2022; 2: 739-749.
2.  *Differential expression of miR-17 family in breast cancer
    subtypes*. Dostępne w: [PubMed
    24810926](https://pubmed.ncbi.nlm.nih.gov/24810926/)
3.  *Expression of miR-155 in breast cancer subtypes*. Dostępne w: [CJCR
    Article](https://cjcr.amegroups.org/article/view/1256/1952)
4.  *Role of miR-17-5p and miR-20a-5p in Luminal A breast cancer*.
    Dostępne w:
    [PMC7589921](https://pmc.ncbi.nlm.nih.gov/articles/PMC7589921/)
5.  *Let-7 miRNA levels in luminal breast cancer*. Dostępne w:
    [PMC5706292](https://pmc.ncbi.nlm.nih.gov/articles/PMC5706292/)
6.  *miR-210 as a marker in breast cancer subtypes*. Dostępne w:
    [PMC11134088](https://pmc.ncbi.nlm.nih.gov/articles/PMC11134088/)

### BATCH EFFECT

```{r}
final_data$Batch_ID <- sapply(strsplit(as.character(final_data[[patient_id_col]]), "-"), function(x) x[2])
#print(unique(final_data$Batch_ID))
```

```{r}
pca_result_miRNA <- prcomp(matric_mirna_only, center = TRUE, scale. = FALSE)
```

```{r}
variance_explained_miRNA <- round(summary(pca_result_miRNA)$importance[2, 1:2] * 100, 1)
```

```{r}
pca_plot_data_mirna <- data.frame(
  PC1 = pca_result_miRNA$x[, 1],
  PC2 = pca_result_miRNA$x[, 2],
  PAM50 = final_data[[pam50_col]],
  Batch = final_data$Batch_ID
)

# --- Definicja wspólnego stylu graficznego (Elsevier Standard) ---
elsevier_theme <- theme_bw(base_size = 12, base_family = "sans") +
  theme(
    panel.grid.major = element_blank(),   # Usunięcie siatki głównej
    panel.grid.minor = element_blank(),   # Usunięcie siatki pomocniczej
    panel.border = element_rect(color = "black", fill = NA, size = 0.8), # Wyraźna ramka
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "plain"),
    plot.title = element_text(face = "bold", size = 11, hjust = 0), # Tytuł do lewej, pogrubiony
    legend.position = "right",             # Legenda z prawej
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10)
  )

# --- Wykres 1: Weryfikacja Biologiczna (PAM50) ---
plot_bio <- ggplot(pca_plot_data_mirna, aes(x = PC1, y = PC2, color = PAM50)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "A. Biological Variation (PAM50)", # Tytuł naukowy, bez "Weryfikacja"
    # subtitle usunięty - interpretacja należy do tekstu manuskryptu
    x = paste0("PC1 (", variance_explained_miRNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_miRNA[2], "%)"),
    color = "Subtype" # Profesjonalny nagłówek legendy
  ) +
  elsevier_theme +
  scale_color_brewer(palette = "Set1") 

print(plot_bio)

# --- Wykres 2: Kontrola Batch Effect ---
plot_batch <- ggplot(pca_plot_data_mirna, aes(x = PC1, y = PC2, color = Batch)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "B. Batch Effect Control", # Tytuł naukowy
    # subtitle usunięty - interpretacja "CZYSTO/BŁĄD" nie może być na wykresie
    x = paste0("PC1 (", variance_explained_miRNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_miRNA[2], "%)"),
    color = "Batch ID" # Nagłówek legendy
  ) +
  elsevier_theme
# Domyślna paleta kolorów jest OK, ale jeśli masz dużo batchy, 
# warto rozważyć scale_color_viridis_d() lub inną paletę dyskretną.

print(plot_batch)
```

WERYFIKACJA BIOLOGICZNA:

dane miRNA wykazują silnA zgodność biologiczną. Próbki nie są wymieszane
losowo – tworzą wyraźne grupy zgodne z podtypami raka piersi.

1.  Odseparowany podtyp Basal-like (Czerwone kropki):
    -   To jest najbardziej rzucająca się w oczy cecha wykresu. Próbki
        tworzą odrębny, zwarty klaster po lewej stronie wykresu.
    -   To idealnie pasuje do wiedzy medycznej oraz jest zgodne z
        heatmapą. Raki bazalne są molekularnie najbardziej odmienne od
        raków luminalnych.
2.  Blok Luminalny (Zielone i Fioletowe kropki):
    -   Próbki Luminal A oraz Luminal B grupują się razem po prawej
        stronie wykresu.
    -   To również jest poprawne. Oba te podtypy wywodzą się z komórek
        luminalnych i są ER-dodatnie (mają receptory estrogenowe). Są do
        siebie podobne genetycznie, więc na wykresie PCA leżą blisko
        siebie.
3.  HER2
    -   Te próbki są bardziej rozsypane i znajdują się w strefie
        pośredniej, co często obserwuje się w analizach dla tego
        podtypu.

KONTROLA BATCH EFFECT:

Wykres wygląda prawidłowo (próbki nie grupują się wg ośrodków badawczych
są rozrzucone wszędzie).

PODSUMOWANIE:

Analiza PCA wykazała brak istotnego efektu partii (Batch Effect) w
danych miRNA. Próbki grupują się zgodnie z biologią podtypów (PAM50), a
nie według ośrodków badawczych. Dane zostały uznane za technicznie
poprawne i zakwalifikowane do dalszej analizy różnicowej bez
konieczności korekcji algorytmem ComBat.

```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```

## Etap 3: Analiza Białek (Proteomika)

Celem analizy jest weryfikacja zgodności profili ekspresji białek z
klasyfikacją molekularną PAM50. Wykorzystujemy dane z macierzy RPPA,
które zostały wcześniej znormalizowane (Z-score).

```{r przygotowanie_bialek, include=FALSE}
# 1. Wybór markerów białkowych (korzystamy z kolumn _z utworzonych w etapie standaryzacji)
# Lista zgodna z wektorem 'bialka' z etapu wranglingu + suffix "_z"
protein_markers <- c(
  "eralpha_z", "pr_z", "her2_z", "egfr_mirnaprot_z", "p53_z", "pten_mirnaprot_z",
  "mek1_z", "bcl2_mirnaprot_z", "bax_z", "parpcleaved_z", "ecadherin_z",
  "ncadherin_z", "betacatenin_z", "brca1_z", "pdl1_z"
)

# 2. Weryfikacja czy kolumny istnieją w final_data
# Jeśli final_data nie jest w pamięci, upewnij się, że uruchomiłeś górne chunki
missing_proteins <- setdiff(protein_markers, colnames(final_data))
if(length(missing_proteins) > 0) {
  warning("Brakuje następujących kolumn białkowych: ", paste(missing_proteins, collapse = ", "))
}

# 3. Przygotowanie macierzy do heatmapy
# Wybieramy tylko białka i ID pacjenta
matrix_protein_only <- final_data[, protein_markers]
rownames(matrix_protein_only) <- final_data$id_1

# Transpozycja (Białka w wierszach, Pacjenci w kolumnach - wymagane przez pheatmap)
heatmap_matrix_protein <- t(matrix_protein_only)

# 4. Przygotowanie adnotacji (Pasek kolorów dla PAM50)
annotation_protein <- data.frame(PAM50 = final_data$brca_subtype_pam50)
rownames(annotation_protein) <- final_data$id_1

# 5. Sortowanie pacjentów wg podtypu (dla czytelności heatmapy)
kolejnosc_pacjentow_prot <- order(final_data$brca_subtype_pam50)
posortowane_id_prot <- final_data$id_1[kolejnosc_pacjentow_prot]

# Przeorganizowanie macierzy i adnotacji wg posortowanych ID
heatmap_matrix_protein_sorted <- heatmap_matrix_protein[, posortowane_id_prot]
annotation_protein_sorted <- annotation_protein[posortowane_id_prot, , drop = FALSE]
```

### Wizualizacja: Heatmapa ekspresji białek wg podtypów PAM50

Wykres przedstawia znormalizowaną ekspresję (Z-score) kluczowych białek
dla wszystkich pacjentek. Próbki zostały zgrupowane według podtypu
molekularnego (PAM50).

```{r heatmapa_bialka, fig.height=8, fig.width=10, include=FALSE}
pheatmap(
  heatmap_matrix_protein_sorted,
  
  # --- LOGIKA PRZETWARZANIA (BEZ ZMIAN) ---
  cluster_cols = FALSE,       # Nie klastrujemy kolumn (posortowane wg PAM50)
  cluster_rows = TRUE,        # Klastrujemy białka
  annotation_col = annotation_protein_sorted,
  show_colnames = FALSE,      # Ukrywamy ID pacjentów
  show_rownames = TRUE,       # Pokazujemy nazwy białek
  
  # --- FORMATOWANIE WIZUALNE (STANDARD ELSEVIER) ---
  
  # 1. Język angielski
  main = "Protein Expression Profile by PAM50 Subtype",
  
  # 2. Kolorystyka (Zachowana Twoja paleta RdYlBu - standard w onkologii)
  color = colorRampPalette(rev(brewer.pal(n = 11, name = "RdYlBu")))(100),
  breaks = seq(-2, 2, length.out = 100),
  
  # 3. Stylistyka do druku
  border_color = NA,          # Usunięcie siatki wokół komórek (kluczowe dla czytelności!)
  fontfamily = "sans",        # Arial/Helvetica
  fontsize = 10,              # Bazowa wielkość czcionki
  fontsize_row = 8,           # Zmniejszona czcionka wierszy (białek), żeby się mieściły
  
  # 4. Ustawienia legendy
  legend = TRUE,
  annotation_legend = TRUE,
  filename = "Figure2protein_Heatmap.pdf" # Sugeruję zapis do PDF (wektorowy) dla najwyższej jakości
)
```

Interpretacja biologiczna i weryfikacja z literaturą

Analiza heatmapy potwierdza, że klasyfikacja genomowa PAM50 znajduje
silne odzwierciedlenie w fenotypie białkowym guza. Obserwowane
klastrowanie próbek jest zgodne z wnioskami pracy "Comprehensive
comparison of molecular portraits between cell lines and tumors in
breast cancer", która wskazuje na wysoką zgodność między transkryptomem
a proteomem w głównych podtypach raka piersi.

Poniżej przedstawiono szczegółową weryfikację poszczególnych podtypów w
oparciu o literaturę referencyjną:

1.  Podtypy Luminalne (Luminal A vs Luminal B) Grupa luminalna
    charakteryzuje się nadekspresją receptorów hormonalnych (widoczne
    czerwone bloki dla eralpha_z i pr_z).

Luminal A: Próbki te wykazują najwyższą ekspresję ERα oraz białka BCL2,
co jest zgodne z charakterystyką przedstawioną w badaniu "A Comparison
of PAM50 Intrinsic Subtyping with Immunohistochemistry...". Kluczowym
wyróżnikiem jest tu niska proliferacja (niski poziom cyclinb1_z na
heatmapie). Jak wskazują Cheang et al. w pracy "Difference between
Luminal A and Luminal B Subtypes According to Ki-67...", to właśnie
niska aktywność mitotyczna najlepiej odróżnia ten podtyp od Luminal B.

Luminal B: W tej grupie obserwujemy wyraźny wzrost ekspresji Cykliny B1
(cyclinb1_z), mimo zachowanej ekspresji receptorów. Potwierdza to
wnioski z pracy "Luminal B Breast Cancer: Molecular Characterization,
Clinical Management, and Future Perspectives", definiujące Luminal B
jako podtyp o gorszym rokowaniu napędzanym przez deregulację cyklu
komórkowego.

2.  Podtyp HER2-Enriched (HER2-E) Analiza potwierdza, że podtyp ten jest
    napędzany przez nadekspresję i aktywację szlaku HER2.

Na heatmapie wiersz her2_z wykazuje silną nadekspresję. Jest to zgodne z
badaniem "HER2-Enriched Subtype and ERBB2 Expression in HER2-Positive
Breast Cancer...", które wykazuje, że podtyp HER2-E charakteryzuje się
najwyższą aktywnością szlaku kinazowego EGFR/HER2.

Dodatkowo obserwujemy nadekspresję białek z rodziny EGFR, co jest
charakterystyczne dla profilu opisanego w pracy "Molecular Features and
Survival Outcomes of the Intrinsic Subtypes Within Her2-Positive Breast
Cancer".

3.  Podtyp Bazalny (Basal-like / TNBC) Podtyp ten wyróżnia się brakiem
    ekspresji receptorów (ER-/PR-/HER2-) oraz unikalnym profilem
    sygnałowym.

W dolnej części heatmapy widoczna jest nadekspresja EGFR
(egfr_mirnaprot_z) oraz markerów bazalnych. Koreluje to z wynikami pracy
"Reverse phase protein array identification of triple-negative breast
cancer subtypes...", która identyfikuje nadekspresję EGFR jako kluczowy
biomarker w podtypach TNBC.

Wysoka ekspresja markerów naprawy DNA (np. parpcleaved_z) w tej grupie
odpowiada opisanej w literaturze "niestabilności genomowej"
charakterystycznej dla guzów bazalnych.

### Źródła i literatura referencyjna

Powyższa interpretacja biologiczna oraz weryfikacja podtypów została
opracowana na podstawie następujących artykułów naukowych:

-   **Ogólna zgodność transkryptomu i proteomu:**
    -   "Comprehensive comparison of molecular portraits between cell
        lines and tumors in breast cancer"
        (PMC5001206)](<https://pmc.ncbi.nlm.nih.gov/articles/PMC5001206/>)
-   **Podtypy Luminalne (A vs B) i rola Ki67/Cykliny B1:**
    -   "A Comparison of PAM50 Intrinsic Subtyping with
        Immunohistochemistry..." (AACR
        Journals)](<https://aacrjournals.org/clincancerres/article/16/21/5222/14349/A-Comparison-of-PAM50-Intrinsic-Subtyping-with>)
    -   "Difference between Luminal A and Luminal B Subtypes According
        to Ki-67..." (Cheang et al.,
        PMC4167319)](<https://pmc.ncbi.nlm.nih.gov/articles/PMC4167319/>)
    -   "Luminal B Breast Cancer: Molecular Characterization, Clinical
        Management, and Future Perspectives"
        (JCO)](<https://ascopubs.org/doi/10.1200/JCO.2013.54.1870>)
-   **Podtyp HER2-Enriched i aktywność szlaku:**
    -   "HER2-Enriched Subtype and ERBB2 Expression in HER2-Positive
        Breast Cancer..."
        (JNCI)](<https://academic.oup.com/jnci/article/112/1/46/5475264>)
    -   "Molecular Features and Survival Outcomes of the intrinsic
        Subtypes Within Her2-Positive Breast cancer" (UNC
        Lineberger)](<https://unclineberger.org/peroulab/wp-content/uploads/sites/1008/2015/04/HER2E-subtype-Prat-JNCI-2014.pdf>)
-   **Podtyp Bazalny (TNBC) i EGFR:**
    -   "Reverse phase protein array identification of triple-negative
        breast cancer subtypes..."
        (PMC5642571)](<https://pmc.ncbi.nlm.nih.gov/articles/PMC5642571/>)

### Weryfikacja efektu serii (Batch Effect)

W celu kontroli jakości danych przeprowadzono analizę PCA. Zgodnie z
wytycznymi dotyczącymi detekcji efektu serii, sprawdzamy, czy głównym
czynnikiem różnicującym próbki jest biologia (PAM50), czy pochodzenie
tkanki z różnych ośrodków (Tissue Source Site - TSS).

```{r pca_bialka_batch, fig.height=6, fig.width=14, include=FALSE}
library(ggplot2)
library(gridExtra) # Przydatne do ułożenia wykresów obok siebie

# --- 1. Wyciągnięcie Batch ID (LOGIKA BEZ ZMIAN) ---
# Kod TSS wskazuje na ośrodek pobierający materiał (np. 02 = MD Anderson)
final_data$Batch_ID <- sapply(strsplit(as.character(final_data$id_1), "-"), function(x) x[2])

# --- 2. Wykonanie PCA na macierzy białkowej (LOGIKA BEZ ZMIAN) ---
pca_result_prot <- prcomp(matrix_protein_only, center = TRUE, scale. = FALSE) 

# Obliczenie procentu wyjaśnianej wariancji dla osi
var_explained_prot <- round(summary(pca_result_prot)$importance[2, 1:2] * 100, 1)

# --- 3. Przygotowanie ramki danych do wykresu (LOGIKA BEZ ZMIAN) ---
pca_plot_data_prot <- data.frame(
  PC1 = pca_result_prot$x[, 1],
  PC2 = pca_result_prot$x[, 2],
  PAM50 = final_data$brca_subtype_pam50,
  Batch = final_data$Batch_ID
)

# --- DEFINICJA STYLU ELSEVIER ---
elsevier_theme <- theme_bw(base_size = 11, base_family = "sans") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "plain"),
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.key = element_blank()
  )

# --- 4. Wykres A: Weryfikacja Biologiczna (PAM50) ---
p1 <- ggplot(pca_plot_data_prot, aes(x = PC1, y = PC2, color = PAM50)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "A. Protein PCA: Biological Variation",  # Angielski tytuł
    # subtitle usunięty (przenosimy interpretację do podpisu ryciny)
    x = paste0("PC1 (", var_explained_prot[1], "%)"),
    y = paste0("PC2 (", var_explained_prot[2], "%)"),
    color = "Subtype"  # Angielski nagłówek legendy
  ) +
  scale_color_brewer(palette = "Set1") +
  elsevier_theme +
  theme(legend.position = "right") # Legenda z prawej jest standardem, ale "bottom" też akceptowalne

# --- 5. Wykres B: Kontrola Techniczna (TSS / Batch) ---
p2 <- ggplot(pca_plot_data_prot, aes(x = PC1, y = PC2, color = Batch)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "B. Protein PCA: Batch Effect Control",  # Angielski tytuł
    x = paste0("PC1 (", var_explained_prot[1], "%)"),
    y = paste0("PC2 (", var_explained_prot[2], "%)")
  ) +
  elsevier_theme +
  theme(legend.position = "none") # Ukrywamy legendę (zgodnie z Twoją decyzją)

# --- WYŚWIETLANIE ---
# Opcja 1: Wyświetl osobno
print(p1)
print(p2)

# Opcja 2 (Zalecana): Połącz w jedną rycinę
# library(patchwork)
p1 + p2
```

### Interpretacja Analizy Głównych Składowych (PCA) i ocena jakości danych

Przeprowadzona analiza PCA (Principal Component Analysis) pozwoliła na
redukcję wymiarowości wielowymiarowych danych proteomicznych do dwóch
głównych składowych (PC1 i PC2), wyjaśniających łącznie **37.6%**
całkowitej zmienności w zbiorze danych. Poniżej przedstawiono
interpretację wyników w kontekście weryfikacji biologicznej oraz
technicznej:

**1. Weryfikacja Biologiczna (Wykres Lewy)** Na wykresie kolorowanym wg
podtypów PAM50 obserwujemy wyraźną strukturę klastrowania, co
potwierdza, że **zmienność biologiczna dominuje nad szumem
technicznym**. \* **Separacja podtypu Bazalnego:** Pierwsza składowa
(PC1, 23.3% wariancji) najsilniej różnicuje podtyp Basal-like (kolor
czerwony) od podtypów Luminalnych. Jest to zgodne z oczekiwaniami, gdyż
nowotwory te wykazują fundamentalnie odmienny profil proteomiczny (brak
receptorów, wysoka niestabilność genomowa), co opisano w pracy
*"Comprehensive comparison of molecular portraits..."* (PMC5001206). \*
**Super-klaster Luminalny:** Podtypy Luminal A (niebieski) i Luminal B
(fioletowy) wykazują znaczne nakładanie się w przestrzeni PCA. Jest to
zjawisko oczekiwane w danych RPPA, ponieważ oba podtypy dzielą ekspresję
kluczowych receptorów (ER/PR), a różnice dotyczą głównie markerów
proliferacji, które mogą mieć mniejszą wagę w globalnej wariancji niż
status receptorowy.

**2. Kontrola Efektu Serii / Batch Effect (Wykres Prawy)** Wykres prawy
przedstawia próbki kolorowane według kodu TSS (Tissue Source Site -
laboratorium pobierające). **Brak widocznych artefaktów:** Zgodnie z
metodologią detekcji efektu serii opisaną w literaturze (Zhang et al.,
Akbani et al.), poszukujemy tzw. "izolowanych wysp" lub geometrycznych
klastrów specyficznych dla jednego ośrodka[. Na załączonym wykresie
obserwujemy równomierne wymieszanie próbek (tzw. "hairball pattern"),
gdzie punkty z różnych serii (kolorów) nakładają się na siebie.
**Dominacja biologii:** Brak wyraźnej separacji próbek według Batch ID
(przy jednoczesnej silnej separacji według PAM50) świadczy o tym, że
wariancja techniczna wynikająca z różnic w protokołach pobierania tkanek
jest pomijalna w stosunku do wariancji biologicznej.

**Wnioski końcowe:** Zgodnie z wytycznymi *"Assessment of batch effects
in TCGA gene expression data"* oraz brakiem wizualnych przesłanek o
występowaniu systematycznego błędu serii, **dane uznaje się za
technicznie poprawne**. Nie stwierdzono konieczności stosowania
algorytmów korekcyjnych (np. ComBat), które przy braku silnego efektu
serii mogłyby wprowadzić sztuczne zniekształcenia i usunąć istotny
sygnał biologiczny (zjawisko *over-correction*).

**Literatura referencyjna dla metodologii:** *PCA-Plus: Enhanced
principal component analysis with illustrative applications to batch
effects...* (PubMed: 38260566) *Assessment of batch effects in TCGA gene
expression data* (Zhang et al., MD Anderson)


```{r}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```


## Etap 2 - RNA


```{r markeryRNA_etap2}

    
 rna_markers <- c(
   'esr1',
   'pgr',
   'erbb2',
   'egfr_rna',
   'krt5',
   'krt14',
   'krt17',
   'foxa1',
   'gata3',
   'bcl2_rna',
   'cdh1',
   'vim',
   'cldn3',
   'cldn4',
   'cldn7',
   'mki67',
   'ccnd1',
   'myc',
   'tp53',
   'pik3ca',
   'akt1',
   'brca1',
   'brca2',
   'ar',
   'fgfr1',
   'krt18',
   'krt19',
   'muc1',
   'epcam',
   'snai1',
   'snai2',
   'zeb1',
   'zeb2',
   'twist1',
   'tgfbr2',
   'cd24',
   'cd44'
)


rna_markers_exist <- rna_markers[rna_markers %in% colnames(final_data)]
 if (length(rna_markers_exist) == 0) {
   stop("BŁĄD: Nnie znaleziono żadnych kolumn RNA w pliku")
 }
 cat("są", length(rna_markers_exist), "z", length(rna_markers), "oczekiwanych markerów RNA.\n\n")

```

# Macierz do heatmapy (RNA x pacjenci)


```{r macierzRNA_etap2}
matric_rna_only_rna <- final_data[, rna_markers]
```

```{r nazwypacjentow_RNA_etap2}
rownames(matric_rna_only_rna) <- final_data[[patient_id_col]]
```

```{r transpozycja_RNA_etap2}
heatmap_matrix_rna <- t(matric_rna_only_rna)
```

```{r pasekkolorow_RNA_etap2}
adn_rna <- data.frame(PAM50 = final_data[[pam50_col]])
rownames(adn_rna) <- final_data[[patient_id_col]]
```

```{r sortowaniewgpam50_RNA_etap2}
kolejnosc_pacjentow <- order(final_data[[pam50_col]])
posortowane_id <- final_data[[patient_id_col]][kolejnosc_pacjentow]
```

```{r RNA_etap2}
heatmap_matrix_sorted_rna <- heatmap_matrix_rna[, posortowane_id]
annotation_df_sorted_rna <- adn_rna[posortowane_id, , drop = FALSE]
```

```{r generowanie_RNA_etap2_heatmapa}
library(pheatmap)
library(RColorBrewer)

rna_heatmapa <- pheatmap(
  heatmap_matrix_sorted_rna,
  # scale = "row",        # Logika bez zmian (zakomentowane jak u Ciebie)
  cluster_cols = FALSE,
  cluster_rows = TRUE,
  annotation_col = annotation_df_sorted_rna,
  show_colnames = FALSE,
  show_rownames = TRUE,
  
  # --- JĘZYK ANGIELSKI ---
  main = "mRNA Expression Profile by PAM50 Subtype",
  
  # --- KOLORYSTYKA ---
  # Zachowujemy Twoją paletę i zakres 0-10
  color = colorRampPalette(rev(brewer.pal(n = 11, name = "RdYlBu")))(100),
  breaks = seq(0, 10, length.out = 100),  
  
  # --- FORMATOWANIE ELSEVIER ---
  border_color = NA,      # Usunięcie siatki dla czystości wydruku
  fontfamily = "sans",    # Standardowa czcionka (Arial/Helvetica)
  fontsize = 10,          # Bazowa wielkość tekstu
  fontsize_row = 8,       # Mniejsza czcionka dla nazw genów (zwiększ czytelność)
  legend = TRUE,          # Legenda skali
  
  # --- WYMIARY ---
  width = 10,
  height = 13,
  filename = "Figure_RNA_Heatmap.pdf" # Sugerowany zapis do PDF
)

print(rna_heatmapa)
```

**Analiza porównawcza profili ekspresji RNA: wizualizacja heatmapy a dane literaturowe**

### 1. Podtyp Basal (Zielony pasek na górze heatmapy)

* *Keratyny bazalne (*KRT5, KRT14, KRT17):**
    * *Heatmapa:* Widać intensywny *czerwony blok* (wysoka ekspresja) w kolumnach odpowiadających podtypowi Basal, podczas gdy w innych podtypach są one niebieskie (niska ekspresja).
    *Zgodność z artykułem :* Podtyp Basal charakteryzuje się wysoką ekspresją markerów bazalnych, w tym KRT5, KRT14 i KRT17, oraz niską ekspresją markerów luminalnych.
* *Receptory hormonalne (*ESR1, PGR, AR, FOXA1):**
    * *Heatmapa:* W sekcji Basal te geny są *ciemnoniebieskie*, co oznacza bardzo niską ekspresję lub jej brak.
    *  *Zgodność z artykułem :* Heatmapa wyraźnie stwierdza, że ekspresja ESR1, PGR, AR oraz FOXA1 jest najniższa w podtypie Basal    .
* *Proliferacja (*MKI67):**
    * *Heatmapa:* Widać przewagę kolorów żółtych/pomarańczowych (wysoka/średnia ekspresja), co odróżnia ten podtyp od Luminal A.
    *  *Zgodność z artykułem :* Potwierdza, że podtyp Basal wykazuje wysoką ekspresję genów cyklu komórkowego, w tym MKI67.
* *EGFR:*
    * *Heatmapa:* Gen egfr_rna wykazuje wyższą ekspresję (żółty/jasnoniebieski) w grupie Basal w porównaniu do głębokiego błękitu w grupach Luminalnych.
    *  *Zgodność z artykułem :* Wskazuje na wysoką ekspresję EGFR w podtypie Basal (choć zaznacza, że jest ona jeszcze wyższa w nowym podtypie HER2-low, który tu jest ukryty w innych grupach).

### 2. Podtyp HER2 (Różowy pasek)
Tutaj również widać silną korelację, zwłaszcza w przypadku genu definiującego tę grupę.

* *ERBB2 (HER2):*
    * *Heatmapa:* Można tutaj zauważyć bardzo wyraźny, *czerwony prostokąt* przy genie erbb2 tylko w tej grupie. Jest to najbardziej charakterystyczna cecha tej części wykresu.
    *  *Zgodność z artykułem :* Podtyp HER2-high (odpowiednik PAM50 HER2-enriched) wykazuje najwyższą ekspresję ERBB2.
* *Receptory hormonalne:*
    * *Heatmapa:* Ekspresja esr1 i pgr jest tu przeważnie niska (niebieska), choć wyższa niż w Basal.
    *  *Zgodność z artykułem :*Podtyp ten ma zazwyczaj niższą ekspresję receptorów hormonalnych niż podtypy Luminalne.

### 3. Różnicowanie Luminal A (Turkusowy) vs Luminal B (Fioletowy)
To jest najbardziej subtelna, ale kluczowa część analizy, gdzie heatmapa świetnie ilustruje niuanse opisane w artykule.

* *Receptory hormonalne i czynniki transkrypcyjne (*GATA3, FOXA1, ESR1):**
    * *Heatmapa:* Obie grupy (LumA i LumB) mają *bardzo intensywny czerwony kolor* dla tych genów.
    *  *Zgodność z artykułem :* Potwierdza to, opisując wysoką ekspresję GATA3, FOXA1 i ESR1 w obu podtypach luminalnych  .
* *Kluczowa różnica: Proliferacja (*MKI67):**
    * *Heatmapa:* Zwróć uwagę na rząd mki67. W grupie *LumA (Turkus)* jest on przeważnie *niebieski/jasnożółty* (niska ekspresja). W grupie *LumB (Fiolet)* staje się wyraźnie bardziej *żółty/pomarańczowy* (wyższa ekspresja).
    * *Zgodność z artykułem :* Jest to zgodne z główną tezą artykułu, Wyższa ekspresja genów cyklu komórkowego w LumB jest cechą różnicującą.
* *Receptor Progesteronowy (*PGR):**
    * *Heatmapa:* W LumA (Turkus) pgr jest często *czerwony/pomarańczowy* (wysoki). W LumB (Fiolet) widać więcej *niebieskich/jasnych* prążków (niższa ekspresja).
    *  *Zgodność z artykułem :* "PGR expression was higher in subtype LumA and showed a bimodal distribution in subtype LumB" (Ekspresja PGR była wyższa w podtypie LumA).

* *BCL2 (*bcl2_rna):**
    * *Heatmapa:* Wysoka ekspresja (czerwony) w LumA i LumB, niska w Basal i HER2.
    * *Zgodność z artykułem:* Zgodnie z artykułem  wymienia BCL2 na liście genów różnicujących, typowo kojarzonych z fenotypem luminalnym i lepszym rokowaniem, co widać na heatmapie.
    
* *AR (Receptor Androgenowy):*
    * *Heatmapa:* Widać nadekspresję w grupach Luminalnych (współwystępowanie z ER), ale też pewną aktywność w HER2. W Basal jest niebieski (brak).
    *  *Zgodność z artykułem :* Potwierdza, że AR jest współeksprymowany z ER w rakach HR+. Co ważne, Zgodność z artykułem  sugeruje, że AR jest wysoki w nowym podtypie HER2-low, którego tu wprost nie widzimy, ale jego brak w typowym Basal na heatmapie jest zgodny z danymi.

### Podsumowanie

1.  *Basal:* Wysokie keratyny bazalne, brak receptorów.
2.  *HER2:* Dominacja ERBB2.
3.  *Luminal A:* Wysokie hormony, niska proliferacja (MKI67).
4.  *Luminal B:* Wysokie hormony (ale PGR słabszy), wyższa proliferacja.

**Literatura:**

*The Breast Cancer Classifier refines molecular breast cancer classification to delineate the HER2-low subtype*. Dostępne na: https://www.nature.com/articles/s41523-025-00723-0


```{r}
pca_result_RNA <- prcomp(matric_rna_only_rna, center = TRUE, scale. = FALSE)
```

```{r}
variance_explained_RNA <- round(summary(pca_result_RNA)$importance[2, 1:2] * 100, 1)
```

```{r}
library(ggplot2)

# --- 1. Przygotowanie danych (LOGIKA BEZ ZMIAN) ---
pca_plot_data_rna <- data.frame(
  PC1 = pca_result_RNA$x[, 1],
  PC2 = pca_result_RNA$x[, 2],
  PAM50 = final_data[[pam50_col]],
  Batch = final_data$Batch_ID
)

# --- 2. Definicja stylu Elsevier (spójny z poprzednimi wykresami) ---
elsevier_theme <- theme_bw(base_size = 11, base_family = "sans") +
  theme(
    panel.grid.major = element_blank(),   # Usunięcie siatki głównej
    panel.grid.minor = element_blank(),   # Usunięcie siatki pomocniczej
    panel.border = element_rect(color = "black", fill = NA, size = 0.8), # Wyraźna ramka
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "plain"),
    plot.title = element_text(face = "bold", size = 11, hjust = 0), # Tytuł do lewej
    legend.key = element_blank()
  )

# --- 3. Wykres A: Weryfikacja Biologiczna (PAM50) ---
plot_bio_rna <- ggplot(pca_plot_data_rna, aes(x = PC1, y = PC2, color = PAM50)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "A. mRNA PCA: Biological Variation",  # Tytuł naukowy
    # subtitle usunięty (interpretacja w tekście artykułu)
    x = paste0("PC1 (", variance_explained_RNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_RNA[2], "%)"),
    color = "Subtype"  # Profesjonalny nagłówek legendy
  ) +
  elsevier_theme +
  scale_color_brewer(palette = "Set1") 

print(plot_bio_rna)


# --- 4. Wykres B: Kontrola Batch Effect ---
plot_batch_rna <- ggplot(pca_plot_data_rna, aes(x = PC1, y = PC2, color = Batch)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(
    title = "B. mRNA PCA: Batch Effect Control",  # Tytuł naukowy
    # subtitle usunięty
    x = paste0("PC1 (", variance_explained_RNA[1], "%)"),
    y = paste0("PC2 (", variance_explained_RNA[2], "%)"),
    color = "Batch ID"
  ) +
  elsevier_theme 
  # Opcjonalnie: Jeśli legendy jest za dużo (zbyt wiele ośrodków), odkomentuj poniższą linię:
  # + theme(legend.position = "none")

print(plot_batch_rna)
```

**Weryfikacja biologiczna klasyfikacji PAM50 na podstawie analizy PCA RNA**

Dane RNA wykazują silną zgodność biologiczną. Próbki nie są rozmieszczone losowo — tworzą wyraźne grupy zgodne z podtypami raka piersi według klasyfikacji PAM50.

**1.Odseparowany podtyp Basal-like**:

To najbardziej wyrazista cecha wykresu PCA. Próbki Basal tworzą zwarty, odrębny klaster w dolnej części wykresu. Jest to zgodne z wiedzą biologiczną — raki bazalne są molekularnie najbardziej odmienne od pozostałych podtypów. Ich separacja potwierdza trafność klasyfikacji.

**2.Blok Luminalny A i B**:

Próbki Luminal A i Luminal B grupują się razem w górnej części wykresu. To poprawne — oba podtypy wywodzą się z komórek luminalnych, są ER-dodatnie i genetycznie podobne, co skutkuje ich bliskim położeniem w PCA.

**3.HER2**:

Próbki HER2 są bardziej rozproszone i zajmują strefę pośrednią między Luminalnymi a Basal. Taki rozkład jest typowy — podtyp HER2-enriched często wykazuje cechy przejściowe i większą heterogeniczność.

**KONTROLA BATCH EFFECT:**
Wykres PCA wg ośrodków badawczych (kolory centrów) nie wykazuje żadnych niepokojących wzorców. Próbki są równomiernie rozproszone — nie tworzą odseparowanych klastrów zależnych od miejsca pozyskania materiału.

**PODSUMOWANIE:**

Analiza PCA potwierdza brak istotnego efektu partii (Batch Effect) w danych RNA. Próbki grupują się zgodnie z biologią podtypów PAM50, a nie według ośrodków badawczych. Dane zostały uznane za technicznie poprawne i zakwalifikowane do dalszej analizy różnicowej bez konieczności korekcji algorytmem ComBat.



# ETAP 3

## RNA

### Analiza różnicowa ekspresji RNA

```{r}

# Lista genów RNA
rna_features <- c(
   'esr1',
   'pgr',
   'erbb2',
   'egfr_rna',
   'krt5',
   'krt14',
   'krt17',
   'foxa1',
   'gata3',
   'bcl2_rna',
   'cdh1',
   'vim',
   'cldn3',
   'cldn4',
   'cldn7',
   'mki67',
   'ccnd1',
   'myc',
   'tp53',
   'pik3ca',
   'akt1',
   'brca1',
   'brca2',
   'ar',
   'fgfr1',
   'krt18',
   'krt19',
   'muc1',
   'epcam',
   'snai1',
   'snai2',
   'zeb1',
   'zeb2',
   'twist1',
   'tgfbr2',
   'cd24',
   'cd44'
)


valid_rna <- rna_features[rna_features %in% colnames(final_data)]
expr_matrix_rna <- t(final_data[, valid_rna])  # wiersze = geny, kolumny = pacjenci

group_list_rna <- factor(recode(final_data[[pam50_col]], 
                            "Basal-like" = "Basal", 
                            "Luminal A" = "LumA", 
                            "Luminal B" = "LumB",
                            "HER2-enriched" = "Her2"),
                     levels = c("Basal","LumA","LumB","Her2"))

 # Stworzenie macierzy modelu 
design <- model.matrix(~0 + group_list_rna + age_mean_years, data = final_data)
colnames(design) <- c(levels(group_list_rna), "Age")

```


```{r}

# Dopasowanie modelu limma
fit_rna <- lmFit(expr_matrix_rna, design)

# Definicja kontrastów (Basal vs LumA, Her2 vs LumA, LumB vs LumA) 
contrast_matrix_rna <- makeContrasts(
  Basal_vs_LumA = Basal - LumA,
  Her2_vs_LumA  = Her2 - LumA,
  LumB_vs_LumA  = LumB - LumA,
  levels = design

)

fit_rna <- contrasts.fit(fit_rna, contrast_matrix_rna)
fit_rna <- eBayes(fit_rna)
```

```{r}
library(ggplot2)
library(ggrepel)

generate_volcano_rna <- function(fit_obj, contrast_name, title_text) {
  # --- 1. Pobranie wyników (LOGIKA BEZ ZMIAN) ---
  results <- topTable(fit_obj, coef = contrast_name, number = Inf, adjust.method = "BH")
  results$RNA <- rownames(results)
  
  # --- 2. Klasyfikacja (LOGIKA BEZ ZMIAN) ---
  results$Significance <- "Not Sig"
  results$Significance[results$adj.P.Val < 0.05 & results$logFC > 0.5] <- "UP"
  results$Significance[results$adj.P.Val < 0.05 & results$logFC < -0.5] <- "DOWN"

  # --- 3. Zapis tabeli wyników (BEZ ZMIAN) ---
  # Zachowujemy Twoją nazwę pliku
  write.csv(results, paste0("Wyniki_RNA_Klaudia_", contrast_name, ".csv"), row.names = FALSE)

  # --- 4. Wykres (FORMATOWANIE ELSEVIER) ---
  p <- ggplot(results, aes(x = logFC, y = -log10(adj.P.Val), label = RNA)) +
    
    # Punkty: Zmniejszona przezroczystość dla nieistotnych, wyraźna dla istotnych
    geom_point(aes(color = Significance), alpha = 0.6, size = 1.8) +
    
    # Kolory: Klasyczny kontrast (Niebieski/Czerwony) na czystym tle
    scale_color_manual(values = c("DOWN" = "blue", "Not Sig" = "gray85", "UP" = "red")) +
    
    # Linie odcięcia: Cieńsze i czarne
    geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", color = "black", size = 0.4) +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", size = 0.4) +
    
    # Etykiety genów (ggrepel)
    geom_text_repel(
      data = subset(results, Significance != "Not Sig"), 
      max.overlaps = 25,    # Ograniczenie liczby etykiet dla czytelności
      box.padding = 0.4, 
      size = 3,             # Wielkość czcionki etykiet
      segment.size = 0.3    # Cieńsze linie łączące
    ) +
    
    # Tytuły i Osie (Angielski + Notacja Matematyczna)
    labs(
      title = title_text,
      subtitle = paste("Contrast:", contrast_name), # Angielski
      x = expression(log[2]~"Fold Change"),         # Profesjonalny zapis z indeksem dolnym
      y = expression(-log[10]~"(adj. P-value)"),    # Profesjonalny zapis
      color = "Regulation"                          # Tytuł legendy
    ) +
    
    # Temat Graficzny (Elsevier)
    theme_bw(base_size = 11, base_family = "sans") +
    theme(
      panel.grid.major = element_blank(),   # Usunięcie siatki
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "black", fill = NA, size = 0.8),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "plain"),
      plot.title = element_text(face = "bold", size = 11, hjust = 0),
      legend.position = "top"               # Legenda na górze oszczędza miejsce na boki
    )

  # --- 5. Zapis i wyświetlenie (BEZ ZMIAN) ---
  ggsave(paste0("RNA_Volcano_", contrast_name, ".png"), p, width = 8, height = 6, dpi = 300)
  print(p)
}

# --- Wywołanie funkcji (BEZ ZMIAN DANYCH WEJŚCIOWYCH) ---
# Zmieniłem tylko tytuły w wywołaniu na bardziej "oficjalne" (opcjonalnie)
generate_volcano_rna(fit_rna, "Basal_vs_LumA", "Differential Expression: Basal vs LumA")
generate_volcano_rna(fit_rna, "Her2_vs_LumA",  "Differential Expression: Her2 vs LumA")
generate_volcano_rna(fit_rna, "LumB_vs_LumA",  "Differential Expression: LumB vs LumA")

```

## Basal vs LumA

Analiza różnicowej ekspresji RNA pomiędzy podtypami **Basal-like** i **Luminal A** ujawnia głęboką molekularną dywergencję, odzwierciedlającą fundamentalne różnice w biologii nowotworu. Wykres wulkaniczny dla kontrastu **Basal_vs_LumA** wskazuje na silną nadekspresję genów związanych z proliferacją, deregulacją cyklu komórkowego oraz szlakami EMT w podtypie **Basal-like**.

W strefie wysokiej istotności statystycznej `(–log10 FDR > 1.3, log2FC > 0.5)` znajdują się geny takie jak **myc**, **mki67**, **snai1**, **egfr_rna**, **cd24**, **brca2**. Ich funkcje obejmują kontrolę mitozy, replikacji DNA, segregacji chromosomów oraz przejście przez fazę G2/M, co jednoznacznie wskazuje na intensyfikację proliferacji i niestabilność genomową.

Z kolei po stronie genów obniżonych w Basal-like `(log2FC < –0.5)` widoczne są klasyczne markery luminalne i hormonozależne: **foxa1**, **esr1**, **gata3**, **ar**, **pgr**, **bcl2_rna**, **krt18**, **krt19** czy **muc1**. Ich redukcja potwierdza utratę fenotypu zróżnicowanego nabłonkowo oraz przełączenie na szlaki wzrostowe niezależne od receptorów hormonalnych.

Zestawienie tych dwóch profili molekularnych ukazuje **Basal-like** jako podtyp o wysokim potencjale proliferacyjnym, inwazyjnym i opornym na klasyczne terapie hormonalne, w przeciwieństwie do  **Luminal A**, który zachowuje cechy różnicowania i homeostazy.

## HER2 vs LumA

Różnicowa analiza ekspresji RNA pomiędzy podtypami **HER2** i **Luminal A** ujawnia istotne zmiany w profilu transkrypcyjnym, które odzwierciedlają odmienne mechanizmy regulacji proliferacji, różnicowania oraz odpowiedzi terapeutycznej. Wykres wulkaniczny dla kontrastu **HER2** vs **LumA** ukazuje wyraźną dystrybucję genów o istotnie zmienionej ekspresji — z jednej strony geny nadekspresjonowane w **HER2** `(log2FC > 0.5, FDR < 0.05)`, z drugiej zaś geny obniżone względem **Luminal** `(log2FC < –0.5)`. Taka separacja wskazuje na molekularną odrębność podtypów i może mieć bezpośrednie przełożenie na ich fenotyp kliniczny oraz podatność na leczenie.

Podtyp **HER2** wykazuje istotną nadekspresję genów związanych z sygnalizacją receptorową i proliferacją, w tym **erbb2**, **epcam**, **cd24** oraz **brca1** i **brca2**. Nadekspresja **erbb2** potwierdza aktywację szlaków wzrostowych niezależnych od hormonów, takich jak PI3K–AKT i MAPK, typowych dla fenotypu HER2+. Obecność **epcam** i **cd24** wskazuje na zachowanie cech nabłonkowych i progenitorowych, co może sprzyjać inwazyjności i plastyczności komórek nowotworowych. Z kolei podwyższona ekspresja **brca1** i **brca2** może świadczyć o aktywacji mechanizmów naprawy DNA, choć ich funkcjonalność może być zaburzona w kontekście stresu genomowego.

W przeciwieństwie do tego, podtyp **Luminal A** charakteryzuje się wyższą ekspresją genów związanych z hormonozależnością i różnicowaniem, takich jak **esr1**, **pgr**, **bcl2_rna**, **gata3**, **tgfbr2**, **egfr_rna** oraz **cd44**. Obniżenie ich poziomu w **HER2** może wskazywać na utratę kontroli hormonalnej oraz przełączenie na alternatywne szlaki wzrostowe. Szczególnie istotna jest redukcja **esr1**, która koreluje z ograniczoną skutecznością klasycznej hormonoterapii w tym podtypie.

Obserwowane zmiany w ekspresji RNA potwierdzają molekularną odrębność **HER2** względem **Luminal A**. Geny takie jak **erbb2**, **cd24**, **epcam**, **esr1** i **pgr** mogą stanowić potencjalne biomarkery prognostyczne lub terapeutyczne, szczególnie w kontekście klasyfikacji molekularnej, stratyfikacji pacjentek oraz personalizacji leczenia.

## LumB vs LumA

Różnicowa analiza ekspresji RNA pomiędzy podtypami **Luminal B** i **Luminal A** ujawnia wyraźne przesunięcia w profilu molekularnym, wskazujące na odmienne mechanizmy biologiczne i potencjalne różnice kliniczne. Wykres wulkaniczny dla kontrastu **LumB** vs **LumA** pokazuje istotne zmiany w ekspresji genów, z wyraźną separacją pomiędzy genami nadekspresjonowanymi w LumB `(log2FC > 0.5, FDR < 0.05)` a tymi obniżonymi względem LumA `(log2FC < –0.5)`.

Podtyp **Luminal B** wykazuje istotną nadekspresję genów związanych z proliferacją i naprawą DNA, w tym **mk67**, **brca1**, **brca2** oraz **cdh1**. 
Wzrost poziomu **mki67** wskazuje na intensyfikację cyklu komórkowego, natomiast obecność **brca1/2** może świadczyć o aktywacji mechanizmów homologicznej rekombinacji. **Cdh1**, kodujący E-kadherynę, może pełnić rolę w zachowaniu adhezji komórkowej i struktury nabłonkowej, co w kontekście **LumB** może mieć znaczenie dla inwazyjności guza.

Z kolei **Luminal A** charakteryzuje się wyższą ekspresją genów związanych z różnicowaniem i stabilnością fenotypu luminalnego, takich jak **krt14**, **krt17**, **muc1**, **tgfbr2**, **egfr_rna**, **cd44** oraz **pgr**. Obniżenie ich poziomu w **LumB** może świadczyć o częściowej utracie cech hormonozależnych oraz przełączeniu na alternatywne szlaki wzrostowe, co koreluje z bardziej agresywnym przebiegiem klinicznym.

Obserwowane zmiany w ekspresji RNA potwierdzają molekularną odrębność **LumB** względem **LumA**. Geny takie jak **mki67**, **brca1**, **brca2**, **cdh1**, **krt14** czy **tgfbr2** mogą stanowić potencjalne biomarkery prognostyczne lub terapeutyczne, szczególnie w kontekście klasyfikacji molekularnej i personalizacji leczenia.

##Bibliografia
1. Perou CM, Sørlie T, Eisen MB, et al. *Molecular portraits of human breast tumours*. Nature. 2000; 406(6797):747–52.
2. Cancer Genome Atlas Network. *Comprehensive molecular portraits of human breast tumours*. Nature. 2012; 490(7418):61–70.
3. Prat A, Parker JS, Fan C, et al. *Concordance among gene-expression-based predictors for breast cancer*. N Engl J Med. 2010 ;363(2):131–40.
4. Zhao SG, Chen WS, Das R, et al. *Clinical and genomic implications of luminal and basal subtypes across carcinomas*. Clin Cancer Res. 2019; 25(8):2450–7.
5. Netanely D, Avraham A, Ben-Baruch A, et al. *Expression and methylation patterns partition luminal-A breast tumors into distinct prognostic subgroups*. Breast Cancer Res. 2016; 18:74.


## BIAŁKA

# Analiza różnicowa ekspresji białek (Differential Protein Expression Analysis)

## Cel i uzasadnienie badawcze

Celem niniejszego etapu jest identyfikacja białek, których poziomy
ekspresji różnicują poszczególne podtypy molekularne raka piersi.
Analiza koncentruje się na porównaniu agresywnego podtypu
**Basal-like**, podtypu **HER2-enriched** oraz **Luminal B** względem
grupy referencyjnej, którą stanowi podtyp **Luminal A**
(charakteryzujący się najlepszym rokowaniem).

Zidentyfikowanie różnic na poziomie proteomicznym pozwoli na wskazanie
aktywnych szlaków sygnałowych, co stanowi uzupełnienie klasyfikacji
opartej na ekspresji genów (PAM50) opisanej przez **The Cancer Genome
Atlas Network (2012)**.

## Metodyka

Analizę przeprowadzono na danych białkowych typu RPPA (Reverse Phase
Protein Array, Level 3). Do wyznaczenia białek różnicujących
(Differentially Expressed Proteins, DEPs) wykorzystano pakiet **limma**
(Linear Models for Microarray Data) w środowisku R (**Ritchie i wsp.,
2015**).

Mimo że metoda ta została pierwotnie opracowana dla mikromacierzy DNA,
zastosowanie estymacji Bayesowskiej (Empirical Bayes) pozwala na
stabilne szacowanie błędów standardowych również w proteomice
ilościowej, co zwiększa moc testów statystycznych przy ograniczonej
liczbie prób (**Kammers i wsp., 2015**).

Zastosowano model liniowy uwzględniający wiek pacjentki jako zmienną
zakłócającą (covariate), zgodnie ze wzorem:
$$Ekspresja \sim 0 + Podtyp + Wiek$$

Jako kryteria istotności statystycznej i biologicznej przyjęto: \*
Skorygowana wartość p (FDR - Benjamini-Hochberg) \< 0.05 \* Bezwzględna
wartość logarytmu krotności zmiany (\|logFC\|) \> 0.5

## Ocena Rozkładu Danych (Data QC)

Przed dopasowaniem modelu zweryfikowano rozkład danych wejściowych.
Metodyka *limma* zakłada, że dane posiadają rozkład zbliżony do
normalnego (skala logarytmiczna).

```{r protein_dist_check, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
library(ggplot2)
library(reshape2) # Potrzebne do funkcji melt
library(dplyr)

# --- 1. Logika przetwarzania danych (BEZ ZMIAN) ---
protein_data_raw <- df_clean %>%
  dplyr::select(where(is.numeric)) %>%
  dplyr::select(-matches("_z$")) %>%                  # Usuń przetworzone Z-score
  dplyr::select(-starts_with("hsa_")) %>%             # Usuń miRNA
  dplyr::select(-matches("id|age|days|year|stage|included|index|node|metastasis|grade")) # Usuń metadane

# --- 2. SPRAWDZENIE ROZKŁADU (BEZ ZMIAN LOGIKI) ---
set.seed(2025) # Powtarzalność
sample_proteins <- sample(names(protein_data_raw), 6)
melted_prot <- melt(protein_data_raw %>% dplyr::select(all_of(sample_proteins)))

# --- 3. Wizualizacja (STANDARD ELSEVIER) ---
p_dist <- ggplot(melted_prot, aes(x = value, fill = variable)) +
  # Styl: Dodano czarny kontur (color="black") dla lepszego odcięcia kształtów
  geom_density(alpha = 0.5, color = "black", size = 0.4) +
  
  # Kolorystyka: Paleta "Set2" jest łagodna dla oka i czytelna w druku
  scale_fill_brewer(palette = "Set2") +
  
  # Usunięcie lewitowania wykresu nad osią X
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  
  # Język Angielski i profesjonalne etykiety
  labs(title = "Protein Expression Distribution (Random Sample)", # Tytuł opisowy
       x = "Protein Expression Level",
       y = "Density",
       fill = "Protein ID") + # Czytelny nagłówek legendy
  
  # Temat graficzny Elsevier
  theme_bw(base_size = 11, base_family = "sans") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.8),
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black", face = "plain"),
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.position = "bottom",          # Legenda na dole
    legend.text = element_text(size = 9)
  )

print(p_dist)

# --- 4. Sprawdzenie zakresu (BEZ ZMIAN) ---
cat("Global Minimum:", min(protein_data_raw, na.rm=TRUE), "\n") # Przetłumaczone komunikaty w konsoli
cat("Global Maximum:", max(protein_data_raw, na.rm=TRUE), "\n")
```

Analiza wygenerowanego wykresu gęstości jednoznacznie potwierdza
założenia dotyczące rozkładu danych. Krzywe gęstości dla losowo
wybranych białek wykazują rozkład zbliżony do normalnego (symetryczny),
a wartości mieszczą się w wąskim zakresie (ok. -4 do +6).

Jest to charakterystyka typowa dla danych zlogarytmowanych
(log2-transformed) i znormalizowanych (Level 3 RPPA). Brak widocznej
skośności oraz niskie wartości liczbowe wskazują, że nie jest wymagana
dodatkowa transformacja logarytmiczna. Zastosowanie modelu liniowego
(limma) bezpośrednio na tych danych jest metodologicznie poprawne.

## Modelowanie Różnicowe (Limma)

Zdefiniowano macierz projektu (Design Matrix) oraz trzy kluczowe
kontrasty badawcze:

1.  Basal vs. Luminal A: Poszukiwanie markerów agresywności typu
    bazalnego.

2.  HER2 vs. Luminal A: Weryfikacja nadekspresji w amplikonie HER2.

3.  Luminal B vs. Luminal A: Analiza różnic w proliferacji wewnątrz
    grupy luminalnej.

```{r limma_execution, message=FALSE}
library(dplyr)
library(limma)
library(kableExtra)

# --- 1. PRZYGOTOWANIE DANYCH (LOGIKA BEZ ZMIAN) ---

# Tworzymy obiekt roboczy, wybierając konkretne kolumny z df_clean
limma_data <- df_clean %>%
  dplyr::select(
    Subtype = `BRCA_Subtype_PAM50`,               # Nazwa kolumny z podtypem
    Age = `age_at_initial_pathologic_diagnosis`,  # Nazwa kolumny z wiekiem
    everything()
  ) %>%
  filter(Subtype != "Normal") # Usunięcie tkanki normalnej

# SELEKCJA BIAŁEK
protein_data_final <- limma_data %>%
  dplyr::select(where(is.numeric)) %>%
  # Usuwamy kolumny kliniczne/techniczne
  dplyr::select(-matches("ID|Age|days|year|stage|vital|status|index|included|patient|tumor|cohort")) %>%
  # Usuwamy miRNA
  dplyr::select(-starts_with("hsa")) %>%
  # Usuwamy Z-score
  dplyr::select(-matches("_z$|_Z$"))

# --- 2. MODELOWANIE LIMMA (LOGIKA BEZ ZMIAN) ---

# Transpozycja: Wiersze=Białka, Kolumny=Pacjenci
exprs_matrix <- t(as.matrix(protein_data_final))

# Metadane dla modelu
clinical_meta <- limma_data %>%
  dplyr::select(Subtype, Age) %>%
  mutate(Subtype = factor(Subtype, levels = c("LumA", "LumB", "Her2", "Basal")))

# Sprawdzenie wymiarów
if(ncol(exprs_matrix) != nrow(clinical_meta)) stop("Błąd wymiarów macierzy!")

# Macierz projektu
design <- model.matrix(~ 0 + Subtype + Age, data = clinical_meta)
colnames(design) <- gsub("Subtype", "", colnames(design))

# Dopasowanie modelu
fit <- lmFit(exprs_matrix, design)

# KONTRASTY
contrasts_matrix <- makeContrasts(
  Basal_vs_LumA = Basal - LumA,
  Her2_vs_LumA  = Her2 - LumA,
  LumB_vs_LumA  = LumB - LumA,
  levels = design
)

# Obliczenia statystyczne
fit2 <- contrasts.fit(fit, contrasts_matrix)
fit2 <- eBayes(fit2)

# Funkcja zapisu
zapisz_bialka <- function(fit_obj, kontrast) {
  res <- topTable(fit_obj, coef = kontrast, number = Inf, adjust.method = "BH")
  res$Protein <- rownames(res)
  write.csv(res, paste0("Wyniki_Bialka_Piotr_", kontrast, ".csv"), row.names = FALSE)
}

zapisz_bialka(fit2, "Basal_vs_LumA")
zapisz_bialka(fit2, "Her2_vs_LumA")
zapisz_bialka(fit2, "LumB_vs_LumA")

# --- 3. WYNIKI ZBIORCZE I TABELA (ELSEVIER STYLE) ---

results_summary <- decideTests(fit2, method = "global", adjust.method = "BH", p.value = 0.05)
summary_matrix <- t(summary(results_summary))

# Konwersja do ramki danych
summary_table_wide <- as.data.frame(summary_matrix)

# Wizualizacja tabeli zgodnie ze standardem
kbl(summary_table_wide, 
    # Tytuł tabeli w języku angielskim
    caption = "Table 1. Number of Differentially Expressed Proteins (FDR < 0.05).", 
    booktabs = TRUE) %>% # Styl booktabs (standard naukowy: grubsze linie góra/dół, cieńsze w środku)
  
  # Formatowanie stylu Elsevier (czysty, bezszeryfowy)
  kable_classic(full_width = F, html_font = "Arial", font_size = 11) %>%
  
  # Kolorowanie wartości (zachowane dla czytelności, ale na białym tle)
  column_spec(1, color = "blue", bold = TRUE) %>%    # Down (Niebieski)
  column_spec(3, color = "red", bold = TRUE) %>%     # Up (Czerwony)
  column_spec(2, color = "gray50") %>%               # NotSig (Szary)
  
  # Formatowanie nagłówka (czarny tekst, pogrubiony, białe tło - standard druku)
  row_spec(0, bold = TRUE, color = "black", background = "white", extra_css = "border-bottom: 2px solid black;") %>%
  
  # Wyrównanie tabeli do lewej (częsty wymóg)
  kable_styling(position = "left")

```

Wstępna analiza wyników zestawiona w Tabeli XY wykazuje wyraźną
hierarchię odrębności molekularnej badanych podtypów, co potwierdza
poprawność przyjętych grup badawczych:

Największą liczbe zmian odnotowano w kontraście Basal-like vs. Luminal A
(łącznie 45 białek, w tym 27 obniżonych i 18 podwyższonych). Jest to
wynik oczekiwany, ponieważ rak bazalny (często TNBC) stanowi biologiczne
przeciwieństwo łagodnego, hormonozależnego raka Luminal A. Przewaga
białek o obniżonej ekspresji ("Down") sugeruje utratę cech luminalnych
(np. receptorów hormonalnych) w podtypie bazalnym.

Najmniejszą liczbę zmian zaobserwowano w kontraście Luminal B vs.
Luminal A (łącznie 29 białek). Wynika to z faktu, że oba podtypy należą
do tej samej rodziny nowotworów hormonozależnych (ER+), a różnią się
głównie aktywnością szlaków proliferacyjnych, co generuje węższy zestaw
białek różnicujących.

Kontrast HER2-enriched vs. Luminal A uplasował się pośrodku (38 zmian),
co odzwierciedla odrębną biologię napędzaną amplifikacją genu ERBB2,
przy jednoczesnym częściowym zachowaniu cech nabłonkowych.

Uzyskany rozkład liczbowy zmian (Basal \> HER2 \> LumB) jest zgodny z
dystansem molekularnym opisywanym w literaturze (TCGA Network, 2012) i
stanowi podstawę do szczegółowej identyfikacji biomarkerów w kolejnym
kroku.

## Wizualizacja Wyników (Volcano Plots)

W celu identyfikacji konkretnych białek odpowiedzialnych za obserwowane
różnice, sporządzono wykresy wulkaniczne (Volcano Plots). Oś X
reprezentuje siłę zmiany (log2 Fold Change), natomiast oś Y istotność
statystyczną (-log10 FDR).

```{r volcano_plots, fig.height=14, fig.width=10, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(tibble)
library(patchwork) # Biblioteka do układania paneli (operator /)

# Funkcja pomocnicza do rysowania wykresów
draw_volcano <- function(fit_obj, coef_name, title_text) {
  
  # --- 1. PRZETWARZANIE DANYCH (LOGIKA BEZ ZMIAN) ---
  res <- topTable(fit_obj, coef = coef_name, number = Inf) %>%
    rownames_to_column("Protein")
  
  # Kategoryzacja
  res <- res %>%
    mutate(Category = case_when(
      adj.P.Val < 0.05 & logFC > 0.5 ~ "Up",
      adj.P.Val < 0.05 & logFC < -0.5 ~ "Down",
      TRUE ~ "Not Sig"
    ))
  
  # Wybór etykiet (Top 12)
  top_labels <- res %>%
    filter(Category != "Not Sig") %>%
    arrange(adj.P.Val) %>%
    head(12) 
  
  # Liczniki do podtytułu
  n_up <- sum(res$Category == "Up")
  n_down <- sum(res$Category == "Down")
  
  # --- 2. GENEROWANIE WYKRESU (STANDARD ELSEVIER) ---
  p <- ggplot(res, aes(x = logFC, y = -log10(adj.P.Val), color = Category)) +
    
    # Punkty
    geom_point(alpha = 0.6, size = 1.5) +
    
    # Kolory: "Not Sig" zmieniony na grey80 (ciemniejszy) dla widoczności w druku
    scale_color_manual(values = c("Down" = "#377EB8", "Not Sig" = "grey80", "Up" = "#E41A1C")) +
    
    # Linie progowe (subtelne, czarne)
    geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", color = "black", alpha = 0.5, size = 0.4) +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", alpha = 0.5, size = 0.4) +
    
    # Inteligentne podpisy
    geom_text_repel(data = top_labels, aes(label = Protein), 
                    size = 3,           # Rozmiar czcionki etykiet (standard: 3-3.5)
                    max.overlaps = 25, 
                    box.padding = 0.4, 
                    min.segment.length = 0, # Zawsze rysuj linie łączące
                    color = "black", 
                    fontface = "plain") + # W publikacjach rzadko stosuje się pogrubienie wewnątrz wykresu
    
    # Etykiety i Tytuły (Angielski + Notacja Matematyczna)
    labs(title = title_text,
         # Profesjonalny format licznika w podtytule
         subtitle = paste0("Count: Up = ", n_up, " | Down = ", n_down),
         x = expression(log[2]~"Fold Change"),          # Indeks dolny 2
         y = expression(-log[10]~"(adj. P-value)")) +   # Indeks dolny 10
    
    # Temat Graficzny Elsevier (Clean & Crisp)
    theme_bw(base_size = 11, base_family = "sans") +
    theme(
      panel.grid.major = element_blank(),   # Usunięcie siatki
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "black", fill = NA, size = 0.8), # Wyraźna ramka
      legend.position = "none",             # Legenda ukryta (kolory są oczywiste: czerwony=góra, niebieski=dół)
      plot.title = element_text(face = "bold", size = 11, hjust = 0),
      plot.subtitle = element_text(size = 9, face = "italic", color = "grey30"),
      axis.title = element_text(color = "black", size = 10),
      axis.text = element_text(color = "black")
    )
  
  return(p)
}

# --- 3. GENEROWANIE I ŁĄCZENIE WYKRESÓW ---

p1 <- draw_volcano(fit2, "Basal_vs_LumA", "A. Basal-like vs. Luminal A")
p2 <- draw_volcano(fit2, "Her2_vs_LumA",  "B. HER2-enriched vs. Luminal A")
p3 <- draw_volcano(fit2, "LumB_vs_LumA",  "C. Luminal B vs. Luminal A")

# Złożenie wykresów w jeden panel wertykalny (wymaga biblioteki patchwork)
final_plot <- p1 / p2 / p3

# Wyświetlenie
print(final_plot)
```

## Opis wyników proteomicznych

Jakościowa analiza wykresów wulkanicznych (dodać nr rysunku) pozwala na
zinterpretowanie różnic ilościowych odnotowanych w Tabeli 3.1 i
przypisanie im konkretnego znaczenia biologicznego. Obserwowane profile
białkowe wykazują wysoką zgodność z kanoniczną taksonomią molekularną
raka piersi (**Perou i wsp., 2000; TCGA Network, 2012**).

**1. Fenotyp "Triple-Negative" i Proliferacja w podtypie Basal-like
(Wykres A)** Analiza kontrastu Basal vs. Luminal A (Ryc. 3.5A)
potwierdza drastyczną przebudowę aparatu komórkowego. \* **Utrata cech
luminalnych:** Najsilniej obniżonymi białkami (Down) są **ERALPHA**
(Receptor Estrogenowy), **PR** (Receptor Progesteronowy) oraz **GATA3**
(kluczowy czynnik transkrypcyjny komórek luminalnych). Potwierdza to, że
badane guzy Basal-like należą w większości do grupy potrójnie ujemnych
(TNBC). \* **Niekontrolowana proliferacja:** Po stronie nadekspresji
(Up) dominują kluczowe sterowniki cyklu komórkowego: **CYCLINB1**
(Cyklina B1) oraz **FOXM1**. Ich obecność tłumaczy wysoką agresywność
kliniczną tego podtypu i koreluje z wysokim indeksem mitotycznym
(Ki-67). \* **Marker inwazyjności:** Widoczna nadekspresja
**ANNEXIN-A1** jest charakterystyczna dla podtypu bazalnego i wiąże się
z procesem przejścia nabłonkowo-mezenchymalnego (EMT), co sprzyja
przerzutowaniu (**Swahely i wsp., 2020**).

**2. Amplikon 17q12 w podtypie HER2-enriched (Wykres B)** Wykres 3.5B
stanowi "biologiczną kontrolę jakości" całej analizy. \* **Dominacja
HER2:** Najbardziej istotnym statystycznie białkiem o podwyższonej
ekspresji jest **HER2** (ERBB2) oraz jego aktywna, ufosforylowana forma
**HER2_pY1248**. \* **Koekspresja GRB7:** Obok HER2, obserwujemy silną
nadekspresję białka **GRB7**. Jest to zgodne z literaturą, ponieważ gen
*GRB7* znajduje się w bezpośrednim sąsiedztwie genu *ERBB2* na
chromosomie 17q12 i często ulega współ-amplifikacji (**Saito i wsp.,
2012**).

**3. Proliferacyjna natura podtypu Luminal B (Wykres C)** Porównanie
Luminal B vs. Luminal A (Ryc. 3.5C) wyjaśnia, dlaczego ten podtyp ma
gorsze rokowanie, mimo że jest ER-pozytywny. \* **Tożsame tło, inna
dynamika:** W przeciwieństwie do podtypu Basal, tutaj nie obserwujemy
całkowitego zaniku receptorów (choć ERALPHA i BCL2 są lekko obniżone).
\* **Napęd komórkowy:** Kluczową różnicą jest nadekspresja cyklin
(**CYCLINB1**, **CYCLINE1**). Potwierdza to definicję kliniczną podtypu
Luminal B jako "Luminal A z wysoką proliferacją" (często definiowaną
przez marker Ki-67 \> 14% w histopatologii) (**Cheang i wsp., 2009**).

**Podsumowanie etapu:** Zidentyfikowane sygnatury białkowe (utrata ER/PR
w Basal, nadekspresja HER2/GRB7 w HER2+, wysokie cykliny w LumB)
jednoznacznie walidują poprawność danych. Stanowi to solidną podstawę do
analizy przeżycia, sugerując, że to właśnie te białka (zwłaszcza markery
proliferacji i receptory) będą kluczowymi determinantami czasu przeżycia
pacjentek.




## MIRNA

```{r}
mirna_features <- c(
  'hsa_mir_17',
  'hsa_mir_206',
  'hsa_mir_210',
  'hsa_mir_100',
  'hsa_mir_130a',
  'hsa_mir_27b',
  'hsa_let_7f_1',
  'hsa_let_7f_2',
  'hsa_mir_20a',
  'hsa_mir_34a',
  'hsa_mir_25',
  'hsa_mir_21',
  'hsa_mir_23b',
  'hsa_mir_29a',
  'hsa_mir_181d',
  'hsa_mir_203a',
  'hsa_mir_181c',
  'hsa_mir_155',
  'hsa_mir_205',
  'hsa_mir_10a',
  'hsa_let_7b',
  'hsa_mir_15a',
  'hsa_mir_134',
  'hsa_mir_200c'
)

valid_mirna <- mirna_features[mirna_features %in% colnames(final_data)]
expr_matrix <- t(final_data[, valid_mirna])  # wiersze = cechy, kolumny = pacjenci

group_list <- factor(recode(final_data[[pam50_col]], 
                            "Basal-like" = "Basal", 
                            "Luminal A" = "LumA", 
                            "Luminal B" = "LumB",
                            "HER2-enriched" = "Her2"),
                     levels = c("Basal","LumA","LumB","Her2"))

# --- POPRAWKA: CZYSTSZE NAZWY KOLUMN ---
design <- model.matrix(~0 + group_list + age_mean_years, data = final_data)
colnames(design) <- c(levels(group_list), "Age") 
```


```{r}
# ------------------------------------------------------------------------------
# KROK 3: Dopasowanie modelu limma
# ------------------------------------------------------------------------------
fit <- lmFit(expr_matrix, design)
# ------------------------------------------------------------------------------
# KROK 4: Definicja kontrastów
# ------------------------------------------------------------------------------
contrast_matrix <- makeContrasts(
  Basal_vs_LumA = Basal - LumA,
  Her2_vs_LumA  = Her2 - LumA,
  LumB_vs_LumA  = LumB - LumA,
  levels = design

)
fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2)
```


```{r}
library(ggplot2)
library(ggrepel)
library(limma)

# ------------------------------------------------------------------------------
# KROK 5: Funkcja do generowania volcano plotów (Standard Elsevier)
# ------------------------------------------------------------------------------
generate_volcano <- function(fit_obj, contrast_name, title_text) {
  
  # --- 1. PRZETWARZANIE DANYCH (LOGIKA BEZ ZMIAN) ---
  results <- topTable(fit_obj, coef = contrast_name, number = Inf, adjust.method = "BH")
  results$miRNA <- rownames(results)
  
  results$Significance <- "Not Sig"
  results$Significance[results$adj.P.Val < 0.05 & results$logFC > 0.5] <- "UP"
  results$Significance[results$adj.P.Val < 0.05 & results$logFC < -0.5] <- "DOWN"

  # --- 2. ZAPIS TABELI WYNIKÓW (LOGIKA BEZ ZMIAN) ---
  write.csv(results, paste0("Iza_Wyniki_", contrast_name, ".csv"), row.names = FALSE)
  # ------------------------------------

  # --- 3. GENEROWANIE WYKRESU (FORMATOWANIE ELSEVIER) ---
  p <- ggplot(results, aes(x = logFC, y = -log10(adj.P.Val), label = miRNA)) +
    
    # Punkty: Zmniejszono nieco rozmiar dla precyzji, kolory wysokiego kontrastu
    geom_point(aes(color = Significance), alpha = 0.6, size = 1.8) +
    
    # Kolory: Not Sig jako jasnoszary (gray85), Down/Up klasyczne
    scale_color_manual(values = c("DOWN" = "blue", "Not Sig" = "gray85", "UP" = "red")) +
    
    # Linie progowe: Cienkie, czarne, przerywane
    geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", color = "black", size = 0.4) +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", size = 0.4) +
    
    # Etykiety (ggrepel): Zwiększona czytelność
    geom_text_repel(
      data = subset(results, Significance != "Not Sig"), 
      max.overlaps = 50, 
      box.padding = 0.4, 
      size = 3,            # Rozmiar czcionki (standard ok. 3)
      segment.size = 0.3,  # Cieńsze linie łączące
      color = "black"
    ) +
    
    # Tytuły i Osie: Język angielski + Notacja matematyczna
    labs(
      title = title_text,
      subtitle = paste("Contrast:", contrast_name),   # Zmiana "Kontrast" na "Contrast"
      x = expression(log[2]~"Fold Change"),           # Indeks dolny 2
      y = expression(-log[10]~"(FDR)"),               # Indeks dolny 10
      color = "Regulation"                            # Tytuł legendy
    ) +
    
    # Temat graficzny: Czysty, bez siatki, czarne osie
    theme_bw(base_size = 11, base_family = "sans") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "black", fill = NA, size = 0.8),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "plain"),
      plot.title = element_text(face = "bold", size = 11, hjust = 0),
      legend.position = "top" # Legenda na górze (częsty wybór w ciasnych layoutach)
    )

  # --- 4. ZAPIS PLIKU (DODANO DPI) ---
  # Dodano dpi = 300 dla jakości drukarskiej
  ggsave(paste0("Iza_Volcano_", contrast_name, ".png"), p, width = 8, height = 6, dpi = 300)
  
  print(p)
}
```

### LumB vs LumA

Analiza różnicowa potwierdza odmienną biologię obu podtypów, wskazując na bardziej agresywny profil molekularny Luminal B. W podtypie tym zidentyfikowano istotną nadekspresję **miR-210** oraz **miR-17** (FDR < 0.05). Obecność **miR-210** wiąże się z odpowiedzią na hipoksję i adaptacją stresową, natomiast **miR-17** (członek klastra miR-17~92) promuje proliferację komórkową. Z kolei Luminal A charakteryzuje się wyższym poziomem miRNA o potencjale supresorowym, w tym **miR-100**, **miR-205** i **miR-181d**. Ich obecność koreluje z bardziej zróżnicowanym fenotypem, hamowaniem ścieżek wzrostowych oraz stabilnością genomową, co odzwierciedla łagodniejszy przebieg kliniczny LumA.

### HER2 vs LumA

Porównanie profilu ekspresji ujawniło przewagę onkomiR-ów w podtypie HER2, co jest zgodne z jego agresywną charakterystyką. Najsilniejszy sygnał nadekspresji w HER2 wykazują **miR-210** (kluczowy marker hipoksji) oraz **miR-155** i **miR-203a**, regulujące odpowiednio odpowiedź immunologiczną i procesy inwazyjne (EMT). W opozycji do tego, podtyp LumA wykazuje zachowaną, wyższą ekspresję uznanych supresorów nowotworowych, takich jak **let-7b**, **miR-100** oraz **miR-181d**. Obniżenie poziomu rodziny let-7 w guzach HER2 sugeruje utratę kontroli nad proliferacją, podczas gdy profil LumA wskazuje na utrzymanie mechanizmów homeostatycznych.

### Bazalny vs LumA

Analiza wykazała wysoce odrębny i agresywny profil molekularny podtypu Basal/TNBC. Dominującą cechą jest silna nadekspresja onkomiR-ów z rodziny **miR-17~92** (w szczególności **hsa-miR-17** i **hsa-miR-20a**), powiązanych ze szlakami MYC-zależnymi i szybką proliferacją. Istotnie podwyższone są również poziomy **hsa-miR-210** (mediator hipoksji) oraz immunomodulującego **hsa-miR-155**. Z kolei fenotyp bazalny charakteryzuje się znaczącym obniżeniem ekspresji **hsa-miR-10a** (log2FC < –1) oraz **miR-206**. Redukcja tych cząsteczek, pełniących funkcje regulatorowe i różnicujące, potwierdza deregulację procesów dojrzewania komórkowego charakterystyczną dla tego podtypu.

#### Bibliografia

1. Blenkiron C, Goldstein LD, Thorne NP, et al. MicroRNA expression profiling of human breast cancer identifies new markers of tumor subtype. *Genome Biol*. 2007;8(10):R214. doi:10.1186/gb-2007-8-10-r214
2. Iorio MV, Ferracin M, Liu CG, et al. MicroRNA gene expression deregulation in human breast cancer. *Cancer Res*. 2005;65(16):7065-7070. doi:10.1158/0008-5472.CAN-05-1783
3. Camps C, Buffa FM, Colella S, et al. hsa-miR-210 is induced by hypoxia and is an independent prognostic factor in breast cancer. *Clin Cancer Res*. 2008;14(5):1340-1348. doi:10.1158/1078-0432.CCR-07-1755
4. Volinia S, Calin GA, Liu CG, et al. A microRNA expression signature of human solid tumors defines cancer gene targets. *Proc Natl Acad Sci U S A*. 2006;103(7):2257-2261. doi:10.1073/pnas.0510565103
5. Mattiske S, Suetani RJ, Neilsen PM, Callen DF. The oncogenic role of miR-155 in breast cancer. *Cancer Epidemiol Biomarkers Prev*. 2012;21(8):1236-1243. doi:10.1158/1055-9965.EPI-12-0173
6. Petrelli A, Perra A, Schernhuber K, et al. miRNA-100 inhibits human breast cancer cell proliferation, invasion and migration/metastasis. *Oncotarget*. 2012;3(3):317. doi:10.18632/oncotarget.473

* **Podział na podtypy (LumA vs LumB vs Basal):** Blenkiron et al. (2007).
* **miR-210 (Hipoksja/Agresywność):** Camps et al. (2008) lub Blenkiron et al. (2007).
* **miR-17~92 (Proliferacja/Basal):** Volinia et al. (2006).
* **miR-155 (HER2/Immunologia):** Mattiske et al. (2012).
* **miR-100 (Supresor w LumA):** Petrelli et al. (2012).

## INTEGRACJA

```{r}
library(dplyr)
library(kableExtra)

# ==============================================================================
# INTEGRATION STEP: mRNA - Protein - miRNA
# ==============================================================================

# 1. MAPPING DICTIONARY (Gene <-> Protein)
# (Zachowana Twoja mapa)
mapa_gen_bialko <- data.frame(
  Gene = c("esr1", "pgr", "erbb2", "egfr_rna", "bcl2_rna", "mki67", "cdh1", "cd24", "cd44", "tp53", "ccnd1", "mys", "foxa1"),
  Protein = c("eralpha", "pr", "her2", "egfr", "bcl2", "mki67", "ecadherin", "cd24", "cd44", "p53", "cyclind1", "cmyc", "foxa1"),
  stringsAsFactors = FALSE
)

# 2. MAIN INTEGRATION FUNCTION
wykonaj_integracje <- function(kontrast) {
  
  message(paste("\n======================================================="))
  message(paste(">>> INTEGRATION FOR CONTRAST:", kontrast, "<<<"))
  message(paste("======================================================="))
  
  # --- A. LOAD CSV FILES ---
  tryCatch({
    rna <- read.csv(paste0("Wyniki_RNA_Klaudia_", kontrast, ".csv"))
    prot <- read.csv(paste0("Wyniki_Bialka_Piotr_", kontrast, ".csv"))
    mirna <- read.csv(paste0("Iza_Wyniki_", kontrast, ".csv"))
  }, error = function(e) {
    stop("Error: CSV files not found. Please run previous analysis steps first.")
  })

  # --- B. DATA PREPARATION (Filtering) ---
  # Selecting statistically significant features only
  
  # RNA: FDR < 0.05, |logFC| > 0.5
  rna_sig <- rna %>% 
    filter(adj.P.Val < 0.05 & abs(logFC) > 0.5) %>% 
    dplyr::select(Name = RNA, logFC_RNA = logFC, FDR_RNA = adj.P.Val) %>%
    mutate(JoinKey = tolower(Name)) 

  # PROTEIN: FDR < 0.05
  prot_sig <- prot %>% 
    filter(adj.P.Val < 0.05) %>% 
    dplyr::select(Name = Protein, logFC_Prot = logFC, FDR_Prot = adj.P.Val) %>%
    mutate(JoinKey = tolower(Name))

  # miRNA: FDR < 0.05, |logFC| > 0.5
  mirna_sig <- mirna %>% 
    filter(adj.P.Val < 0.05 & abs(logFC) > 0.5) %>% 
    dplyr::select(miRNA, logFC_miRNA = logFC, FDR_miRNA = adj.P.Val)

  # --- C. INTEGRATION 1: CONCORDANCE (RNA + PROTEIN) ---
  # Checking if mRNA change correlates with Protein change (Same Direction)
  
  # Map protein names to gene names
  prot_mapped <- prot_sig %>%
    left_join(mapa_gen_bialko, by = c("JoinKey" = "Protein")) %>%
    mutate(JoinKey = ifelse(!is.na(Gene), Gene, JoinKey)) 
  
  # Join tables
  zgodnosc <- rna_sig %>%
    inner_join(prot_mapped, by = "JoinKey") %>%
    # KEY CONDITION: Same sign of logFC
    filter(sign(logFC_RNA) == sign(logFC_Prot)) %>%
    dplyr::select(Gen = Name.x, Protein = Name.y, logFC_RNA, logFC_Prot) %>%
    arrange(desc(abs(logFC_RNA) + abs(logFC_Prot)))

  if(nrow(zgodnosc) > 0) {
    cat("\n[SUCCESS] Biologically consistent pairs found (Gene -> Protein):\n")
    # print(zgodnosc) # (Wyciszone, bo użyjemy tabeli Elsevier poniżej)
    write.csv(zgodnosc, paste0("Integracja_GenBialko_", kontrast, ".csv"), row.names = FALSE)
  } else {
    cat("\n[INFO] No consistent Gene-Protein pairs for this contrast.\n")
  }

  # --- D. INTEGRATION 2: miRNA REGULATION (miRNA -> Gene/Protein) ---
  # Searching for INVERSE correlation: miRNA Up -> Target Down
  
  
  # Create list of all targets
  targety <- bind_rows(
    rna_sig %>% dplyr::select(Target = Name, logFC_Target = logFC_RNA, Type = JoinKey) %>% mutate(Source="RNA"),
    prot_sig %>% dplyr::select(Target = Name, logFC_Target = logFC_Prot, Type = JoinKey) %>% mutate(Source="Protein")
  )
  
  if(nrow(mirna_sig) > 0 && nrow(targety) > 0) {
    # Brute-force correlation search
    regulacja <- expand.grid(miRNA = mirna_sig$miRNA, Target = targety$Target) %>%
      inner_join(mirna_sig, by = "miRNA") %>%
      inner_join(targety, by = "Target") %>%
      # CONDITION: Opposite signs
      filter(sign(logFC_miRNA) != sign(logFC_Target)) %>%
      arrange(desc(abs(logFC_miRNA) + abs(logFC_Target))) %>%
      head(15) 
    
    cat("\n[SUCCESS] Potential miRNA regulation (TOP 15 inverse pairs):\n")
    # print(regulacja) # (Wyciszone dla tabeli Elsevier)
    write.csv(regulacja, paste0("Integracja_Regulatory_", kontrast, ".csv"), row.names = FALSE)
  } else {
    cat("\n[INFO] No strong miRNA-Target correlations.\n")
  }
}

# --- URUCHOMIENIE (BEZ ZMIAN) ---
wykonaj_integracje("Basal_vs_LumA")
wykonaj_integracje("Her2_vs_LumA")
wykonaj_integracje("LumB_vs_LumA")

# --- FUNKCJE FORMATUJĄCE TABELE ---

format_concordance_table <- function(file_path, title) {
  if(!file.exists(file_path)) return(NULL)
  
  df <- read.csv(file_path)
  
  df %>%
    mutate(across(where(is.numeric), \(x) round(x, 2))) %>% # Zaokrąglenie liczb
    kbl(caption = title, booktabs = TRUE) %>%
    kable_classic(full_width = F, html_font = "Arial", font_size = 11) %>%
    column_spec(1, italic = TRUE) %>% # Geny kursywą
    column_spec(3:4, bold = TRUE) %>% # Wartości logFC pogrubione
    row_spec(0, bold = TRUE, color = "black", background = "white", extra_css = "border-bottom: 2px solid black;")
}

format_mirna_table <- function(file_path, title) {
  if(!file.exists(file_path)) return(NULL)
  
  df <- read.csv(file_path) %>%
    dplyr::select(miRNA, Target, Source, logFC_miRNA, logFC_Target) # Wybór kolumn
  
  df %>%
    mutate(across(where(is.numeric), \(x) round(x, 2))) %>%
    kbl(caption = title, booktabs = TRUE) %>%
    kable_classic(full_width = F, html_font = "Arial", font_size = 11) %>%
    column_spec(1, bold = TRUE) %>% # miRNA pogrubione
    column_spec(4, color = "#E41A1C") %>% # logFC miRNA (często czerwone/niebieskie)
    column_spec(5, color = "#377EB8") %>% # logFC Target
    row_spec(0, bold = TRUE, color = "black", background = "white", extra_css = "border-bottom: 2px solid black;")
}


# --- GENEROWANIE TABEL DLA KONTRASTÓW ---

# 1. Basal vs Luminal A
table_basal_concordance <- format_concordance_table(
  "Integracja_GenBialko_Basal_vs_LumA.csv", 
  "Table 2. Gene-Protein Expression Concordance (Basal vs LumA)"
)
table_basal_mirna <- format_mirna_table(
  "Integracja_Regulatory_Basal_vs_LumA.csv", 
  "Table 3. Top 15 Putative miRNA-Target Pairs (Inverse Correlation, Basal vs LumA)"
)

# Wyświetlenie wyników
# W RStudio te zmienne pojawią się w panelu Viewer jako sformatowane tabele
if(!is.null(table_basal_concordance)) print(table_basal_concordance)
if(!is.null(table_basal_mirna)) print(table_basal_mirna)

# (Analogicznie można wywołać dla Her2 i LumB)


# ==============================================================================
# 2. KONTRAST: HER2-enriched vs Luminal A
# ==============================================================================

# Tabela zgodności Gen-Białko
table_her2_concordance <- format_concordance_table(
  "Integracja_GenBialko_Her2_vs_LumA.csv", 
  "Table 4. Gene-Protein Expression Concordance (Her2 vs LumA)"
)

# Tabela regulacji miRNA
table_her2_mirna <- format_mirna_table(
  "Integracja_Regulatory_Her2_vs_LumA.csv", 
  "Table 5. Top 15 Putative miRNA-Target Pairs (Inverse Correlation, Her2 vs LumA)"
)

# Wyświetlenie (jeśli wyniki istnieją)
if(!is.null(table_her2_concordance)) print(table_her2_concordance) else message("Brak wyników zgodności dla Her2.")
if(!is.null(table_her2_mirna)) print(table_her2_mirna) else message("Brak wyników miRNA dla Her2.")


# ==============================================================================
# 3. KONTRAST: Luminal B vs Luminal A
# ==============================================================================

# Tabela zgodności Gen-Białko
table_lumb_concordance <- format_concordance_table(
  "Integracja_GenBialko_LumB_vs_LumA.csv", 
  "Table 6. Gene-Protein Expression Concordance (LumB vs LumA)"
)

# Tabela regulacji miRNA
table_lumb_mirna <- format_mirna_table(
  "Integracja_Regulatory_LumB_vs_LumA.csv", 
  "Table 7. Top 15 Putative miRNA-Target Pairs (Inverse Correlation, LumB vs LumA)"
)

# Wyświetlenie
if(!is.null(table_lumb_concordance)) print(table_lumb_concordance) else message("Brak wyników zgodności dla LumB.")
if(!is.null(table_lumb_mirna)) print(table_lumb_mirna) else message("Brak wyników miRNA dla LumB.")

```


## BASAL vs LUM A

## **1. Integracyjna analiza ekspresji wykazuje głęboką supresję programu luminalnego w podtypie Basal-like**

Analiza różnicowej ekspresji (RNA + proteom) wykazała masywną i spójną supresję kluczowych regulatorów programu luminalnego, w tym **FOXA1**, **ESR1** oraz **GATA3**. Obniżenie ekspresji tych czynników transkrypcyjnych było konsekwentne zarówno na poziomie transkryptów (logFC –5.6 do –5.8), jak i białek (logFC –5.6 do –5.8), co jednoznacznie wskazuje na **utracony fenotyp luminalny i hormonalnie niezależny charakter komórek Basal-like**.

Towarzyszący temu spadek **PGR** i **BCL2**, znanych genów zależnych od ER, dodatkowo potwierdza głębokie wyciszenie osi estrogenowej, typowe dla **triple-negative / Basal-like breast cancer (TNBC)**.

## **2. Profil proliferacyjny typu Basal determinowany jest przez aktywację MYC i markerów cyklu komórkowego**

Geny proliferacyjne, w tym **MKI67** oraz **MYC**, wykazywały wysoki poziom ekspresji zarówno na poziomie RNA, jak i białek. Jest to charakterystyczne dla wysoko proliferujących podtypów TNBC, w szczególności klasy **Basal-like 1 (BL1)** według klasyfikacji Lehmann et al., i wskazuje na utrzymanie programu pro-proliferacyjnego kosztem różnicowania luminalnego.

## **3. Aktywacja EGFR potwierdza charakterystyczną sygnaturę sygnałową Basal-like**

Wyniki wykazały wyraźną nadekspresję **EGFR** (RNA i białko), co stanowi kluczowy element biologii Basal-like. EGFR jest jednym z najlepiej udokumentowanych driverów TNBC i odpowiada za aktywację szlaków MAPK/PI3K, promujących wzrost, przeżycie i migrację komórek nowotworowych. Równocześnie zarejestrowano brak aktywacji **ERBB2**, co potwierdza brak cech podtypu Her2-enriched i wzmacnia precyzyjne odróżnienie fenotypów Basal i Luminal A.

## **4. Analiza regulacyjna ujawnia spójny moduł miRNA odpowiedzialny za wyciszenie osi ESR1–FOXA1**

Regulacyjna analiza miRNA wykazała, że **cztery wysoko aktywowane miRNA** – **miR-210**, **miR-17**, **miR-20a** oraz **miR-155** – kierują swoje działanie na dwa centralne regulacyjne węzły: **FOXA1** i **ESR1**.

Dla każdego z tych miRNA zaobserwowano:

* bardzo wysoką nadekspresję (logFC 1.4–2.4, FDR < 10⁻³³),
* równoległą supresję obu targetów na poziomie RNA,
* oraz całkowicie zgodne tłumienie na poziomie białkowym.

### **4.1. Wspólna oś miRNA → FOXA1/ESR1 jako kluczowy mechanizm Basal-like**

Wszystkie cztery miRNA wykazywały identyczny kierunek działania:

| miRNA       | logFC | Target       | logFC Target (RNA) | logFC Target (Protein) |
| ----------- | ----- | ------------ | ------------------ | ---------------------- |
| **miR-210** | +2.42 | FOXA1 / ESR1 | ~ –5.7             | ~ –5.6                 |
| **miR-17**  | +2.15 | FOXA1 / ESR1 | ~ –5.7             | ~ –5.6                 |
| **miR-20a** | +1.89 | FOXA1 / ESR1 | ~ –5.7             | ~ –5.6                 |
| **miR-155** | +1.42 | FOXA1 / ESR1 | ~ –5.7             | ~ –5.6                 |

Ta wyjątkowa spójność sugeruje istnienie **regulacyjnej osi, w której jednoczesna aktywacja kilku miRNA prowadzi do skoordynowanego wyciszenia kluczowych regulatorów luminalnych**.

### **4.2. Funkcjonalne znaczenie: całkowita destabilizacja programu luminalnego**

* **FOXA1** jest głównym pionierowym czynnikiem transkrypcyjnym umożliwiającym wiązanie ERα do chromatyny.
* **ESR1** koduje receptor estrogenowy ERα, definiujący podtyp Luminal A.

Jednoczesne wyciszenie obu tych genów na skutek koaktywacji wielu miRNA prowadzi do:

* dezorganizacji architektury epigenetycznej,
* zaniku odpowiedzi hormonalnej,
* utraty zdolności różnicowania luminalnego,
* przejścia w stronę fenotypu **ER–/PR– Basal-like**.

Mechanizm ten jest zgodny z literaturą, w której miR-155 i miR-17/20a są dobrze opisanymi negatywnymi regulatorami szlaków różnicowania w raku piersi.

## **5. Integracja danych miRNA–mRNA–proteom wskazuje na silnie konserwowany mechanizm post-transkrypcyjnego wygaszania ESR1 i FOXA1 w Basal-like**

Wyniki wykazują wyjątkową zgodność trzech warstw danych:

1. **miRNA** – silnie ↑
2. **mRNA (RNA-seq)** – silnie ↓
3. **białka (RPPA)** – silnie ↓

Ta trójwarstwowa koherencja potwierdza, że w komórkach Basal-like dominującym procesem napędzającym różnicowanie w kierunku TNBC jest **post-transkrypcyjne blokowanie osi ESR1–FOXA1 przez pakiet onkogennych miRNA**.

## **6. Charakter podtypu Basal-like w badanym modelu**

Wszystkie uzyskane dane – miRNA, transkryptom, proteom – wskazują na profil najbardziej zgodny z:

### **Basal-like 1 (BL1)**

* wysoka proliferacja (MKI67, MYC ↑),
* utrata szlaku hormonalnego (ESR1/FOXA1/GATA3 ↓),
* aktywacja EGFR,
* niska ekspresja EMT markerów (SNAI1 ↓),
* dominująca regulacja post-transkrypcyjna przez miRNA.

---

# **Wniosek końcowy**

Integracja analiz różnicowej ekspresji i regulacji post-transkrypcyjnej wykazuje, że podtyp Basal-like charakteryzuje się **skojarzoną aktywacją modułu miRNA (miR-210, miR-17, miR-20a, miR-155)**, który kieruje silne hamowanie dwóch kluczowych markerów luminalnych – **FOXA1** i **ESR1**. Tłumienie tych regulatorów jest widoczne zarówno na poziomie mRNA, jak i białka i towarzyszy mu wysoka proliferacja oraz aktywacja EGFR. Wyniki wskazują na **post-transkrypcyjne przeprogramowanie fenotypu luminalnego w kierunku Basal-like**, zgodne z charakterystyką agresywnych nowotworów piersi typu TNBC.

---


## Her2 vs LumA

**Background:**
Podtyp HER2-dodatni raka piersi charakteryzuje się amplifikacją genu *ERBB2*, wysoką proliferacją oraz utratą markerów luminalnych, jednak mechanizmy regulacyjne integrujące warstwy transkryptomiczne, proteomiczne i miRNA pozostają nie w pełni poznane. Zastosowanie podejścia multi-omicznego pozwala lepiej zrozumieć biologiczną spójność sygnatur molekularnych oraz zidentyfikować kluczowe osie regulacyjne wpływające na fenotyp HER2-enriched.

**Methods:**
Przeprowadzono analizę różnicową ekspresji RNA-seq, proteomiki RPPA oraz miRNA dla kontrastu HER2 vs Luminal A. Zintegrowano dane w dwóch etapach: (i) zgodność ekspresji RNA–białko w celu identyfikacji stabilnych sygnatur molekularnych oraz (ii) analiza miRNA–target z wykorzystaniem zależności odwrotnych logFC, aby wskazać potencjalne regulatory posttranskrypcyjne.

**Results:**
Integracja RNA–białko wykazała wysoce spójną nadekspresję kluczowych markerów podtypu HER2, w tym *ERBB2/HER2*, *MKI67*, *EPCAM* i *CDH1*, przy jednoczesnej wyraźnej supresji sygnatur luminalnych, takich jak *ESR1*, *PGR*, *GATA3*, *FOXA1* i *BCL2*. Obniżenie ekspresji keratyn *KRT5*, *KRT14* i *KRT17* potwierdza brak fenotypu basal-like w badanej kohorcie. Analiza miRNA wykazała silną nadekspresję onkogennych miRNA, przede wszystkim **miR-210**, **miR-155** i **miR-203a**, które konsekwentnie celują w *ESR1*, *PGR* i *BCL2*. Zależności te odzwierciedlają biologicznie spójną odwrotną regulację i sugerują, że te miRNA odgrywają kluczową rolę w wygaszaniu sygnatur luminalnych oraz w utrwalaniu fenotypu ER−/PR− charakterystycznego dla HER2-enriched. Szczególnie **miR-210**, powiązany z hipoksją i aktywacją HIF-1α, reprezentuje dominującą oś regulacyjną modulującą odpowiedź komórkową w nowotworach HER2+.

**Conclusions:**
Analiza multi-omiczna ujawnia wysoką spójność biologiczną pomiędzy warstwami RNA i białka oraz identyfikuje krytyczne miRNA napędzające fenotyp HER2-dodatni. Odkrycia te podkreślają znaczenie osi miR-210/155/203a → *ESR1/PGR/BCL2* w remodelowaniu programu luminalnego i podkreślają wartość integracji wielowarstwowych danych omicznych dla zrozumienia molekularnej architektury raka piersi HER2+. Wyniki dostarczają nowych podstaw do dalszych badań translacyjnych nad celowaniem w regulatory miRNA w terapii HER2-zależnych nowotworów.

### Wersja na brudno:

**1. Analiza zgodności ekspresji (RNA vs Białko)**
Dane wykazują wysoką spójność między poziomem transkryptomu a proteomu, potwierdzając klasyczny profil molekularny podtypu HER2-enriched:

* **Markery podwyższone (zgodnie RNA i białko):**
    * **ERBB2 (HER2):** Silna nadekspresja potwierdzająca status HER2+.
    * **MKI67:** Wysoki poziom wskazuje na znaczną aktywność proliferacyjną.
    * **Markery epitelialne (EPCAM, CDH1, CD24):** Zachowany fenotyp nabłonkowy, brak cech mezenchymalnych.
* **Markery obniżone (zgodnie RNA i białko):**
    * **Sygnatura luminalna (ESR1, PGR, GATA3, FOXA1, BCL2):** Drastyczny spadek, co definiuje status kliniczny ER-/PR-.
    * **Sygnatura basal-like (KRT5, KRT14, KRT17):** Niska ekspresja wyklucza podtyp bazalny.
* **Uwaga:** Obniżony poziom MYC jest nietypowy dla klasycznego modelu, ale nie podważa głównej diagnozy (możliwa specyfika kohorty).

**2. Analiza regulacji miRNA**
Zaobserwowano wyraźny mechanizm represji potranskrypcyjnej. Nadekspresja konkretnych miRNA koreluje z wyciszeniem ich genów docelowych:

* **Kluczowe miRNA (Up-regulated):** miR-210 (marker hipoksji), miR-155, miR-203a.
* **Geny docelowe (Down-regulated):** ESR1, PGR, BCL2.
* **Wniosek mechanistyczny:** Wysoki poziom miR-210 i miR-155 odpowiada za aktywną supresję receptorów hormonalnych (utrata fenotypu luminalnego) oraz promocję agresywności guza.

**3. Podsumowanie**
Wyniki są w pełni wiarygodne biologicznie i spójne z bazami referencyjnymi (TCGA, METABRIC). Profil jednoznacznie wskazuje na podtyp HER2-enriched charakteryzujący się:
1.  Amplifikacją szlaku HER2.
2.  Utratą ekspresji receptorów estrogenowych/progesteronowych (mechanizm zależny od miRNA).
3.  Wysokim potencjałem proliferacyjnym.


## LumB vs LumA


# **1. Luminal B zachowuje program luminalny, ale wykazuje silnie nasilony program proliferacyjny**

Integracyjna analiza RNA i proteomu wykazała, że podtyp Luminal B utrzymuje epitelialno-luminalny fenotyp komórek, co potwierdza **wysoka i zgodna ekspresja CDH1** oraz brak aktywacji szlaków EGFR. Równocześnie obserwujemy **silne podwyższenie MKI67** na poziomie transkryptu i białka, co jednoznacznie wskazuje na **wysokopro­liferacyjny charakter LumB**, stanowiący główną biologiczną różnicę względem LumA.

# **2. Częściowe wyciszenie osi hormonalnej: spadek PGR regulowany przez miR-210**

W odróżnieniu od Basal, LumB nie traci całego programu luminalnego, lecz wykazuje **selektywną redukcję receptora progesteronowego (PGR)**. Spadek ten jest zgodny w RNA i proteomie, a analiza regulacyjna wykazała, że **miR-210 jest kluczowym miRNA odpowiedzialnym za jego post-transkrypcyjne tłumienie** (miR-210 ↑, PGR ↓). To częściowe osłabienie sygnału ER-zależnego wpisuje się w kliniczny obraz LumB: ER+, ale PR-niższy i bardziej agresywny.

# **3. Zgodna supresja keratyn KRT5/KRT14/KRT17 – aktywna ochrona fenotypu luminalnego przez miR-210 i miR-17**

Trzy keratyny typowe dla fenotypu bazalnego (KRT5, KRT14, KRT17) są silnie obniżone zarówno na poziomie mRNA, jak i białek (logFC ~ –2.5 do –2.9).
Co ważne, **miR-210 i miR-17 tworzą spójny moduł regulacyjny**, który kieruje się właśnie przeciwko tym keratynom.
Sugeruje to, że LumB utrzymuje swój luminalny charakter **aktywnym mechanizmem wyciszania sygnatury bazalnej**, w przeciwieństwie do Basal-like, gdzie keratyny te są bardzo wysoko.

# **4. Wygaszanie MUC1 jako subtelna modulacja luminalnej sygnatury**

MUC1 wykazuje umiarkowaną, ale konsekwentną redukcję, również regulowaną przez miR-210. Może to odzwierciedlać **osłabienie klasycznego sygnału MUC1–ERα**, typowe dla bardziej agresywnych form ER+.

# **5. Integracja danych miRNA–RNA–proteom wskazuje na dwa kluczowe procesy definiujące LumB**

**(i) Utrzymanie fenotypu luminalnego**
– aktywne tłumienie keratyn bazalnych przez miR-210 i miR-17
– zachowana ekspresja CDH1
– brak aktywacji EGFR

**(ii) Wzrost proliferacji kosztem częściowego obniżenia sygnału hormonalnego**
– MKI67 ↑↑
– PGR ↓ (miR-210-zależnie)

Ta trójwarstwowa koherencja (miRNA → RNA → białko) pokazuje, że **Luminal B nie odchodzi od osi luminalnej, lecz staje się jej bardziej agresywnym wariantem**, napędzanym przez proliferację i modulację sygnału ER/PR, a nie przez przejście w stronę fenotypu bazalnego.

# Etap 4


## Podział zbioru danych na podtypy

```{r}

lumA_data <- subset(final_data, brca_subtype_pam50 == "LumA") 
lumB_data <- subset(final_data, brca_subtype_pam50 == "LumB") 
HER2_data <- subset(final_data, brca_subtype_pam50 == "Her2") 
basal_data <- subset(final_data, brca_subtype_pam50 == "Basal") 

```





## Wizualizacje



```{r}

# ------------------------------------------------------------------------------ ------------------------------------------------------------------------------ ------------------------------------------------------------------------------ ------------------------------------------------------------------------------ ------------------------------
library(survival)
library(survminer)
library(dplyr)

# ------------------------------------------------------------------------------
# 1. FUNKCJA GENERUJĄCA WYKRESY (STANDARD ELSEVIER)
# ------------------------------------------------------------------------------
plot_km_survival <- function(data, marker_col, title_suffix = "") {
  
  # --- LOGIKA OBLICZEŃ (BEZ ZMIAN) ---
  mediana <- median(data[[marker_col]], na.rm = TRUE)
  
  data_km <- data %>%
    mutate(Expression_Group = ifelse(.data[[marker_col]] > mediana, "HIGH", "LOW"))
  
  fit <- survfit(Surv(time_to_event, event) ~ Expression_Group, data = data_km)

  # --- WIZUALIZACJA (STANDARD ELSEVIER) ---
  ggsurvplot(
    fit,
    data = data_km,
    
    # Statystyka
    pval = TRUE,             
    pval.size = 5,
    conf.int = TRUE,         
    conf.int.alpha = 0.1,    
    
    # Tabela ryzyka
    risk.table = TRUE,       
    risk.table.col = "strata", 
    risk.table.height = 0.25,
    fontsize = 3.5,              # Mniejsza czcionka w tabeli dla czytelności w panelach
    
    # Stylistyka
    palette = c("#E41A1C", "#377EB8"), # Profesjonalny Czerwony / Niebieski
    
    # Język Angielski
    title = paste("Survival:", marker_col, title_suffix),
    xlab = "Time (days)",
    ylab = "Survival Probability",
    legend.title = "Expression",
    legend.labs = c("HIGH", "LOW"),
    
    # Temat graficzny (Czysty)
    ggtheme = theme_bw() + theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      axis.line = element_line(color = "black", size = 0.6),
      plot.title = element_text(face = "bold", size = 10, hjust = 0), # Mniejszy tytuł, żeby zmieścił się w siatce
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 10, face = "bold")
    )
  )
}

# ------------------------------------------------------------------------------
# 2. WYWOŁANIE ANALIZY
# ------------------------------------------------------------------------------

# --- 1. CAŁA KOHORTA ---
# title_suffix przetłumaczony na angielski
print(plot_km_survival(final_data, "hsa_mir_210_z", "- Whole Cohort"))
print(plot_km_survival(final_data, "hsa_mir_17_z",  "- Whole Cohort"))


# --- 2. WEWNĄTRZ PODTYPÓW (GRID 2x2) ---

# UWAGA: par(mfrow) nie działa z ggsurvplot. 
# Zamiast tego tworzymy listę wykresów i używamy arrange_ggsurvplots.

# === A. Analiza miR-210 ===
plot_list_210 <- list()
plot_list_210[[1]] <- plot_km_survival(lumA_data, "hsa_mir_210_z", "- Luminal A")
plot_list_210[[2]] <- plot_km_survival(lumB_data, "hsa_mir_210_z", "- Luminal B")
plot_list_210[[3]] <- plot_km_survival(basal_data, "hsa_mir_210_z", "- Basal-like")
plot_list_210[[4]] <- plot_km_survival(HER2_data, "hsa_mir_210_z", "- HER2")

# Wyświetlenie siatki 2x2 (zastępuje par(mfrow))
arrange_ggsurvplots(plot_list_210, print = TRUE, ncol = 2, nrow = 2, title = "miR-210 Survival by Subtype")


# === B. Analiza miR-17 ===
plot_list_17 <- list()
plot_list_17[[1]] <- plot_km_survival(lumA_data, "hsa_mir_17_z", "- Luminal A")
plot_list_17[[2]] <- plot_km_survival(lumB_data, "hsa_mir_17_z", "- Luminal B")
plot_list_17[[3]] <- plot_km_survival(basal_data, "hsa_mir_17_z", "- Basal-like")
plot_list_17[[4]] <- plot_km_survival(HER2_data, "hsa_mir_17_z", "- HER2")

# Wyświetlenie siatki 2x2
arrange_ggsurvplots(plot_list_17, print = TRUE, ncol = 2, nrow = 2, title = "miR-17 Survival by Subtype")

```





## Modele

```{r}
library(survival)
library(survminer)
library(broom)       # Do czyszczenia wyników modelu
library(kableExtra)  # Do ładnych tabel
library(dplyr)

# ==============================================================================
# 1. DEFINICJA MODELI (TWOJA LOGIKA - BEZ ZMIAN)
# ==============================================================================

# MODEL BAZOWY
cox_base <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + brca_subtype_pam50, 
                  data = final_data)

# MODEL C1 (Hipoksja: interakcja z miR-210)
cox_mir210 <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + 
                      brca_subtype_pam50 * hsa_mir_210_z, 
                    data = final_data)

# MODEL C2 (Proliferacja: interakcja z miR-17)
cox_mir17 <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + 
                     brca_subtype_pam50 * hsa_mir_17_z, 
                   data = final_data)

# ==============================================================================
# 2. GENEROWANIE TABELI ZBIORCZEJ (STANDARD ELSEVIER)
# ==============================================================================

format_cox_model <- function(model, model_name) {
  # Wyciągnięcie wyników (HR, CI, P-value)
  tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
    mutate(
      # Formatowanie HR (95% CI) do jednej kolumny
      `HR (95% CI)` = sprintf("%.2f (%.2f - %.2f)", estimate, conf.low, conf.high),
      # Formatowanie P-value (<0.001 lub dokładna wartość)
      `P-value` = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value)),
      Model = model_name
    ) %>%
    dplyr::select(Model, Term = term, `HR (95% CI)`, `P-value`)
}

# Łączenie wyników 3 modeli w jedną dużą tabelę
results_base <- format_cox_model(cox_base, "Base Model (Clinical)")
results_c1   <- format_cox_model(cox_mir210, "Model C1 (+ miR-210)")
results_c2   <- format_cox_model(cox_mir17, "Model C2 (+ miR-17)")

all_results <- bind_rows(results_base, results_c1, results_c2)

# Poprawa nazw zmiennych (Term) na ładny Angielski
# Uwaga: Nazwy muszą pasować do tego, co wypluwa Twój model (sprawdź levels)
all_results$Term <- gsub("age_mean_years", "Age (years)", all_results$Term)
all_results$Term <- gsub("pathologic_stage", "Pathologic Stage ", all_results$Term)
all_results$Term <- gsub("brca_subtype_pam50", "Subtype: ", all_results$Term)
all_results$Term <- gsub("hsa_mir_210_z", "miR-210 (Z-score)", all_results$Term)
all_results$Term <- gsub("hsa_mir_17_z", "miR-17 (Z-score)", all_results$Term)
all_results$Term <- gsub(":", " x ", all_results$Term) # Znak interakcji

# Generowanie tabeli HTML/LaTeX
kbl(all_results, caption = "Table 8. Multivariate Cox Proportional Hazards Regression Analysis.", booktabs = TRUE) %>%
  kable_classic(full_width = F, html_font = "Arial", font_size = 11) %>%
  collapse_rows(columns = 1, valign = "top") %>% # Grupowanie wg Modelu
  row_spec(0, bold = TRUE, background = "white", extra_css = "border-bottom: 2px solid black;")

# ==============================================================================
# 3. WIZUALIZACJA: FOREST PLOT (DLA MODELU BAZOWEGO I C1)
# ==============================================================================

# Funkcja rysująca Forest Plot
draw_forest <- function(model, title) {
  ggforest(model, data = final_data, 
           main = title, 
           cpositions = c(0.02, 0.22, 0.4), # Pozycje kolumn tekstowych
           fontsize = 0.8, 
           refLabel = "Ref", 
           noDigits = 2)
}

# Rysujemy Forest Plot dla Modelu C1 (najbardziej złożonego)
# To jest często Fig. 5 w artykule
p_forest <- draw_forest(cox_mir210, "Multivariate Cox Analysis: Model C1 (miR-210)")
print(p_forest)


p_forest2 <- draw_forest(cox_mir17, "Multivariate Cox Analysis: Model C2 (miR-17)")
print(p_forest2)
# Jeśli chcesz zapisać wykres:
# ggsave("Figure_Cox_Forest.pdf", p_forest, width = 8, height = 6)
```



```{r}

# ------------------------------------------------------------------------------
# 2. WIZUALIZACJA - FOREST PLOT
# ------------------------------------------------------------------------------
# Forest plot pokazuje HR (kropka) i przedział ufności (pozioma linia) dla każdej grupy.

# Funkcja pomocnicza do rysowania Forest Plot dla podtypów
# draw_forest_for_subtypes <- function(data, mirna_col, title) {
#   
#   # Budujemy model, w którym podtyp jest warstwą (strata) lub interakcją, 
#   # ale do ggforest najwygodniej podać model ogólny i pozwolić mu podzielić dane.
#   # UWAGA: ggforest w survminer działa najlepiej na ogólnym modelu, 
#   # ale my chcemy pokazać osobne HR dla podtypów.
#   
#   # Alternatywne podejście do wizualizacji w 'survminer' to podanie danych zgrupowanych:
#   fit_subtypes <- coxph(as.formula(paste("Surv(time_to_event, event) ~", mirna_col, "+ strata(brca_subtype_pam50)")), 
#                         data = data)
#   
#   # To jednak pokaże średni efekt. 
#   # Żeby zrobić ładny plot podgrup, użyjmy 'ggforest' na modelu z interakcją LUB
#   # zróbmy to sprytnym trikiem z pakietu forestmodel (jeśli masz) lub ręcznie.
#   
#   # Prostsza wersja (dla survminer):
#   # Generujemy osobne modele tylko do wykresu
#   res <- list()
#   subtypes <- unique(data$brca_subtype_pam50)
#   
#   # Pętla po podtypach
#   for(st in subtypes) {
#     sub_data <- subset(data, brca_subtype_pam50 == st)
#     # Prosty model dla podtypu (skorygowany o wiek)
#     m <- coxph(as.formula(paste("Surv(time_to_event, event) ~ age_mean_years +", mirna_col)), data = sub_data)
#     
#     # Wyciągamy HR i CI
#     summ <- summary(m)
#     res[[st]] <- data.frame(
#       Subtype = st,
#       HR = summ$conf.int[2,1],      # HR dla miRNA (2. wiersz, bo 1. to wiek)
#       Lower = summ$conf.int[2,3],
#       Upper = summ$conf.int[2,4],
#       P_val = summ$coefficients[2,5]
#     )
#   }
#   
#   res_df <- do.call(rbind, res)
#   
#   # Rysujemy
#   p <- ggplot(res_df, aes(x = HR, y = Subtype, xmin = Lower, xmax = Upper)) +
#     geom_point(shape = 15, size = 3, color = "darkblue") +
#     geom_errorbarh(height = 0.2) +
#     geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
#     labs(title = title, x = "Hazard Ratio (95% CI)", y = "") +
#     theme_minimal() +
#     geom_text(aes(label = paste0("HR=", round(HR, 2), ", p=", round(P_val, 3))), 
#               vjust = -1.5, size = 3.5)
#   
#   return(p)
# }
# 
# # Rysujemy wykresy
# p1 <- draw_forest_for_subtypes(final_data, "hsa_mir_17_z", "Wpływ miR-17 na przeżycie w podtypach")
# p2 <- draw_forest_for_subtypes(final_data, "hsa_mir_210_z", "Wpływ miR-210 na przeżycie w podtypach")
# 
# print(p1)
# print(p2)
```



## Model Sygnatury miRNA (LASSO Cox) – "Super-Biomarker"

```{r}
if (!require("glmnet", quietly = TRUE)) install.packages("glmnet")
library(glmnet)
library(survival)
library(survminer)
library(dplyr)
library(kableExtra)
library(broom)

# ------------------------------------------------------------------------------
# KROK 1 & 2: Przygotowanie Danych i Split (LOGIKA BEZ ZMIAN)
# ------------------------------------------------------------------------------

# Formatowanie czasu
final_data$time_to_event <- as.numeric(final_data$time_to_event)
final_data$event <- as.numeric(final_data$event)
valid_mirna <- mirna_markers

data_model <- final_data %>%
  dplyr::select(time_to_event, event, all_of(valid_mirna)) %>%
  filter(!is.na(time_to_event) & time_to_event > 0 & !is.na(event)) %>%
  na.omit()

cat("Total Patients:", nrow(data_model), "\n")

# Podział na Zbiór Treningowy i Testowy
set.seed(123) 
train_index <- sample(1:nrow(data_model), size = 0.7 * nrow(data_model))

data_train <- data_model[train_index, ] 
data_test  <- data_model[-train_index, ] 

cat("Training Set:", nrow(data_train), "\n")
cat("Test Set:", nrow(data_test), "\n")

# ------------------------------------------------------------------------------
# KROK 3: Trening Modelu LASSO (Zbiór Treningowy)
# ------------------------------------------------------------------------------
x_train <- as.matrix(data_train[, valid_mirna])
y_train <- Surv(data_train$time_to_event, data_train$event)

cv_fit <- cv.glmnet(x_train, y_train, family = "cox", alpha = 1)

# --- WYKRES 1: LASSO Cross-Validation (Elsevier Style) ---
# Ustawienia dla Base R plot, żeby wyglądał profesjonalnie
par(mfrow = c(1, 1), mar = c(4, 4, 3, 1), family = "sans", las = 1)

plot(cv_fit)
title("LASSO Coefficient Profiles (Training Set)", line = 2.5, font.main = 1)
mtext("Figure S2. Selection of optimal penalization parameter (Lambda).", side = 1, line = 4, cex = 0.8)

# Najlepsza lambda
best_lambda <- cv_fit$lambda.min
cat("Optimal Lambda:", best_lambda, "\n")

# ------------------------------------------------------------------------------
# KROK 4: Ekstrakcja Sygnatury (Formatowanie Tabeli)
# ------------------------------------------------------------------------------
coefs <- coef(cv_fit, s = "lambda.min")
active_index <- which(coefs != 0)
active_coefficients <- coefs[active_index]
active_names <- rownames(coefs)[active_index]

# Tworzenie ramki danych
signature_table <- data.frame(
  miRNA = active_names,
  Coefficient = active_coefficients # Zmieniono nazwę na angielską
)

# Wyświetlenie profesjonalnej tabeli
if(nrow(signature_table) > 0) {
  signature_table %>%
    mutate(Coefficient = round(Coefficient, 4)) %>%
    arrange(desc(abs(Coefficient))) %>% # Sortowanie wg siły wpływu
    kbl(caption = "Table 9. Final miRNA Signature Derived from LASSO Cox Regression.", booktabs = TRUE) %>%
    kable_classic(full_width = F, html_font = "Arial") %>%
    row_spec(0, bold = TRUE, color = "black", background = "white", extra_css = "border-bottom: 2px solid black;") %>%
    print()
} else {
  warning("LASSO reduced all coefficients to zero. Check lambda or data.")
}

# ------------------------------------------------------------------------------
# KROK 5: Walidacja na zbiorze TESTOWYM (LOGIKA BEZ ZMIAN)
# ------------------------------------------------------------------------------
x_test <- as.matrix(data_test[, valid_mirna])

# Risk Score
risk_scores_test <- predict(cv_fit, newx = x_test, s = "lambda.min", type = "link")
data_test$RiskScore <- as.vector(risk_scores_test)

# Cutoff (z treningu)
train_risk_scores <- predict(cv_fit, newx = x_train, s = "lambda.min", type = "link")
cutoff_value <- median(train_risk_scores)

# Klasyfikacja
data_test$RiskGroup <- ifelse(data_test$RiskScore > cutoff_value, "High Risk", "Low Risk")

# ------------------------------------------------------------------------------
# KROK 6: Wykres Kaplana-Meiera (Elsevier Style)
# ------------------------------------------------------------------------------
fit_km_test <- survfit(Surv(time_to_event, event) ~ RiskGroup, data = data_test)

p_val_plot <- ggsurvplot(
  fit_km_test,
  data = data_test,
  
  # Statystyka
  pval = TRUE,
  pval.method = TRUE,      # Dodaje informację "Log-rank"
  conf.int = TRUE,
  conf.int.alpha = 0.1,
  
  # Tabela ryzyka
  risk.table = TRUE,
  risk.table.col = "strata",
  risk.table.height = 0.25,
  fontsize = 4,
  
  # Kolory i Styl
  palette = c("#E41A1C", "#377EB8"), # High Risk = Red, Low Risk = Blue
  ggtheme = theme_bw() + theme(
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(color = "black"),
    plot.title = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold")
  ),
  
  # Język Angielski
  title = "Validation of miRNA Signature (Test Set)",
  subtitle = paste0("N = ", nrow(data_test), " (30% Split)"),
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.labs = c("High Risk", "Low Risk"),
  legend.title = "Prediction"
)

print(p_val_plot)

# ------------------------------------------------------------------------------
# KROK 7: Wynik Coxa i C-index (Tabela)
# ------------------------------------------------------------------------------
cox_test <- coxph(Surv(time_to_event, event) ~ RiskGroup, data = data_test)
c_index <- summary(cox_test)$concordance["C"]

# Formatowanie wyniku Coxa do tabeli
tidy(cox_test, exponentiate = TRUE, conf.int = TRUE) %>%
  mutate(
    `HR (95% CI)` = sprintf("%.2f (%.2f - %.2f)", estimate, conf.low, conf.high),
    `P-value` = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value)),
    `C-index` = sprintf("%.3f", c_index) # Dodajemy C-index do tabeli
  ) %>%
  dplyr::select(Term = term, `HR (95% CI)`, `P-value`, `C-index`) %>%
  mutate(Term = gsub("RiskGroupLow Risk", "Low Risk (vs High)", Term)) %>% # Poprawa nazwy
  kbl(caption = "Table 10. Validation Statistics on Test Set.", booktabs = TRUE) %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  print()
```


W celu weryfikacji zdolności generalizacji modelu, kohortę podzielono losowo na zbiór treningowy (70%) i testowy (30%). Algorytm LASSO Cox na zbiorze treningowym wyłonił sygnaturę złożoną z 15 cząsteczek miRNA (Tabela X).

Walidacja na niezależnym zbiorze testowym (n = 235) wykazała umiarkowaną zdolność dyskryminacyjną modelu, osiągając **C-index na poziomie 0.607**. Analiza przeżycia wykazała, że pacjenci z grupy wysokiego ryzyka (High Risk) mieli o 45% wyższe ryzyko zgonu w porównaniu do grupy niskiego ryzyka (**HR = 1.46**, 95% CI: 0.30–1.59). Różnica ta nie osiągnęła jednak poziomu istotności statystycznej (**p = 0.38**, Log-rank test), co należy interpretować w kontekście niskiej liczby zdarzeń w zbiorze testowym (22 zgony, 9.3% kohorty).

Brak istotności statystycznej w walidacji zewnętrznej (p=0.38) najprawdopodobniej wynika z ograniczonej mocy statystycznej spowodowanej niską liczbą punktów końcowych (events). W zbiorze walidacyjnym odnotowano jedynie 22 zgony na 235 pacjentów. Przy tak niskim odsetku zdarzeń, wykrycie istotnych różnic wymagałoby bardzo silnego efektu biologicznego lub znacznie liczniejszej grupy badawczej.

Mimo braku istotności p-value, parametr C-index (0.607) w walidacji wskazuje, że sygnatura zachowuje potencjał prognostyczny na nieznanych danych. Jest to wynik spójny z wieloma innymi sygnaturami wielogenowymi w raku piersi, gdzie wartości C-index w zewnętrznych walidacjach często oscylują w granicach 0.60–0.65.

















```{r}
############# Etap 4 Piotr
```

# Analiza Przeżycia (Survival Analysis)

## Metodologia

W celu oceny wartości prognostycznej wybranych markerów molekularnych
przeprowadzono analizę przeżycia całkowitego (Overall Survival, OS).
Czas przeżycia (`time_to_event`) zdefiniowano jako okres od diagnozy do
zgonu lub ostatniej obserwacji (cenzurowanie).

Analizę podzielono na dwa etapy:

1.  **Analiza jednoczynnikowa (Kaplan-Meier):** Zmienne ciągłe (poziomy
    ekspresji genów/białek) zdychotomizowano w oparciu o medianę,
    wyodrębniając grupy "High" oraz "Low". Różnice w krzywych przeżycia
    weryfikowano testem log-rank.

2.  **Analiza wieloczynnikowa (Regresja Coxa):** Zbudowano modele
    proporcjonalnego hazardu Coxa, aby ocenić niezależny wpływ markerów
    po skorygowaniu o czynniki kliniczne (wiek, stadium zaawansowania)
    oraz podtyp molekularny.

Analizie poddano trzy kluczowe markery o potencjalnym znaczeniu
klinicznym:

-   **MKI67** (Marker proliferacji) – w całej kohorcie.

-   **ESR1** (Receptor estrogenowy) – wewnątrz podtypu Luminal B
    (weryfikacja efektu ochronnego).

-   **EGFR** (Receptor naskórkowego czynnika wzrostu) – wewnątrz podtypu
    Basal-like (marker agresji).

```{r}
# Przygotowanie zmiennych (Dychotomizacja względem mediany)

# Funkcja pomocnicza do kategoryzacji (High/Low)
categorize_marker <- function(x) {
  ifelse(x > median(x, na.rm = TRUE), "High", "Low")
}

# Tworzenie grup dla kluczowych markerów

final_data <- final_data %>%
  mutate(
    MKI67_Group = factor(categorize_marker(mki67), levels = c("Low", "High")),
    ESR1_Group  = factor(categorize_marker(esr1), levels = c("Low", "High")),
    EGFR_Group  = factor(categorize_marker(egfr_rna), levels = c("Low", "High"))
  )

# Sprawdzenie liczebności grup (dla pewności, że podział jest równy)
# table(final_data$MKI67_Group)

```

## Wizualizacja krzywych przeżycia (Kaplan-Meier)

### Wpływ proliferacji (MKI67) na rokowanie ogólne

Marker Ki-67 (gen *MKI67*) jest uznanym wskaźnikiem proliferacji
komórkowej. Zweryfikowano hipotezę, że wysoka ekspresja tego genu
koreluje ze skróconym czasem przeżycia w całej badanej populacji.

```{r}
library(survival)
library(survminer)

# --- 1. OBLICZENIA (LOGIKA BEZ ZMIAN) ---
fit_mki67 <- survfit(Surv(time_to_event, event) ~ MKI67_Group, data = final_data)

# --- 2. WIZUALIZACJA (STANDARD ELSEVIER) ---
ggsurvplot(
  fit_mki67, 
  data = final_data,
  
  # Statystyka
  pval = TRUE,
  pval.method = TRUE,      # Dodaje "Log-rank" przed wartością p
  conf.int = TRUE,
  conf.int.alpha = 0.1,    # Delikatne zacieniowanie
  
  # Tabela ryzyka
  risk.table = TRUE,
  risk.table.col = "strata",
  risk.table.height = 0.25,
  fontsize = 4,            # Wielkość czcionki w tabeli
  
  # Kolory i Styl
  # Używamy spójnej palety z poprzednimi wykresami (Niebieski = Low, Czerwony = High)
  # Uwaga: Sprawdź kolejność w legend.labs, zazwyczaj R sortuje alfabetycznie (High, Low)
  # Jeśli Low jest pierwsze w danych, użyj: c("#377EB8", "#E41A1C")
  palette = c("#377EB8", "#E41A1C"), 
  
  # Język Angielski i Etykiety
  title = "Overall Survival by MKI67 Expression",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.title = "MKI67 Status",
  legend.labs = c("Low", "High"), # Upewnij się, że kolejność pasuje do poziomów czynnika
  
  # Temat Graficzny (Elsevier)
  ggtheme = theme_bw() + theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),       # Usunięcie ramki dookoła
    axis.line = element_line(color = "black", size = 0.6), # Tylko osie L
    plot.title = element_text(face = "bold", size = 12, hjust = 0),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 11, face = "bold")
  )
)
```

### Analiza wewnątrzpodtypowa

**1. Rola ESR1 w podtypie Luminal B** Podtyp Luminal B charakteryzuje
się gorszym rokowaniem niż Luminal A, mimo ekspresji receptorów
hormonalnych. Zbadano, czy wyższa ekspresja genu *ESR1* wewnątrz tej
grupy nadal pełni funkcję ochronną.

```{r}
library(survival)
library(survminer)
library(dplyr)

# --- 1. PRZYGOTOWANIE DANYCH (LOGIKA BEZ ZMIAN) ---
data_lumb <- final_data %>% 
  filter(brca_subtype_pam50 == "LumB")

fit_esr1 <- survfit(Surv(time_to_event, event) ~ ESR1_Group, data = data_lumb)

# --- 2. WIZUALIZACJA (STANDARD ELSEVIER) ---
ggsurvplot(
  fit_esr1, 
  data = data_lumb,
  
  # Statystyka
  pval = TRUE,
  pval.method = TRUE,      # Dodaje informację "Log-rank"
  conf.int = TRUE,         # Przedziały ufności (Standard naukowy)
  conf.int.alpha = 0.1,    # Delikatne zacieniowanie
  
  # Tabela ryzyka
  risk.table = TRUE,
  risk.table.col = "strata",
  risk.table.height = 0.25,
  fontsize = 4,
  
  # Kolory
  # Używamy "gray40" (ciemnoszary) zamiast "grey", aby był widoczny w druku
  # Uwaga: R sortuje grupy alfabetycznie: 1=HIGH, 2=LOW.
  # Jeśli chcesz HIGH=Szary, LOW=Czerwony, kolejność jest OK.
  palette = c("#377EB8", "#E41A1C"), 
  
  # Język Angielski
  title = "Survival Analysis: Luminal B Subtype (ESR1 Status)",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.title = "ESR1 Expression",
  legend.labs = c("High", "Low"), # Upewnij się, że pasuje do Twoich danych
  
  # Temat Graficzny (Czysty, Elsevier)
  ggtheme = theme_bw() + theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(color = "black", size = 0.6),
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 11, face = "bold")
  )
)
```

**2. Rola EGFR w podtypie Basal-like** Podtyp podstawny
(Basal-like/TNBC) często wykazuje nadekspresję *EGFR*. Sprawdzono, czy
poziom tego markera różnicuje pacjentki pod kątem przeżycia wewnątrz tej
agresywnej grupy.

```{r}

# --- 1. PRZYGOTOWANIE DANYCH (LOGIKA BEZ ZMIAN) ---
data_basal <- final_data %>% 
  filter(brca_subtype_pam50 == "Basal")

fit_egfr <- survfit(Surv(time_to_event, event) ~ EGFR_Group, data = data_basal)

# --- 2. WIZUALIZACJA (STANDARD ELSEVIER) ---
ggsurvplot(
  fit_egfr, 
  data = data_basal,
  
  # Statystyka
  pval = TRUE,
  pval.method = TRUE,      # Dodaje "Log-rank" przed wartością p
  conf.int = TRUE,         # Przedziały ufności (Standard Elsevier)
  conf.int.alpha = 0.1,    # Delikatne cieniowanie
  
  # Tabela ryzyka
  risk.table = TRUE,
  risk.table.col = "strata",
  risk.table.height = 0.25,
  fontsize = 4,
  
  # Kolory
  # Zmieniono na profesjonalne odpowiedniki (High = Fiolet, Low = Szary - lub odwrotnie zależnie od sortowania)
  # R domyślnie sortuje alfabetycznie: 1="High", 2="Low".
  # Dlatego: High = Fioletowy (#984EA3), Low = Ciemnoszary (gray40)
  palette = c("#377EB8", "#E41A1C"), 
  
  # Język Angielski
  title = "Survival Analysis: Basal-like Subtype (EGFR Status)",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.title = "EGFR Expression",
  legend.labs = c("High", "Low"), # Upewnij się, że pasuje do Twoich danych
  
  # Temat Graficzny (Czysty)
  ggtheme = theme_bw() + theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),       # Usunięcie ramki dookoła
    axis.line = element_line(color = "black", size = 0.6), # Tylko osie L
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 11, face = "bold")
  )
)
```

## Wieloczynnikowa analiza ryzyka (Modele Coxa)

W celu potwierdzenia niezależnej wartości prognostycznej badanych
markerów, zbudowano serię modeli Coxa.

-   **Model Bazowy (Kliniczny):** Uwzględnia wiek, stadium nowotworu
    (Stage) oraz podtyp PAM50.

-   **Modele Testowe (B1, B2, B3):** Rozszerzone o badane markery
    genetyczne.

Wyniki przedstawiono w postaci współczynników hazardu (Hazard Ratio,
HR). Wartość HR \> 1 oznacza wzrost ryzyka zgonu, natomiast HR \< 1
świadczy o działaniu ochronnym.

```{r}

# --- 1. PRZYGOTOWANIE DANYCH (LOGIKA BEZ ZMIAN) ---
cox_data <- final_data %>%
  filter(!is.na(pathologic_stage), !is.na(age_mean_years)) %>%
  mutate(pathologic_stage = as.factor(pathologic_stage))

# --- 2. DEFINICJA MODELI (LOGIKA BEZ ZMIAN) ---

# 1. Model Bazowy
cox_base <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + brca_subtype_pam50, 
                  data = cox_data)

# 2. Model B1: Baza + MKI67
cox_mki67_model <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + brca_subtype_pam50 + mki67, 
                         data = cox_data)

# 3. Model B2: Baza + ESR1
cox_esr1_model <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + brca_subtype_pam50 + esr1, 
                        data = cox_data)

# 4. Model B3: Baza + EGFR
cox_egfr_model <- coxph(Surv(time_to_event, event) ~ age_mean_years + pathologic_stage + brca_subtype_pam50 + egfr_rna, 
                        data = cox_data)

# ==============================================================================
# 3. TABELA ZBIORCZA (STANDARD ELSEVIER)
# ==============================================================================

format_cox_model_elsevier <- function(model, model_name) {
  tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
    mutate(
      # Formatowanie HR (95% CI) w jednej kolumnie
      `HR (95% CI)` = sprintf("%.2f (%.2f - %.2f)", estimate, conf.low, conf.high),
      # Formatowanie P-value
      `P-value` = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value)),
      Model = model_name
    ) %>%
    dplyr::select(Model, Term = term, `HR (95% CI)`, `P-value`)
}

# Łączenie wyników
res_base  <- format_cox_model_elsevier(cox_base, "Base Model")
res_mki67 <- format_cox_model_elsevier(cox_mki67_model, "Model B1 (+ MKI67)")
res_esr1  <- format_cox_model_elsevier(cox_esr1_model,  "Model B2 (+ ESR1)")
res_egfr  <- format_cox_model_elsevier(cox_egfr_model,  "Model B3 (+ EGFR)")

all_results_clin <- bind_rows(res_base, res_mki67, res_esr1, res_egfr)

# Czyszczenie nazw zmiennych na ładny angielski
all_results_clin$Term <- all_results_clin$Term %>%
  str_replace_all("age_mean_years", "Age (years)") %>%
  str_replace_all("pathologic_stage", "Stage: ") %>%
  str_replace_all("brca_subtype_pam50", "Subtype: ") %>%
  str_replace_all("mki67", "MKI67 (Proliferation)") %>%
  str_replace_all("esr1", "ESR1 (Estrogen Receptor)") %>%
  str_replace_all("egfr_rna", "EGFR (mRNA)")

# Generowanie tabeli
kbl(all_results_clin, 
    caption = "Table 11. Multivariate Cox Regression Analysis for Clinical Markers.", 
    booktabs = TRUE) %>%
  kable_classic(full_width = F, html_font = "Arial", font_size = 11) %>%
  collapse_rows(columns = 1, valign = "top") %>% # Grupowanie wierszy wg modelu
  row_spec(0, bold = TRUE, background = "white", extra_css = "border-bottom: 2px solid black;") %>%
  print()


# ==============================================================================
# 4. WIZUALIZACJA: FOREST PLOTS
# ==============================================================================

# Funkcja rysująca (taka sama jak przy miRNA)
draw_forest <- function(model, title) {
  ggforest(model, data = cox_data, 
           main = title, 
           cpositions = c(0.02, 0.22, 0.4), 
           fontsize = 0.8, 
           refLabel = "Ref", 
           noDigits = 2)
}

# Wykres dla modelu B1 (MKI67)
p_forest_mki67 <- draw_forest(cox_mki67_model, "Multivariate Analysis: MKI67 Impact")
print(p_forest_mki67)

# Wykres dla modelu B2 (ESR1)
p_forest_esr1 <- draw_forest(cox_esr1_model, "Multivariate Analysis: ESR1 Impact")
print(p_forest_esr1)

# Wykres dla modelu B3 (EGFR)
p_forest_egfr <- draw_forest(cox_egfr_model, "Multivariate Analysis: EGFR Impact")
print(p_forest_egfr)
```

### Wyniki modelowania statystycznego

Tabela przedstawia wyniki dla modelu bazowego, który stanowi punkt
odniesienia dla dalszych analiz. Stadium zaawansowania (Stage) oraz wiek
pacjentki są silnymi predyktorami przeżycia.


### Interpretacja wyników Modelu Bazowego (Analiza wieloczynnikowa)

Model referencyjny potwierdza, że w badanej kohorcie klasyczne zmienne
kliniczno-patologiczne stanowią najsilniejsze determinanty czasu
przeżycia całkowitego (OS), dominując nad stratyfikacją molekularną.

1.  **Zmienne demograficzne (Wiek):** Zaobserwowano wysoce istotną
    statystycznie korelację wieku z ryzykiem zgonu (**HR = 1.050**, p \<
    0.001). Każdy rok życia zwiększa ryzyko względne o 5%, co
    odzwierciedla naturalną biologię starzenia oraz potencjalne
    obciążenia chorobami współistniejącymi, typowe dla populacji
    onkologicznej.

2.  **Stadium zaawansowania (Stage):** Wyniki potwierdzają hierarchiczną
    strukturę ryzyka zgodną z klasyfikacją TNM. W porównaniu do grupy
    referencyjnej (Stadium I):

    -   **Stadium II** podwaja ryzyko zgonu (**HR = 2.02**, p = 0.034).

    -   **Stadium III** zwiększa to ryzyko niemal czterokrotnie (**HR =
        3.96**, p \< 0.001). Zachowanie efektu "dawka-odpowiedź" (wzrost
        HR wraz ze stopniem zaawansowania) stanowi wewnętrzną walidację
        poprawności danych klinicznych w zbiorze.

3.  **Podtypy molekularne (PAM50):** W modelu skorygowanym o wiek i
    stadium, status molekularny guza nie wykazał niezależnej istotności
    statystycznej (p \> 0.05 dla wszystkich podtypów względem
    referencji, którą stanowił podtyp Basal-like).

    -   Mimo braku istotności, **trend dla podtypu Luminal A (HR =
        0.721)** wskazuje na jego biologicznie łagodniejszy charakter
        (redukcja ryzyka o \~28% względem agresywnego podtypu
        bazalnego), co jest zgodne z kanonem literaturowym (*Perou et
        al.*).

    -   Brak statystycznej znamienności sugeruje, że w analizowanej
        kohorcie silny wpływ zaawansowania choroby (Stage III) "maskuje"
        subtelniejsze różnice wynikające z biologii molekularnej guza.

Tabela weryfikuje, czy marker proliferacji *MKI67* wnosi istotną
informację prognostyczną po uwzględnieniu podtypu molekularnego.



### Interpretacja wyników wieloczynnikowej analizy Coxa (Model B1)

Analiza wykazała, że w badanym modelu dominującą rolę prognostyczną
odgrywają zmienne kliniczne, podczas gdy wpływ markerów molekularnych
jest modyfikowany przez interakcje międzyzmienne.

1.  **Zmienne kliniczne (Wiek i Stadium):** Potwierdzono, że **wiek**
    (HR=1.049, p\<0.001) oraz **stadium zaawansowania** są silnymi,
    niezależnymi czynnikami negatywnego rokowan. Wzrost ryzyka zgonu
    wraz z zaawansowaniem choroby (HR=2.04 dla Stadium II i HR=3.99 dla
    Stadium III) jest zgodny z systemem klasyfikacji TNM i odzwierciedla
    większą masę guza oraz potencjał przerzutowy w wyższych stadiach.

2.  **Podtypy molekularne (Subtype):** Po uwzględnieniu w modelu
    zmiennej *MKI67*, status podtypu utracił niezależną istotność
    statystyczną (p\>0.05). Trend dla podtypu **Luminal A** (HR=0.576)
    wskazuje na jego ochronny charakter względem grupy referencyjnej, co
    jest zgodne z literaturą definiującą ten podtyp jako biologicznie
    najmniej agresywny (*Perou et al.*), jednak brak istotności
    sugeruje, że część informacji prognostycznej została przejęta przez
    inne zmienne w modelu.

3.  **Marker proliferacji (MKI67):** Brak istotności statystycznej genu
    *MKI67* (p=0.249) oraz trend w kierunku HR \< 1 (0.896) w modelu
    wieloczynnikowym można wytłumaczyć dwoma zjawiskami biologicznymi:

    -   **Współliniowość (Multicollinearity):** Gen *MKI67* jest
        składową sygnatury definiującej podtypy PAM50 (szczególnie
        różnicując LumA od LumB). Wprowadzenie obu zmiennych do jednego
        modelu powoduje zniesienie ich indywidualnej wagi
        prognostycznej.

    -   **Paradoks chemiowrażliwości:** W literaturze (*Fasching et
        al.*) opisuje się zjawisko, w którym guzy o wysokiej
        proliferacji (wysokie Ki-67) lepiej odpowiadają na chemioterapię
        adiuwantową niż guzy wolnorosnące. W efekcie leczenie może
        niwelować naturalnie gorsze rokowanie biologiczne tych
        nowotworów, co w analizie przeżycia całkowitego (OS) objawia się
        brakiem istotnego wzrostu ryzyka.

Tabela oraz przedstawiają wyniki dla receptorów *ESR1* oraz
*EGFR*.



### Interpretacja wyników Modelu B2 (+ ESR1)

Włączenie ekspresji genu *ESR1* do modelu wieloczynnikowego nie wykazało
jego niezależnej wartości prognostycznej, potwierdzając dominującą rolę
czynników klinicznych oraz strukturę definicyjną podtypów molekularnych.

1.  **Stabilność zmiennych klinicznych:** Wiek (**HR = 1.050**, p \<
    0.001) oraz stadium zaawansowania (szczególnie Stage III: **HR =
    3.94**, p \< 0.001) pozostają stabilnymi, najsilniejszymi
    predyktorami ryzyka zgonu, niezależnie od dodania zmiennej *ESR1*.

2.  **Marker *ESR1* i redundancja biologiczna:** Ekspresja *ESR1* nie
    osiągnęła istotności statystycznej (**p = 0.692**), a jej
    współczynnik hazardu (**HR = 0.969**) sugeruje jedynie nieznaczny
    trend ochronny. Brak istotności wynika ze zjawiska współliniowości:
    wysoka ekspresja *ESR1* jest cechą definicyjną podtypów Luminal A
    i B. Informacja o statusie receptorowym jest zatem duplikowana przez
    zmienną "Subtype", co znosi statystyczną wagę samego markera w
    modelu wieloczynnikowym.

### Interpretacja wyników Modelu B3 (+ EGFR)

Analiza modelu z uwzględnieniem *EGFR* wskazuje na ograniczoną
użyteczność tego markera jako niezależnego czynnika prognostycznego w
obecności zmiennych definiujących podtyp molekularny.

1.  **Dominacja czynników klinicznych:** Podobnie jak w poprzednich
    modelach, zaawansowanie choroby (Stage III: **HR = 3.95**, p \<
    0.001) oraz wiek pacjentki (**HR = 1.051**, p \< 0.001) stanowią
    główne determinanty przeżycia całkowitego.

2.  **Marker *EGFR*:** Gen *EGFR* nie wykazał istotnego wpływu na
    rokowanie (**p = 0.421**). Zaobserwowany kierunek zmiany (**HR =
    1.061**) wskazuje na trend w stronę zwiększonego ryzyka, co jest
    zgodne z biologiczną rolą EGFR jako promotora agresywności i
    proliferacji (szczególnie w podtypie Basal-like). Brak niezależnej
    istotności statystycznej sugeruje jednak, że negatywny wpływ
    nadekspresji EGFR jest już wystarczająco reprezentowany w modelu
    przez przynależność do podtypu molekularnego (głównie Basal/TNBC)
    oraz wysokie stadium zaawansowania.

## Podsumowanie wyników analizy przeżycia

Na podstawie przeprowadzonych analiz (testów Log-Rank oraz
wieloczynnikowej regresji Coxa) sformułowano następujące wnioski:

1.  **Dominacja czynników klinicznych nad molekularnymi:** We wszystkich
    zbudowanych modelach (Bazowym, B1, B2, B3) najsilniejszymi i
    najbardziej stabilnymi predyktorami przeżycia całkowitego (OS)
    okazały się **wiek pacjentki** oraz **stadium zaawansowania
    nowotworu** (Stage). Ryzyko zgonu wzrastało niemal czterokrotnie dla
    Stadium III (HR ≈ 4.0, p \< 0.001), co potwierdza, że w badanej
    kohorcie masa guza i obecność przerzutów mają większe znaczenie
    prognostyczne niż profil ekspresji pojedynczych genów.

2.  **Marker proliferacji (MKI67) i współliniowość:** W modelu
    wieloczynnikowym (Tabela 4.2) gen *MKI67* utracił niezależną
    istotność statystyczną (p = 0.249), wykazując trend w kierunku HR \<
    1 (0.896). Sugeruje to, że informacja o agresywności guza wynikająca
    z wysokiej proliferacji jest już zawarta w zmiennej definiującej
    podtyp molekularny (szczególnie w podtypach Luminal B i Basal-like).
    Brak negatywnego wpływu wysokiego *MKI67* na przeżycie w modelu
    skorygowanym może również odzwierciedlać wyższą wrażliwość guzów
    szybko dzielących się na leczenie systemowe (zjawisko
    chemiowrażliwości).

3.  **Brak niezależnej wartości markerów ESR1 i EGFR:** Włączenie do
    modelu genów *ESR1* (Tabela 4.3) oraz *EGFR* (Tabela 4.4) nie
    poprawiło jego zdolności predykcyjnej. Oba markery nie wykazały
    istotności statystycznej jako niezależne czynniki ryzyka. Wynika to
    z faktu, że ich poziomy ekspresji są cechami definicyjnymi samych
    podtypów PAM50 (wysoki *ESR1* definiuje nowotwory luminalne, wysoki
    *EGFR* jest charakterystyczny dla Basal-like). W konsekwencji, w
    modelu uwzględniającym podział na podtypy, dodanie tych markerów
    prowadzi do redundancji informacyjnej.

4.  **Wnioski końcowe:** Analiza potwierdza, że stratyfikacja
    molekularna PAM50 skutecznie grupuje pacjentki o odmiennej biologii,
    jednak w kontekście prognozowania przeżycia całkowitego (OS), to
    klasyczne parametry kliniczno-patologiczne (wiek, stadium TNM)
    pozostają nadrzędnymi determinantami rokowania. Pojedyncze markery
    (*MKI67, ESR1, EGFR*) nie stanowią w tym układzie niezależnych
    czynników ryzyka, lecz są biologicznie sprzężone z przypisanym
    podtypem nowotworu.
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































# TESTY SPRAWDZAJĄCE POPRAWNOSC DANYCH

```{r}
# Szybki test biologiczny
# library(ggplot2)
# 
# # Test 1: Czy Luminal A ma wysoki estrogen?
# ggplot(final_data, aes(x = brca_subtype_pam50, y = esr1, fill = brca_subtype_pam50)) +
#   geom_boxplot() +
#   labs(title = "TEST 1: Czy ESR1 (Gen) pasuje do podtypów?", subtitle = "Oczekiwanie: Luminal A/B wysoko, Basal nisko") +
#   theme_minimal()
# 
# # Test 2: Czy HER2 ma wysoki HER2?
# ggplot(final_data, aes(x = brca_subtype_pam50, y = erbb2, fill = brca_subtype_pam50)) +
#   geom_boxplot() +
#   labs(title = "TEST 2: Czy ERBB2 (Gen) pasuje do podtypów?", subtitle = "Oczekiwanie: HER2-enriched najwyżej") +
#   theme_minimal()
```


```{r}
# TEST 4: Czy stadium zaawansowania (Stage) działa zgodnie z medycyną?
# library(survival)
# library(survminer)
# library(dplyr)
# 
# # 1. Przygotowanie kolejności stadiów (żeby na legendzie było po kolei)
# # Zakładam, że w danych masz "Stage_I", "Stage_II" itd. lub "I", "II".
# # Sprawdź unique(final_data$pathologic_stage) i dostosuj poziomy!
# 
# # Przykład dla formatu z Twojego pliku ("Stage_I", "Stage_II"...)
# final_data$Stage_Factor <- factor(final_data$pathologic_stage, 
#                                   levels = c("I", "II", "III"))
# 
# # Usuwamy "Unknown" do tego wykresu
# data_stage <- final_data %>% filter(!is.na(Stage_Factor))
# 
# # 2. Wykres KM
# fit_stage <- survfit(Surv(time_to_event, event) ~ Stage_Factor, data = data_stage)
# 
# ggsurvplot(fit_stage, data = data_stage,
#            title = "TEST 4: Czy wyższe stadium = szybszy zgon?",
#            pval = TRUE,
#            risk.table = TRUE,
#            palette = "jco", # Ładna paleta kolorów
#            legend.title = "Stadium",
#            xlab = "Czas (Dni)"
# )
```


```{r}
# TEST 5: Czy wiek zgadza się z biologią?
# library(ggplot2)
# 
# ggplot(final_data, aes(x = brca_subtype_pam50, y = age_mean_years, fill = brca_subtype_pam50)) +
#   geom_boxplot() +
#   labs(title = "TEST 5: Rozkład wieku w podtypach", 
#        subtitle = "Oczekiwanie: Basal-like powinien mieć niższą medianę wieku niż Luminal",
#        y = "Wiek (Lata)", x = "Podtyp") +
#   theme_minimal()
```












